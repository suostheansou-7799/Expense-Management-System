<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#6366f1">
    <title>System Expenses Tracker</title>

    <!-- Redirect to login if not authenticated -->
    <script>
        // Quick check before page loads - redirect to login if not authenticated
        (function() {
            // This is a quick client-side check. Full auth check happens after Firebase loads.
            const isLoggedIn = localStorage.getItem('userLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'login.html';
            }
        })();
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
    <script>
        const userSelect = document.getElementById("userSelect");
        if (userSelect) {
            userSelect.onclick = function() {
                console.log("clicked");
            };
        }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="styles.css">


</head>

<body class="min-h-screen overflow-x-hidden selection:bg-indigo-300 selection:text-indigo-900" aria-label="Expenses App Background Static" tabindex="-1">

    <!-- Dark Mode Toggle Button -->
    <button id="dark-mode-toggle" class="dark-mode-toggle" title="Toggle Dark Mode">
        <i class="fas fa-moon"></i>
    </button>

    <!-- Floating Action Button (FAB) -->
    <div class="fab-container" id="fab-container">
        <button class="fab-main" id="fab-main" title="Quick Actions">
            <i class="fas fa-plus"></i>
        </button>
        <div class="fab-actions" id="fab-actions">
            <button class="fab-action expense" id="fab-expense" title="Add Expense">
                <i class="fas fa-minus"></i>
                <span>Add Expense</span>
            </button>
            <button class="fab-action income" id="fab-income" title="Add Income">
                <i class="fas fa-plus"></i>
                <span>Add Income</span>
            </button>
        </div>
    </div>

    <div id="app" class="max-w-7xl mx-auto px-4 py-4 md:p-8">
        <!-- Professional Desktop Header -->
        <header class="text-center mb-8 md:mb-12 relative z-10 hidden md:block">
            <div class="inline-flex items-center gap-4 mb-4">
                <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i class="fas fa-wallet text-2xl text-white"></i>
                </div>
                <div class="text-left">
                    <h1 class="text-3xl md:text-4xl font-bold text-white drop-shadow-md tracking-tight">Finance Dashboard</h1>
                    <p class="text-white/70 text-sm">Professional Expense Management System</p>
                </div>
            </div>
            <div id="user-status" class="mt-4 flex flex-col md:flex-row justify-center items-center space-y-2 md:space-y-0 md:space-x-4">
                <p class="text-white/90 font-medium bg-white/15 px-5 py-2 rounded-full backdrop-blur-sm border border-white/20 flex items-center gap-2" id="user-info">
                    <i class="fas fa-user-circle"></i> Loading authentication...
                </p>
                <button id="signout-btn" class="hidden text-sm bg-red-500/90 hover:bg-red-600 text-white px-5 py-2 rounded-full transition duration-300 shadow-lg backdrop-blur-sm border border-red-400/50 font-semibold">
                    <i class="fas fa-sign-out-alt mr-1"></i> Sign Out
                </button>
            </div>
        </header>

        <div id="message-container" class="fixed bottom-20 md:bottom-6 left-4 right-4 md:left-auto md:right-6 md:w-80 z-50 space-y-2"></div>

        <!-- Toast Container for Save Notifications -->
        <div id="toast-container" class="toast-container"></div>

        <div id="loading-screen" class="max-w-md mx-auto mt-10 p-8 glass-panel rounded-2xl shadow-2xl text-center">
            <div class="mb-6 inline-block p-5 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg shadow-indigo-500/30">
                <svg class="animate-spin h-10 w-10 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Loading Dashboard</h2>
            <p class="text-gray-500 mb-6 text-sm">Please wait while we sync your data...</p>
            <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                <div class="bg-gradient-to-r from-indigo-500 to-purple-600 h-1.5 rounded-full animate-pulse" style="width: 100%"></div>
            </div>
        </div>

        <div id="app-content" class="hidden">
            <!-- Mobile Header -->
            <div class="mobile-header md:hidden">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center shadow-md">
                            <i class="fas fa-wallet text-white"></i>
                        </div>
                        <h1 class="text-lg font-bold text-gray-800" id="mobile-page-title">Dashboard</h1>
                    </div>
                    <div id="mobile-user-info" class="text-xs bg-indigo-100 text-indigo-700 px-3 py-1.5 rounded-full font-medium"></div>
                </div>
            </div>

            <!-- Desktop Tab Navigation - Professional Style -->
            <div class="hidden md:block mb-8">
                <div class="flex glass-panel rounded-xl p-1.5 shadow-lg max-w-5xl mx-auto">
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="dashboard">
                        <i class="fas fa-home"></i> Overview
                    </button>
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="entry">
                        <i class="fas fa-plus-circle"></i> New Entry
                    </button>
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="income">
                        <i class="fas fa-hand-holding-dollar"></i> Add Income
                    </button>
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="history">
                        <i class="fas fa-clock-rotate-left"></i> History
                    </button>
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="report">
                        <i class="fas fa-chart-pie"></i> Analytics
                    </button>
                    <button class="tab-button flex-1 py-3 px-4 text-center rounded-lg text-sm font-semibold transition-all duration-300 flex items-center justify-center gap-2" data-tab="settings">
                        <i class="fas fa-gear"></i> Settings
                    </button>
                </div>
            </div>

            <!-- Global Search Bar -->
            <div class="global-search-container mb-6">
                <i class="fas fa-search global-search-icon"></i>
                <input type="text" id="global-search" class="global-search" placeholder="Search transactions...">
                <button class="global-search-clear" id="search-clear">
                    <i class="fas fa-times"></i>
                </button>
                <div class="search-results" id="search-results">
                    <div class="search-results-header">Recent Results</div>
                    <div id="search-results-list"></div>
                </div>
            </div>

            <!-- Dashboard Overview Tab -->
            <div id="dashboard-tab" class="tab-content hidden">
                <div class="dashboard-grid">
                    <!-- Welcome Card -->
                    <div class="col-8">
                        <div class="welcome-card">
                            <div class="greeting" id="greeting-text">Good Morning</div>
                            <div class="user-name" id="dashboard-user-name">User</div>
                            <div class="summary-text" id="dashboard-summary">
                                Welcome to your Finance Dashboard. Here's a quick overview of your finances.
                            </div>
                        </div>
                    </div>

                    <!-- Quick Balance Card -->
                    <div class="col-4">
                        <div class="glass-panel p-6 rounded-2xl h-full">
                            <div class="text-center">
                                <div class="text-sm text-gray-500 font-semibold mb-2">Current Balance</div>
                                <div class="text-3xl font-bold mb-4" id="dashboard-balance">$0</div>
                                <div class="flex justify-center gap-4">
                                    <div class="text-center">
                                        <div class="text-xs text-gray-400">Income</div>
                                        <div class="text-sm font-bold text-green-500" id="dashboard-total-income">+$0</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-xs text-gray-400">Expense</div>
                                        <div class="text-sm font-bold text-red-500" id="dashboard-total-expense">-$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Stats Cards -->
                    <div class="col-12">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="overview-card primary">
                                <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
                                <div class="card-label">Today's Spending</div>
                                <div class="card-value" id="dash-today-total">$0</div>
                            </div>
                            <div class="overview-card danger">
                                <div class="card-icon"><i class="fas fa-receipt"></i></div>
                                <div class="card-label">This Month</div>
                                <div class="card-value" id="dash-month-expense">$0</div>
                            </div>
                            <div class="overview-card success">
                                <div class="card-icon"><i class="fas fa-piggy-bank"></i></div>
                                <div class="card-label">Month Income</div>
                                <div class="card-value" id="dash-month-income">$0</div>
                            </div>
                            <div class="overview-card info">
                                <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                                <div class="card-label">Net This Month</div>
                                <div class="card-value" id="dash-net-balance">$0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Transactions -->
                    <div class="col-6">
                        <div class="recent-activity-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-arrow-down text-red-500"></i> Recent Expenses
                                </div>
                                <span class="view-all" onclick="switchTab('history')">View All</span>
                            </div>
                            <div id="dashboard-recent-expenses" class="space-y-3">
                                <div class="text-center text-gray-400 py-4">No recent expenses</div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Income -->
                    <div class="col-6">
                        <div class="recent-activity-card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-arrow-up text-green-500"></i> Recent Income
                                </div>
                                <span class="view-all" onclick="switchTab('history')">View All</span>
                            </div>
                            <div id="dashboard-recent-incomes" class="space-y-3">
                                <div class="text-center text-gray-400 py-4">No recent income</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="col-12">
                        <div class="glass-panel p-5 rounded-2xl">
                            <h3 class="text-lg font-bold text-gray-800 mb-4">Quick Actions</h3>
                            <div class="flex flex-wrap gap-3">
                                <button onclick="switchTab('entry')" class="btn-pro btn-primary flex items-center gap-2">
                                    <i class="fas fa-plus"></i> Add Expense
                                </button>
                                <button onclick="switchTab('income')" class="btn-pro btn-success flex items-center gap-2">
                                    <i class="fas fa-plus"></i> Add Income
                                </button>
                                <button onclick="switchTab('report')" class="btn-pro btn-secondary flex items-center gap-2">
                                    <i class="fas fa-chart-pie"></i> View Analytics
                                </button>
                                <button onclick="switchTab('history')" class="btn-pro btn-outline flex items-center gap-2">
                                    <i class="fas fa-clock-rotate-left"></i> View History
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="entry-tab" class="tab-content">
                <!-- Quick Stats Overview -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="overview-card primary fade-in">
                        <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
                        <div class="card-label">Today's Spending</div>
                        <div class="card-value" id="quick-today-total">$0</div>
                    </div>
                    <div class="overview-card danger fade-in" style="animation-delay: 0.1s">
                        <div class="card-icon"><i class="fas fa-receipt"></i></div>
                        <div class="card-label">This Month</div>
                        <div class="card-value" id="quick-month-expense">$0</div>
                    </div>
                    <div class="overview-card success fade-in" style="animation-delay: 0.2s">
                        <div class="card-icon"><i class="fas fa-piggy-bank"></i></div>
                        <div class="card-label">Month Income</div>
                        <div class="card-value" id="quick-month-income">$0</div>
                    </div>
                    <div class="overview-card info fade-in" style="animation-delay: 0.3s">
                        <div class="card-icon"><i class="fas fa-scale-balanced"></i></div>
                        <div class="card-label">Net Balance</div>
                        <div class="card-value" id="quick-net-balance">$0</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                    <div class="lg:col-span-1 glass-panel p-5 md:p-6 rounded-2xl h-auto lg:h-min lg:sticky lg:top-4 shadow-xl">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-5 flex items-center gap-3" id="form-title">
                            <span class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-plus text-indigo-600"></i>
                            </span> Add Expense
                        </h2>
                        <form id="expense-form" class="space-y-4 md:space-y-5">
                            <input type="hidden" id="expense-id">

                            <div class="flex flex-col md:flex-row md:space-x-3 space-y-4 md:space-y-0">
                                <div class="flex-1">
                                    <label for="amount" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Amount</label>
                                    <input type="number" step="0.01" id="amount" required class="glass-input block w-full rounded-xl font-semibold text-gray-800" inputmode="decimal">
                                </div>
                                <div class="md:w-32">
                                    <label for="currency" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Currency</label>
                                    <select id="currency" class="glass-input block w-full rounded-xl font-semibold text-gray-800 cursor-pointer">
                                        <option value="USD">USD ($)</option>
                                        <option value="KHR" selected>KHR (៛)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="date" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Date</label>
                                <input type="date" id="date" required class="glass-input block w-full rounded-xl text-gray-800">
                            </div>

                            <div>
                                <label for="category" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Category</label>
                                <input type="text" list="category-options" id="category" required placeholder="Select or type..." class="glass-input block w-full rounded-xl text-gray-800">
                                <datalist id="category-options"></datalist>
                            </div>

                            <div>
                                <label for="description" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">Description</label>
                                <input type="text" id="description" placeholder="Optional details..." class="glass-input block w-full rounded-xl text-gray-800">
                            </div>

                            <div id="user-selector-wrapper">
                                <!-- Add User Modal Popup -->
                                <div id="add-user-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 hidden">
                                    <div class="bg-white rounded-2xl shadow-xl p-6 w-80 max-w-full flex flex-col items-center">
                                        <h3 class="text-lg font-bold text-indigo-700 mb-2">Add New User</h3>
                                        <input id="add-user-input" type="text" class="glass-input w-full mb-3" placeholder="Enter user name..." maxlength="32" autocomplete="off" />
                                        <div class="flex gap-2 w-full">
                                            <button id="add-user-confirm" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700 transition">Add</button>
                                            <button id="add-user-cancel" class="flex-1 py-2 rounded-lg bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 transition">Cancel</button>
                                        </div>
                                        <div id="add-user-error" class="text-red-500 text-xs mt-2 h-4"></div>
                                    </div>
                                </div>
                                <label for="user" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-2">User</label>
                                <!-- Compact view: shows auto-selected user with change option -->
                                <div id="user-compact-view" class="user-selector-compact">
                                    <div class="user-display flex-1 flex items-center gap-2" id="user-display-name">
                                        <i class="fas fa-user text-indigo-500"></i>
                                        <span id="user-display-text">Select User...</span>
                                    </div>
                                    <button type="button" id="change-user-btn" class="change-user-btn px-3 py-1 rounded-lg bg-indigo-100 text-indigo-700 text-xs font-semibold hover:bg-indigo-200 transition">Change</button>
                                </div>
                                <!-- Full selector (hidden by default, shown when "Change" is clicked) -->
                                <div class="relative flex items-center">
                                    <select id="user" class="glass-input flex-1 rounded-xl text-gray-800 cursor-pointer user-selector-hidden min-w-0">
                                        <option value="" disabled selected>Select User...</option>
                                    </select>
                                </div>
                                <div class="flex justify-center mt-3 mb-1">
                                    <button type="button" id="add-user-btn" title="Add User" class="add-user-fab-long group w-full max-w-[320px] h-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 shadow-lg flex items-center justify-center gap-2 transition hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                                        <span class="relative flex items-center justify-center">
                                            <i class="fas fa-user text-white text-xl"></i>
                                            <span class="add-user-plus-badge-long absolute -right-2 -bottom-2 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-indigo-500">
                                                <i class="fas fa-plus text-indigo-500 text-sm"></i>
                                            </span>
                                        </span>
                                        <span class="text-white font-semibold text-base ml-2">Add User</span>
                                        <span class="add-user-tooltip group-hover:opacity-100">Add User</span>
                                    </button>
                                </div>
                            </div>

                            <div class="flex space-x-3 pt-2">
                                <button type="submit" id="submit-button" class="flex-1 py-3 md:py-3.5 px-4 rounded-xl text-white font-semibold bg-gradient-to-r from-indigo-600 to-indigo-700 shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/40 transition duration-300 transform hover:-translate-y-0.5 active:scale-98 flex items-center justify-center gap-2">
                                    <i class="fas fa-save"></i> Save Expense
                                </button>
                                <button type="button" id="cancel-edit-button" class="hidden py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition duration-300 border border-gray-300">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-2 glass-panel p-5 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-5">
                            <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-3">
                                <span class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-clock-rotate-left text-purple-600"></i>
                                </span> Recent Transactions
                            </h2>
                            <div class="flex items-center gap-2 mt-4 md:mt-0">
                                <!-- Admin User Selector -->
                                <div id="admin-user-selector-expense" class="hidden admin-view-selector">
                                    <span class="view-label"><i class="fas fa-crown"></i><span>View as</span></span>
                                    <select id="admin-view-user-expense">
                                        <option value="">My Data</option>
                                    </select>
                                </div>
                                <button id="export-csv-btn" class="hidden md:inline-flex bg-emerald-500/90 hover:bg-emerald-600 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-semibold shadow-md transition transform hover:scale-105 active:scale-95">
                                    <i class="fas fa-file-csv mr-1"></i> CSV
                                </button>
                                <button id="export-pdf-btn" class="bg-indigo-500/90 hover:bg-indigo-600 text-white px-3 md:px-4 py-2 rounded-lg text-xs md:text-sm font-semibold shadow-md transition transform hover:scale-105 active:scale-95">
                                    <i class="fas fa-file-pdf mr-1"></i> PDF
                                </button>
                            </div>
                        </div>

                        <div class="mb-5 p-3 md:p-4 bg-white/30 rounded-2xl border border-white/40 shadow-inner space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <select id="filter-category" class="glass-input w-full rounded-lg text-sm text-gray-700"><option value="">All Categories</option></select>
                                <select id="filter-user" class="glass-input w-full rounded-lg text-sm text-gray-700"><option value="">All Users</option></select>
                                <select id="sort-by" class="glass-input w-full rounded-lg text-sm text-gray-700">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="amount-desc">Highest Amount</option>
                                    <option value="amount-asc">Lowest Amount</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:flex-row gap-3 items-center">
                                <input type="date" id="filter-start-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                                <span class="text-gray-500 font-bold">to</span>
                                <input type="date" id="filter-end-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                                <select id="filter-month" class="glass-input rounded-lg p-2 text-sm flex-1 w-full"><option value="">Filter by Month</option></select>
                                <button id="clear-filters-btn" class="bg-gray-200/50 hover:bg-gray-300/80 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">Clear</button>
                            </div>
                            <div>
                                <input type="text" id="filter-description" placeholder="Search description..." class="glass-input w-full rounded-lg p-2 text-sm">
                            </div>
                        </div>

                        <div id="expense-cards-container" class="space-y-2 max-h-[calc(100vh-280px)] ios-scroll elastic-scroll" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;">
                            <!-- Cards will be dynamically inserted here -->
                            <div id="empty-state" class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                                <p class="text-sm">No expenses yet. Add your first expense above!</p>
                            </div>
                        </div>

                        <!-- Total summary bar for cards view -->
                        <div id="expense-cards-total" class="mt-4 bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-4 flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-calculator text-indigo-500"></i> Total (USD)
                            </span>
                            <span id="cards-total-amount-usd" class="text-xl font-bold text-indigo-700">$0.00</span>
                        </div>

                        <!-- Desktop table view (hidden - using card view instead) -->
                        <div class="hidden overflow-x-auto max-h-[600px] relative rounded-xl border border-white/30 shadow-sm bg-white/20">
                            <table class="min-w-full divide-y divide-gray-200/50">
                                <thead class="sticky-header">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Category</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Desc</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">User</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="expense-table-body" class="divide-y divide-gray-200/30">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500 italic">Loading data...</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="bg-indigo-50/50 font-bold backdrop-blur-sm">
                                        <td class="px-4 py-3 text-sm text-indigo-900">Total (USD)</td>
                                        <td id="total-amount-usd" class="px-4 py-3 text-sm text-indigo-900 font-extrabold text-lg"></td>
                                        <td colspan="4"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="income-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                    <div class="lg:col-span-1 glass-panel p-5 md:p-6 rounded-2xl h-min sticky top-4 shadow-xl">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-5 flex items-center gap-3" id="income-form-title">
                            <span class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-hand-holding-dollar text-green-600"></i>
                            </span> Add Income
                        </h2>
                        <form id="income-form" class="space-y-5">
                            <input type="hidden" id="income-id">

                            <div class="flex space-x-3">
                                <div class="flex-1">
                                    <label for="income-amount" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">Amount</label>
                                    <input type="number" step="0.01" id="income-amount" required class="glass-input block w-full rounded-xl p-3 font-semibold text-gray-800">
                                </div>
                                <div class="w-32">
                                    <label for="income-currency" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">Currency</label>
                                    <select id="income-currency" class="glass-input block w-full rounded-xl p-3 font-semibold text-gray-800 cursor-pointer">
                                        <option value="USD">USD ($)</option>
                                        <option value="KHR" selected>KHR (៛)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label for="income-date" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">Date</label>
                                <input type="date" id="income-date" required class="glass-input block w-full rounded-xl p-3 text-gray-800">
                            </div>

                            <div>
                                <label for="income-source" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">Source</label>
                                <select id="income-source" required class="glass-input block w-full rounded-xl p-3 text-gray-800 cursor-pointer">
                                    <option value="">Select Source</option>
                                    <option value="salary">Salary</option>
                                    <option value="business">Business</option>
                                    <option value="bonus">Bonus</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div>
                                <label for="income-description" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">Description</label>
                                <input type="text" id="income-description" placeholder="Optional details..." class="glass-input block w-full rounded-xl p-3 text-gray-800">
                            </div>

                            <div id="income-user-selector-wrapper">
                                <label for="income-user" class="block text-xs font-bold text-indigo-900 uppercase tracking-wider mb-1">User</label>
                                <!-- Compact view: shows auto-selected user with change option -->
                                <div id="income-user-compact-view" class="user-selector-compact">
                                    <div class="user-display" id="income-user-display-name">
                                        <i class="fas fa-user mr-2"></i><span id="income-user-display-text">Select User...</span>
                                    </div>
                                    <button type="button" id="income-change-user-btn" class="change-user-btn">Change</button>
                                </div>
                                <!-- Full selector (hidden by default, shown when "Change" is clicked) -->
                                <div class="relative flex items-center">
                                    <select id="income-user" class="glass-input flex-1 rounded-xl text-gray-800 cursor-pointer user-selector-hidden min-w-0">
                                        <option value="" disabled selected>Select User...</option>
                                    </select>
                                </div>
                                <div class="flex justify-center mt-3 mb-1">
                                    <button type="button" id="income-add-user-btn" title="Add User" class="add-user-fab-long group w-full max-w-[320px] h-12 rounded-full bg-gradient-to-br from-indigo-500 to-violet-500 shadow-lg flex items-center justify-center gap-2 transition hover:scale-105 focus:outline-none focus:ring-2 focus:ring-indigo-300">
                                        <span class="relative flex items-center justify-center">
                                            <i class="fas fa-user text-white text-xl"></i>
                                            <span class="add-user-plus-badge-long absolute -right-2 -bottom-2 w-5 h-5 bg-white rounded-full flex items-center justify-center border-2 border-indigo-500">
                                                <i class="fas fa-plus text-indigo-500 text-sm"></i>
                                            </span>
                                        </span>
                                        <span class="text-white font-semibold text-base ml-2">Add User</span>
                                        <span class="add-user-tooltip group-hover:opacity-100">Add User</span>
                                    </button>
                                </div>
                                <!-- Add Income User Modal (Popup) -->
                                <div id="add-income-user-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/30 hidden">
                                    <div class="bg-white rounded-2xl p-6 w-full max-w-xs shadow-xl">
                                        <h3 class="text-lg font-bold mb-4 text-indigo-700">Add Income User</h3>
                                        <input id="add-income-user-input" type="text" class="glass-input w-full mb-3" placeholder="Enter user name..." maxlength="32" autocomplete="off" />
                                        <div id="add-income-user-error" class="text-red-500 text-sm mb-2"></div>
                                        <div class="flex justify-end gap-2">
                                            <button id="add-income-user-cancel" class="px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300">Cancel</button>
                                            <button id="add-income-user-confirm" class="px-4 py-2 rounded-lg bg-indigo-600 text-white font-bold hover:bg-indigo-700">Add</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="flex space-x-3 pt-2">
                                <button type="submit" id="income-submit-button" class="flex-1 py-3 md:py-3.5 px-4 rounded-xl text-white font-semibold bg-gradient-to-r from-green-500 to-green-600 shadow-lg shadow-green-500/30 hover:shadow-green-500/40 transition duration-300 transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                                    <i class="fas fa-save"></i> Save Income
                                </button>
                                <button type="button" id="income-cancel-edit-button" class="hidden py-3 px-4 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition duration-300 border border-gray-300">Cancel</button>
                            </div>
                        </form>
                    </div>

                    <div class="lg:col-span-2 glass-panel p-5 md:p-6 rounded-2xl shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-5">
                            <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-3">
                                <span class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-money-bill-wave text-green-600"></i>
                                </span> Income History
                            </h2>
                            <div class="flex items-center gap-2 mt-4 md:mt-0">
                                <!-- Admin User Selector -->
                                <div id="admin-user-selector-income" class="hidden admin-view-selector">
                                    <span class="view-label"><i class="fas fa-crown"></i><span>View as</span></span>
                                    <select id="admin-view-user-income">
                                        <option value="">My Data</option>
                                    </select>
                                </div>
                                <button id="export-income-csv-btn" class="hidden md:inline-flex bg-emerald-500/90 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition transform hover:scale-105">
                                    <i class="fas fa-file-csv mr-1"></i> CSV
                                </button>
                                <button id="export-income-pdf-btn" class="bg-indigo-500/90 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition transform hover:scale-105">
                                    <i class="fas fa-file-pdf mr-1"></i> PDF
                                </button>
                            </div>
                        </div>

                        <div class="mb-5 p-4 bg-white/30 rounded-2xl border border-white/40 shadow-inner space-y-3">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                <select id="filter-income-source" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700"><option value="">All Sources</option></select>
                                <select id="filter-income-user" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700"><option value="">All Users</option></select>
                                <select id="sort-income-by" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="amount-desc">Highest Amount</option>
                                    <option value="amount-asc">Lowest Amount</option>
                                </select>
                            </div>
                            <div class="flex flex-col md:flex-row gap-3 items-center">
                                <input type="date" id="filter-income-start-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                                <span class="text-gray-500 font-bold">to</span>
                                <input type="date" id="filter-income-end-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                                <select id="filter-income-month" class="glass-input rounded-lg p-2 text-sm flex-1 w-full"><option value="">Filter by Month</option></select>
                                <button id="clear-income-filters-btn" class="bg-gray-200/50 hover:bg-gray-300/80 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">Clear</button>
                            </div>
                            <div>
                                <input type="text" id="filter-income-description" placeholder="Search description..." class="glass-input w-full rounded-lg p-2 text-sm">
                            </div>
                        </div>

                        <!-- Mobile Card View -->
                        <div id="income-cards-container" class="space-y-2 max-h-[calc(100vh-280px)] ios-scroll elastic-scroll" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;">
                            <div id="income-empty-state" class="text-center py-12 text-gray-500">
                                <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                                <p class="text-sm">No income entries yet.</p>
                            </div>
                        </div>

                        <!-- Total summary bar for income cards view -->
                        <div id="income-cards-total" class="mt-4 bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-xl p-4 flex justify-between items-center">
                            <span class="text-sm font-semibold text-gray-700 flex items-center gap-2">
                                <i class="fas fa-calculator text-green-500"></i> Total Income (USD)
                            </span>
                            <span id="cards-total-income-usd" class="text-xl font-bold text-green-700">$0.00</span>
                        </div>

                        <!-- Desktop Table View (hidden - using card view instead) -->
                        <div class="hidden overflow-x-auto max-h-[600px] relative rounded-xl border border-white/30 shadow-sm bg-white/20">
                            <table class="min-w-full divide-y divide-gray-200/50">
                                <thead class="sticky-header">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Date</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Amount</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Source</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Desc</th>
                                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">User</th>
                                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-600 uppercase tracking-wider">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="income-table-body" class="divide-y divide-gray-200/30">
                                    <tr>
                                        <td colspan="6" class="text-center py-8 text-gray-500 italic">Loading data...</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="bg-green-50/50 font-bold backdrop-blur-sm">
                                        <td class="px-4 py-3 text-sm text-green-900">Total Income (USD)</td>
                                        <td id="total-income-usd" class="px-4 py-3 text-sm text-green-900 font-extrabold text-lg"></td>
                                        <td colspan="4"></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="history-tab" class="tab-content hidden">
                <div class="glass-panel p-5 md:p-6 rounded-2xl shadow-xl">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-5">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 flex items-center gap-3">
                            <span class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-history text-purple-600"></i>
                            </span> Transaction History
                        </h2>
                        <div class="flex items-center gap-2 mt-4 md:mt-0">
                            <!-- Admin User Selector for History -->
                            <div id="admin-user-selector-history" class="hidden admin-view-selector">
                                <span class="view-label"><i class="fas fa-crown"></i><span>View as</span></span>
                                <select id="admin-view-user-history">
                                    <option value="">My Data</option>
                                </select>
                            </div>
                            <button id="export-history-csv-btn" class="hidden md:inline-flex bg-emerald-500/90 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition transform hover:scale-105">
                                <i class="fas fa-file-csv mr-1"></i> CSV
                            </button>
                            <button id="export-history-pdf-btn" class="bg-indigo-500/90 hover:bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition transform hover:scale-105">
                                <i class="fas fa-file-pdf mr-1"></i> PDF
                            </button>
                        </div>
                    </div>

                    <div class="mb-5 p-4 bg-white/30 rounded-2xl border border-white/40 shadow-inner space-y-3 history-filters">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                            <select id="history-filter-type" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700">
                                <option value="">All Types</option>
                                <option value="expense">Expenses</option>
                                <option value="income">Income</option>
                            </select>
                            <select id="history-filter-category" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700"><option value="">All Categories</option></select>
                            <select id="history-filter-user" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700"><option value="">All Users</option></select>
                            <select id="history-sort-by" class="glass-input w-full rounded-lg p-2 text-sm text-gray-700">
                                <option value="date-desc">Newest First</option>
                                <option value="date-asc">Oldest First</option>
                                <option value="amount-desc">Highest Amount</option>
                                <option value="amount-asc">Lowest Amount</option>
                            </select>
                        </div>
                        <div class="flex flex-col md:flex-row gap-3 items-center">
                            <input type="date" id="history-filter-start-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                            <span class="text-gray-500 font-bold">to</span>
                            <input type="date" id="history-filter-end-date" class="glass-input rounded-lg p-2 text-sm flex-1 w-full">
                            <select id="history-filter-month" class="glass-input rounded-lg p-2 text-sm flex-1 w-full"><option value="">Filter by Month</option></select>
                            <button id="history-clear-filters-btn" class="bg-gray-200/50 hover:bg-gray-300/80 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium transition">Clear</button>
                        </div>
                        <div>
                            <input type="text" id="history-filter-description" placeholder="Search description..." class="glass-input w-full rounded-lg p-2 text-sm">
                        </div>
                    </div>

                    <!-- Mobile Card View -->
                    <div id="history-cards-container" class="space-y-3 max-h-[600px] ios-scroll elastic-scroll lg:hidden" style="-webkit-overflow-scrolling: touch; touch-action: pan-y; overscroll-behavior: contain;">
                        <div id="history-empty-state" class="text-center py-12 text-gray-500">
                            <i class="fas fa-inbox text-4xl mb-3 opacity-50"></i>
                            <p class="text-sm">No transactions yet.</p>
                        </div>
                    </div>

                    <!-- Desktop Table View -->
                    <div class="hidden lg:block overflow-x-auto max-h-[500px] md:max-h-[700px] relative rounded-xl border border-white/30 shadow-sm bg-white/20 history-table-container">
                        <table class="min-w-full divide-y divide-gray-200/50">
                            <thead class="sticky-header">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider amount-cell">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider category-cell">Category</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider desc-cell">Desc</th>
                                    <th class="px-4 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">User</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="divide-y divide-gray-200/30">
                                <tr>
                                    <td colspan="6" class="text-center py-8 text-gray-500 italic">Loading data...</td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr class="history-total-row">
                                    <td colspan="6" class="px-4 py-4">
                                        <div class="flex flex-wrap items-center justify-between gap-4">
                                            <div class="flex items-center gap-2">
                                                <i class="fas fa-calculator text-indigo-400"></i>
                                                <span class="font-bold text-lg">Summary</span>
                                            </div>
                                            <div class="flex flex-wrap items-center gap-6">
                                                <div class="flex items-center gap-2" id="history-total-count">
                                                    <!-- Filled by JS -->
                                                </div>
                                                <div id="history-total-amount">
                                                    <!-- Filled by JS -->
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>

            <div id="report-tab" class="tab-content hidden">
                <div class="space-y-6">
                    <!-- Report Header -->
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h2 class="text-2xl md:text-3xl font-bold text-white drop-shadow-md flex items-center gap-3">
                                <span class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-sm">
                                    <i class="fas fa-chart-line text-white"></i>
                                </span> Financial Analytics
                            </h2>
                            <p class="text-white/70 mt-1 text-sm">Track your financial performance and insights</p>
                        </div>
                        <!-- Admin User Selector -->
                        <div id="admin-user-selector-report" class="hidden admin-view-selector">
                            <span class="view-label"><i class="fas fa-crown"></i><span>View as</span></span>
                            <select id="admin-view-user-report">
                                <option value="">My Data</option>
                            </select>
                        </div>
                    </div>

                    <!-- Summary Stats Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div class="stat-card-pro">
                            <div class="stat-icon primary"><i class="fas fa-calendar-day"></i></div>
                            <p class="stat-label">Today's Expenses</p>
                            <p id="today-total" class="stat-value">$0.00</p>
                        </div>
                        <div class="stat-card-pro">
                            <div class="stat-icon primary"><i class="fas fa-calendar-week"></i></div>
                            <p class="stat-label">This Week</p>
                            <div class="flex items-baseline gap-2">
                                <p id="week-total" class="stat-value">$0.00</p>
                                <p id="weekly-comp" class="stat-change positive"></p>
                            </div>
                        </div>
                        <div class="stat-card-pro expense">
                            <div class="stat-icon danger"><i class="fas fa-calendar"></i></div>
                            <p class="stat-label">This Month</p>
                            <div class="flex items-baseline gap-2">
                                <p id="month-total" class="stat-value">$0.00</p>
                                <p id="monthly-comp" class="stat-change"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Income & Balance Cards -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div class="stat-card-pro income">
                            <div class="stat-icon success"><i class="fas fa-arrow-trend-up"></i></div>
                            <p class="stat-label">Total Income (This Month)</p>
                            <p id="total-income" class="stat-value text-green-600">$0.00</p>
                        </div>
                        <div class="stat-card-pro balance">
                            <div class="stat-icon info"><i class="fas fa-wallet"></i></div>
                            <p class="stat-label">Net Balance</p>
                            <p id="net-balance" class="stat-value text-blue-600">$0.00</p>
                        </div>
                    </div>

                    <!-- Monthly Breakdown Section -->
                    <div class="glass-panel p-6 rounded-2xl shadow-xl">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-3">
                                <span class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                    <i class="fas fa-table-cells text-indigo-600"></i>
                                </span> Monthly Breakdown
                            </h3>
                            <div class="flex items-center gap-3 mt-4 md:mt-0 bg-gray-100 p-2 rounded-xl">
                                <label for="report-month-select" class="text-sm font-semibold text-gray-600">Month:</label>
                                <select id="report-month-select" class="bg-white border border-gray-200 rounded-lg px-4 py-2 text-sm font-semibold text-gray-700 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 cursor-pointer"></select>
                            </div>
                        </div>
                        <div id="weekly-breakdown-container" class="space-y-4">
                            <p class="text-gray-500 text-center py-8">Please select a month to view breakdown.</p>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-1 chart-card">
                            <h3 class="chart-title"><i class="fas fa-chart-pie"></i> Category Distribution</h3>
                            <div class="w-full aspect-square relative">
                                <canvas id="categoryPieChart"></canvas>
                            </div>
                        </div>

                        <div class="lg:col-span-2 chart-card">
                            <h3 class="chart-title"><i class="fas fa-chart-bar"></i> 6-Month Trend</h3>
                            <div class="h-64 md:h-80">
                                <canvas id="monthlyBarChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Daily Trend Chart -->
                    <div class="chart-card">
                        <h3 class="chart-title"><i class="fas fa-chart-line"></i> Daily Trend (Last 30 Days)</h3>
                        <div class="h-64 md:h-80">
                            <canvas id="dailyLineChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-content hidden">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
                    <!-- Left Column: Profile & User Stats -->
                    <div class="lg:col-span-1 glass-panel p-5 md:p-6 rounded-2xl h-auto lg:h-min lg:sticky lg:top-4 shadow-xl">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-5 flex items-center gap-3">
                            <span class="w-10 h-10 bg-indigo-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-user-circle text-indigo-600"></i>
                            </span> Profile
                        </h2>

                        <!-- User Profile Info Card -->
                        <div class="bg-gradient-to-br from-indigo-50 to-purple-50 p-5 rounded-xl flex items-center gap-4 mb-4 border border-indigo-100">
                            <div id="user-profile-photo" class="w-16 h-16 md:w-18 md:h-18 rounded-2xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center overflow-hidden shadow-lg shadow-indigo-500/30">
                                <!-- Profile photo will be inserted here -->
                            </div>
                            <div>
                                <div class="font-bold text-gray-800 text-lg" id="user-profile-name">-</div>
                                <div class="text-sm text-gray-600" id="user-profile-email">-</div>
                                <span class="inline-block mt-2 px-3 py-1 bg-indigo-100 text-indigo-700 text-xs font-semibold rounded-full">Active User</span>
                            </div>
                        </div>

                        <!-- User Statistics Card -->
                        <div class="bg-white p-5 rounded-xl mb-4 border border-gray-200">
                            <div class="font-bold text-gray-800 mb-3 text-base flex items-center gap-2">
                                <i class="fas fa-chart-pie text-indigo-500"></i> User Statistics (This Month)
                            </div>
                            <div class="text-sm text-gray-600 mb-3">Total Users: <span id="user-stats-total-users" class="font-bold text-indigo-600">-</span></div>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-xs md:text-sm">
                                    <thead>
                                        <tr class="text-left text-gray-500 border-b border-gray-200">
                                            <th class="pr-4 py-2 font-semibold">User</th>
                                            <th class="pr-4 py-2 text-red-500 font-semibold">Expense</th>
                                            <th class="pr-4 py-2 text-green-500 font-semibold">Income</th>
                                            <th class="pr-4 py-2 text-blue-500 font-semibold">Net</th>
                                        </tr>
                                    </thead>
                                    <tbody id="user-stats-table-body">
                                        <!-- Filled by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Sign Out Button -->
                        <button id="settings-signout-btn" class="w-full py-3 md:py-3.5 px-4 rounded-xl text-white font-semibold bg-gradient-to-r from-red-500 to-red-600 shadow-lg shadow-red-500/30 hover:shadow-red-500/40 transition duration-300 transform hover:-translate-y-0.5 flex items-center justify-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>

                    <!-- Right Column: Settings & Admin -->
                    <div class="lg:col-span-2 glass-panel p-5 md:p-6 rounded-2xl shadow-xl">
                        <h2 class="text-lg md:text-xl font-bold text-gray-800 mb-6 flex items-center gap-3">
                            <span class="w-10 h-10 bg-gray-100 rounded-xl flex items-center justify-center">
                                <i class="fas fa-cog text-gray-600"></i>
                            </span> Settings
                        </h2>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                            <!-- Exchange Rate Setting -->
                            <div class="bg-white p-5 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <span class="w-8 h-8 bg-indigo-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-exchange-alt text-indigo-600 text-sm"></i>
                                    </span> Exchange Rate
                                </h3>
                                <p class="text-xs text-gray-500 mb-4">Set the KHR to USD exchange rate for all currency conversions.</p>

                                <div class="flex items-center gap-3">
                                    <div class="flex-1">
                                        <label class="block text-xs font-medium text-gray-600 mb-1">1 USD = </label>
                                        <div class="flex items-center">
                                            <input type="number" id="exchange-rate-input" step="1" min="1" class="glass-input block w-full rounded-lg font-semibold text-gray-800 text-lg" inputmode="numeric">
                                            <span class="ml-2 font-bold text-gray-700">៛ KHR</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="mt-4 flex gap-2">
                                    <button type="button" id="save-exchange-rate-btn" class="flex-1 py-2.5 px-4 rounded-lg text-white font-semibold bg-gradient-to-r from-indigo-600 to-indigo-700 shadow-md hover:shadow-lg transition duration-300 text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-save"></i> Save Rate
                                    </button>
                                    <button type="button" id="reset-exchange-rate-btn" class="py-2.5 px-4 rounded-lg bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition duration-300 text-sm">
                                        <i class="fas fa-undo"></i> Reset
                                    </button>
                                </div>

                                <div id="exchange-rate-status" class="mt-3 text-xs text-center text-gray-500">
                                    Current rate: <span id="current-rate-display" class="font-bold text-indigo-600"></span>
                                </div>
                            </div>

                            <!-- App Info -->
                            <div class="bg-white p-5 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                                <h3 class="text-sm font-bold text-gray-800 uppercase tracking-wider mb-3 flex items-center gap-2">
                                    <span class="w-8 h-8 bg-blue-100 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-info-circle text-blue-600 text-sm"></i>
                                    </span> App Info
                                </h3>
                                <div class="text-xs md:text-sm text-gray-600 space-y-2">
                                    <p><strong class="text-gray-700">App Name:</strong> Expense Tracker</p>
                                    <p><strong class="text-gray-700">Version:</strong> 2.0</p>
                                    <p><strong class="text-gray-700">Developer:</strong> SUOS THEANSOU</p>
                                    <p><strong class="text-gray-700">Description:</strong> Manage your daily income and expenses easily.</p>
                                    <p><strong class="text-gray-700">Last Update:</strong> Jan 2026</p>
                                    <p><strong class="text-gray-700">Contact:</strong> <a href="mailto:suostheansou@gmail.com" class="text-indigo-600 hover:underline">suostheansou@gmail.com</a></p>
                                    <div class="pt-3 border-t border-gray-200 mt-3">
                                        <p class="font-semibold text-gray-700 mb-2">Built with:</p>
                                        <div class="flex flex-wrap gap-2">
                                            <span class="bg-orange-100 text-orange-700 px-3 py-1 rounded-full text-xs font-semibold">Firebase</span>
                                            <span class="bg-cyan-100 text-cyan-700 px-3 py-1 rounded-full text-xs font-semibold">Tailwind CSS</span>
                                            <span class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-xs font-semibold">JavaScript</span>
                                            <span class="bg-pink-100 text-pink-700 px-3 py-1 rounded-full text-xs font-semibold">Chart.js</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 🔐 Admin Panel (Only visible for admins) - Full width -->
                            <div id="admin-panel" class="bg-gradient-to-br from-purple-50 to-indigo-50 p-5 rounded-xl hidden border-2 border-purple-200 md:col-span-2 shadow-sm">
                                <div class="flex items-center justify-between mb-5">
                                    <h3 class="text-sm font-bold text-purple-800 uppercase tracking-wider flex items-center gap-2">
                                        <span class="w-8 h-8 bg-purple-100 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-crown text-yellow-500 text-sm"></i>
                                        </span> Admin Panel
                                    </h3>
                                    <span class="bg-purple-600 text-white px-4 py-1.5 rounded-full text-xs font-bold shadow-md">ADMIN</span>
                                </div>

                                <!-- Admin Tabs -->
                                <div class="flex gap-2 mb-4 border-b border-purple-200 pb-3">
                                    <button id="admin-tab-data" onclick="switchAdminTab('data')" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold bg-purple-600 text-white transition">
                                        <i class="fas fa-database mr-1"></i> Data View
                                    </button>
                                    <button id="admin-tab-users" onclick="switchAdminTab('users')" class="flex-1 py-2 px-3 rounded-lg text-xs md:text-sm font-bold bg-gray-200 text-gray-700 hover:bg-purple-100 transition">
                                        <i class="fas fa-users-cog mr-1"></i> User Management
                                    </button>
                                </div>

                                <!-- ========== DATA VIEW TAB ========== -->
                                <div id="admin-data-tab-content">
                                    <!-- View Mode Toggle -->
                                    <div class="mb-4">
                                        <label class="block text-xs md:text-sm font-medium text-gray-700 mb-2">View Mode:</label>
                                        <div class="flex gap-2">
                                            <button id="view-my-data-btn" class="flex-1 py-2.5 px-4 rounded-xl text-sm font-bold bg-indigo-600 text-white">
                                                <i class="fas fa-user mr-1"></i> My Data
                                            </button>
                                            <button id="view-all-data-btn" class="flex-1 py-2.5 px-4 rounded-xl text-sm font-bold bg-gray-200 text-gray-700 hover:bg-purple-600 hover:text-white transition">
                                                <i class="fas fa-users mr-1"></i> All Users
                                            </button>
                                        </div>
                                    </div>

                                    <!-- All Users Data Table -->
                                    <div id="all-users-data-section" class="hidden">
                                        <div class="text-xs md:text-sm text-gray-600 mb-3">
                                            <i class="fas fa-info-circle mr-1"></i> Viewing all users' data
                                        </div>
                                        <div class="overflow-x-auto max-h-96 overflow-y-auto rounded-xl bg-white/30 p-3">
                                            <table class="min-w-full text-xs md:text-sm">
                                                <thead class="sticky top-0 bg-white">
                                                    <tr class="text-left text-gray-600 border-b">
                                                        <th class="pr-3 py-2">User</th>
                                                        <th class="pr-3 py-2 text-center">#</th>
                                                        <th class="pr-3 py-2 text-red-600">Expenses</th>
                                                        <th class="pr-3 py-2 text-green-600">Income</th>
                                                        <th class="pr-3 py-2 text-blue-600">Net</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="admin-data-table-body">
                                                    <!-- Filled by JS -->
                                                </tbody>
                                            </table>
                                        </div>
                                        <div class="mt-4 text-center">
                                            <button id="refresh-all-users-btn" class="py-2.5 px-6 rounded-xl text-sm font-bold bg-purple-100 text-purple-700 hover:bg-purple-200 transition">
                                                <i class="fas fa-sync-alt mr-1"></i> Refresh Data
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- ========== USER MANAGEMENT TAB ========== -->
                                <div id="admin-users-tab-content" class="hidden">
                                    <!-- Header with Add Button -->
                                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4">
                                        <div class="flex items-center gap-2">
                                            <span class="text-sm font-semibold text-gray-700">
                                                <i class="fas fa-users mr-1"></i> Total: <span id="admin-total-users" class="text-purple-600">0</span>
                                            </span>
                                            <span id="admin-filtered-count" class="text-xs text-gray-500"></span>
                                        </div>
                                        <button id="add-user-btn" onclick="openAddUserModal()" class="py-2 px-4 rounded-xl text-sm font-bold bg-green-500 text-white hover:bg-green-600 transition shadow-md">
                                            <i class="fas fa-user-plus mr-1"></i> Add User
                                        </button>
                                    </div>

                                    <!-- Search & Filters -->
                                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mb-4">
                                        <div class="relative">
                                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs"></i>
                                            <input type="text" id="admin-user-search" placeholder="Search by email or name..." class="w-full pl-9 pr-3 py-2.5 text-sm rounded-xl border border-gray-200 focus:border-purple-400 focus:ring-2 focus:ring-purple-100 outline-none transition">
                                        </div>
                                        <select id="admin-role-filter" class="w-full px-3 py-2.5 text-sm rounded-xl border border-gray-200 focus:border-purple-400 outline-none">
                                            <option value="all">All Roles</option>
                                            <option value="admin">👑 Admin</option>
                                            <option value="user">👤 User</option>
                                        </select>
                                        <select id="admin-status-filter" class="w-full px-3 py-2.5 text-sm rounded-xl border border-gray-200 focus:border-purple-400 outline-none">
                                            <option value="all">All Status</option>
                                            <option value="active">✅ Active</option>
                                            <option value="disabled">🚫 Disabled</option>
                                        </select>
                                    </div>

                                    <!-- Users Table -->
                                    <div class="overflow-x-auto rounded-xl bg-white/50 border border-gray-100">
                                        <div id="admin-users-loading" class="hidden text-center py-8">
                                            <i class="fas fa-spinner fa-spin text-2xl text-purple-500"></i>
                                            <p class="text-sm text-gray-500 mt-2">Loading users...</p>
                                        </div>
                                        <table class="min-w-full text-xs md:text-sm">
                                            <thead class="bg-gradient-to-r from-purple-50 to-indigo-50">
                                                <tr class="text-left text-gray-600">
                                                    <th class="px-3 py-3 font-semibold">User</th>
                                                    <th class="px-3 py-3 font-semibold">Role</th>
                                                    <th class="px-3 py-3 font-semibold">Status</th>
                                                    <th class="px-3 py-3 font-semibold">Created</th>
                                                    <th class="px-3 py-3 font-semibold text-right">Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="admin-users-table-body">
                                                <!-- Filled by JS -->
                                            </tbody>
                                        </table>
                                    </div>

                                    <!-- Buttons Row -->
                                    <div class="mt-4 flex flex-wrap justify-center gap-2">
                                        <button onclick="loadAllUsers()" class="py-2 px-6 rounded-xl text-sm font-bold bg-purple-100 text-purple-700 hover:bg-purple-200 transition">
                                            <i class="fas fa-sync-alt mr-1"></i> Refresh Users
                                        </button>
                                        <button onclick="syncUsersFromData()" class="py-2 px-6 rounded-xl text-sm font-bold bg-blue-100 text-blue-700 hover:bg-blue-200 transition">
                                            <i class="fas fa-users-cog mr-1"></i> Sync from Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity">
        <div class="glass-panel bg-white/90 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform scale-100 transition-transform">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Expense?</h3>
            <p class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-3">
                <button id="cancel-delete-btn" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium transition">Cancel</button>
                <button id="confirm-delete-btn" class="px-5 py-2.5 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-md transition">Delete</button>
            </div>
        </div>
    </div>

    <div id="delete-income-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm hidden items-center justify-center p-4 z-50 transition-opacity">
        <div class="glass-panel bg-white/90 p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center transform scale-100 transition-transform">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100 mb-4">
                <svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Delete Income?</h3>
            <p class="text-gray-600 mb-6">This action cannot be undone.</p>
            <div class="flex justify-center space-x-3">
                <button id="cancel-delete-income-btn" class="px-5 py-2.5 rounded-lg border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium transition">Cancel</button>
                <button id="confirm-delete-income-btn" class="px-5 py-2.5 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium shadow-md transition">Delete</button>
            </div>
        </div>
    </div>

    <!-- ========== ADD USER MODAL ========== -->
    <div id="add-user-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm items-center justify-center p-4 z-50" style="display: none;">
        <div class="glass-panel bg-white/95 p-6 rounded-2xl shadow-2xl w-full max-w-md transform scale-100 transition-transform">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-lg font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-plus mr-2 text-green-500"></i> Add New User
                </h3>
                <button onclick="closeAddUserModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-envelope mr-1 text-gray-400"></i> Email <span class="text-red-500">*</span>
                    </label>
                    <input type="email" id="new-user-email" placeholder="user@example.com" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-400 focus:ring-2 focus:ring-green-100 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1 text-gray-400"></i> Display Name
                    </label>
                    <input type="text" id="new-user-name" placeholder="John Doe" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-400 focus:ring-2 focus:ring-green-100 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user-tag mr-1 text-gray-400"></i> Role
                    </label>
                    <select id="new-user-role" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-green-400 outline-none">
                        <option value="user">👤 User</option>
                        <option value="admin">👑 Admin</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeAddUserModal()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium transition">
                    Cancel
                </button>
                <button id="add-user-submit-btn" onclick="addNewUser()" class="flex-1 py-3 rounded-xl bg-green-500 text-white hover:bg-green-600 font-bold shadow-md transition">
                    <i class="fas fa-plus mr-2"></i> Add User
                </button>
            </div>
        </div>
    </div>

    <!-- ========== EDIT USER MODAL ========== -->
    <div id="edit-user-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm items-center justify-center p-4 z-50" style="display: none;">
        <div class="glass-panel bg-white/95 p-6 rounded-2xl shadow-2xl w-full max-w-md transform scale-100 transition-transform">
            <div class="flex items-center justify-between mb-5">
                <h3 class="text-lg font-bold text-gray-900 flex items-center">
                    <i class="fas fa-user-edit mr-2 text-blue-500"></i> Edit User
                </h3>
                <button onclick="closeEditUserModal()" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>

            <input type="hidden" id="edit-user-id">

            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-envelope mr-1 text-gray-400"></i> Email
                    </label>
                    <input type="email" id="edit-user-email" disabled class="w-full px-4 py-3 rounded-xl border border-gray-200 bg-gray-50 text-gray-500 cursor-not-allowed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user mr-1 text-gray-400"></i> Display Name
                    </label>
                    <input type="text" id="edit-user-name" placeholder="John Doe" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-400 focus:ring-2 focus:ring-blue-100 outline-none transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-user-tag mr-1 text-gray-400"></i> Role
                    </label>
                    <select id="edit-user-role" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-400 outline-none">
                        <option value="user">👤 User</option>
                        <option value="admin">👑 Admin</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-toggle-on mr-1 text-gray-400"></i> Status
                    </label>
                    <select id="edit-user-status" class="w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-blue-400 outline-none">
                        <option value="active">✅ Active</option>
                        <option value="disabled">🚫 Disabled</option>
                    </select>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="closeEditUserModal()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium transition">
                    Cancel
                </button>
                <button id="edit-user-submit-btn" onclick="saveUserChanges()" class="flex-1 py-3 rounded-xl bg-blue-500 text-white hover:bg-blue-600 font-bold shadow-md transition">
                    <i class="fas fa-save mr-2"></i> Save Changes
                </button>
            </div>
        </div>
    </div>

    <!-- ========== DELETE USER MODAL ========== -->
    <div id="delete-user-modal" class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm items-center justify-center p-4 z-50" style="display: none;">
        <div class="glass-panel bg-white/95 p-6 rounded-2xl shadow-2xl w-full max-w-md text-center transform scale-100 transition-transform">
            <div class="mx-auto flex items-center justify-center h-14 w-14 rounded-full bg-red-100 mb-4">
                <i class="fas fa-user-times text-2xl text-red-600"></i>
            </div>

            <h3 class="text-xl font-bold text-gray-900 mb-2">Delete User?</h3>
            <p class="text-gray-600 mb-1">You are about to delete:</p>
            <p id="delete-user-email-display" class="font-bold text-red-600 mb-4">user@example.com</p>

            <input type="hidden" id="delete-user-id">

            <div class="bg-gray-50 rounded-xl p-4 mb-4 text-left">
                <p class="text-sm font-medium text-gray-700 mb-3">Delete Type:</p>
                <label class="flex items-center gap-3 mb-2 cursor-pointer">
                    <input type="radio" name="delete-type" value="soft" checked class="text-orange-500 focus:ring-orange-400">
                    <span class="text-sm">
                        <strong class="text-orange-600">Soft Delete</strong> - Disable user (recommended)
                    </span>
                </label>
                <label class="flex items-center gap-3 cursor-pointer">
                    <input type="radio" name="delete-type" value="hard" class="text-red-500 focus:ring-red-400">
                    <span class="text-sm">
                        <strong class="text-red-600">Hard Delete</strong> - Remove permanently
                    </span>
                </label>
            </div>

            <div class="flex gap-3">
                <button onclick="closeDeleteUserModal()" class="flex-1 py-3 rounded-xl border border-gray-300 text-gray-700 hover:bg-gray-100 font-medium transition">
                    Cancel
                </button>
                <button id="delete-user-confirm-btn" onclick="deleteUserConfirmed()" class="flex-1 py-3 rounded-xl bg-red-500 text-white hover:bg-red-600 font-bold shadow-md transition">
                    <i class="fas fa-trash mr-2"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        // ---------------------------
        // Constants & Globals
        // ---------------------------
        const CATEGORIES = [
            "Motorcycle Gas", "Lunch", "Dinner", "Coffee", "House Rent",
            "Supplies/Groceries", "Drinking Water", "Others"
        ];
        // Dynamic exchange rate with localStorage persistence
        const DEFAULT_KHR_RATE = 4100;

        function getExchangeRate() {
            const savedRate = localStorage.getItem('khr_exchange_rate');
            return savedRate ? parseFloat(savedRate) : DEFAULT_KHR_RATE;
        }

        function setExchangeRate(rate) {
            localStorage.setItem('khr_exchange_rate', rate.toString());
        }

        function getCurrencyRates() {
            return {
                USD: 1,
                KHR: getExchangeRate()
            };
        }
        const SHARED_GROUP_ID = "theansou_shared_family_group";

        // 🔴🔴🔴 ALLOWED EMAILS (Optional whitelist) 🔴🔴🔴
        // Set USE_EMAIL_WHITELIST to false to disable whitelist checking, or set ALLOWED_EMAILS to [] to allow anyone.
        const USE_EMAIL_WHITELIST = false; // set to false to allow any authenticated user
        const ALLOWED_EMAILS = ["suostheansou@gmail.com", "theansou092@gmail.com"];

        // ============================================
        // 🔐 ADMIN CONFIGURATION
        // ============================================
        const ADMIN_EMAILS = [
            "makara605799@gmail.com" // Primary Admin
        ];

        // User Roles & Status Constants
        const USER_ROLES = {
            USER: 'user',
            ADMIN: 'admin'
        };
        const USER_STATUS = {
            ACTIVE: 'active',
            DISABLED: 'disabled'
        };

        // Function to check if current user is admin
        function isCurrentUserAdmin() {
            if (!window.currentUser || !window.currentUser.email) return false;
            return ADMIN_EMAILS.includes(window.currentUser.email.toLowerCase());
        }

        // ============================================
        // 👥 USER MANAGEMENT FUNCTIONS
        // ============================================
        let allUsersData = [];

        // Switch Admin Panel Tabs
        function switchAdminTab(tab) {
            const dataTab = document.getElementById('admin-data-tab-content');
            const usersTab = document.getElementById('admin-users-tab-content');
            const dataBtn = document.getElementById('admin-tab-data');
            const usersBtn = document.getElementById('admin-tab-users');

            if (tab === 'data') {
                if (dataTab) dataTab.classList.remove('hidden');
                if (usersTab) usersTab.classList.add('hidden');
                if (dataBtn) {
                    dataBtn.classList.add('bg-purple-600', 'text-white');
                    dataBtn.classList.remove('bg-gray-200', 'text-gray-700');
                }
                if (usersBtn) {
                    usersBtn.classList.remove('bg-purple-600', 'text-white');
                    usersBtn.classList.add('bg-gray-200', 'text-gray-700');
                }
            } else {
                if (usersTab) usersTab.classList.remove('hidden');
                if (dataTab) dataTab.classList.add('hidden');
                if (usersBtn) {
                    usersBtn.classList.add('bg-purple-600', 'text-white');
                    usersBtn.classList.remove('bg-gray-200', 'text-gray-700');
                }
                if (dataBtn) {
                    dataBtn.classList.remove('bg-purple-600', 'text-white');
                    dataBtn.classList.add('bg-gray-200', 'text-gray-700');
                }
                loadAllUsers();
            }
        }

        // Load All Users from Firestore
        async function loadAllUsers() {
            if (!db || !isCurrentUserAdmin()) return;

            const tableBody = document.getElementById('admin-users-table-body');
            const loadingIndicator = document.getElementById('admin-users-loading');

            if (loadingIndicator) loadingIndicator.classList.remove('hidden');
            if (tableBody) tableBody.innerHTML = '';

            try {
                const usersSnapshot = await db.collection('users').get();
                allUsersData = [];

                usersSnapshot.forEach(doc => {
                    allUsersData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                allUsersData.sort((a, b) => (a.email || '').localeCompare(b.email || ''));
                renderUsersTable(allUsersData);

                const totalEl = document.getElementById('admin-total-users');
                if (totalEl) totalEl.textContent = allUsersData.length;

            } catch (error) {
                console.error('Error loading users:', error);
                showMessage('Error loading users: ' + error.message, 'error');
            } finally {
                if (loadingIndicator) loadingIndicator.classList.add('hidden');
            }
        }

        // Render Users Table
        function renderUsersTable(users) {
            const tableBody = document.getElementById('admin-users-table-body');
            if (!tableBody) return;

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr><td colspan="5" class="text-center py-8 text-gray-500">
                        <i class="fas fa-users text-3xl mb-2 block opacity-30"></i>No users found
                    </td></tr>`;
                return;
            }

            tableBody.innerHTML = users.map(user => {
                const roleClass = user.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700';
                const statusClass = user.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusIcon = user.status === 'active' ? 'fa-check-circle' : 'fa-ban';
                const createdDate = user.createdAt && user.createdAt.toDate ? user.createdAt.toDate().toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                }) : '-';

                return `
                    <tr class="border-b border-gray-100 hover:bg-white/50 transition">
                        <td class="px-3 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-400 to-purple-500 flex items-center justify-center text-white text-xs font-bold">
                                    ${(user.displayName || user.email || '?').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-semibold text-gray-800 text-xs md:text-sm">${user.displayName || 'No Name'}</div>
                                    <div class="text-xs text-gray-500">${user.email || '-'}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-3 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${roleClass}">
                                ${user.role === 'admin' ? '👑 Admin' : '👤 User'}
                            </span>
                        </td>
                        <td class="px-3 py-3">
                            <span class="px-2 py-1 rounded-full text-xs font-bold ${statusClass}">
                                <i class="fas ${statusIcon} mr-1"></i>${user.status === 'active' ? 'Active' : 'Disabled'}
                            </span>
                        </td>
                        <td class="px-3 py-3 text-xs text-gray-500">${createdDate}</td>
                        <td class="px-3 py-3 text-right">
                            <div class="flex gap-1 justify-end">
                                <button onclick="openEditUserModal('${user.id}')" class="p-2 rounded-lg bg-blue-100 text-blue-600 hover:bg-blue-200 transition" title="Edit">
                                    <i class="fas fa-edit text-xs"></i>
                                </button>
                                <button onclick="toggleUserStatus('${user.id}', '${user.status}')" 
                                    class="p-2 rounded-lg ${user.status === 'active' ? 'bg-orange-100 text-orange-600 hover:bg-orange-200' : 'bg-green-100 text-green-600 hover:bg-green-200'} transition" 
                                    title="${user.status === 'active' ? 'Disable' : 'Enable'}">
                                    <i class="fas ${user.status === 'active' ? 'fa-ban' : 'fa-check'} text-xs"></i>
                                </button>
                                <button onclick="confirmDeleteUser('${user.id}', '${user.email}')" class="p-2 rounded-lg bg-red-100 text-red-600 hover:bg-red-200 transition" title="Delete">
                                    <i class="fas fa-trash text-xs"></i>
                                </button>
                            </div>
                        </td>
                    </tr>`;
            }).join('');
        }

        // Filter Users Table
        function filterUsersTable() {
            const searchInput = document.getElementById('admin-user-search');
            const roleSelect = document.getElementById('admin-role-filter');
            const statusSelect = document.getElementById('admin-status-filter');

            const searchTerm = (searchInput ? searchInput.value : '').toLowerCase();
            const roleFilter = roleSelect ? roleSelect.value : 'all';
            const statusFilter = statusSelect ? statusSelect.value : 'all';

            const filtered = allUsersData.filter(user => {
                const matchesSearch = !searchTerm || (user.email || '').toLowerCase().includes(searchTerm) || (user.displayName || '').toLowerCase().includes(searchTerm);
                const matchesRole = roleFilter === 'all' || user.role === roleFilter;
                const matchesStatus = statusFilter === 'all' || user.status === statusFilter;
                return matchesSearch && matchesRole && matchesStatus;
            });

            renderUsersTable(filtered);
            const filteredCountEl = document.getElementById('admin-filtered-count');
            if (filteredCountEl) filteredCountEl.textContent = filtered.length !== allUsersData.length ? `(${filtered.length} shown)` : '';
        }

        // Add User Modal Functions
        function openAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.style.display = 'flex';
                const emailInput = document.getElementById('new-user-email');
                if (emailInput) setTimeout(() => emailInput.focus(), 100);
            }
        }

        function closeAddUserModal() {
            const modal = document.getElementById('add-user-modal');
            if (modal) {
                modal.style.display = 'none';
                const emailInput = document.getElementById('new-user-email');
                const nameInput = document.getElementById('new-user-name');
                const roleSelect = document.getElementById('new-user-role');
                if (emailInput) emailInput.value = '';
                if (nameInput) nameInput.value = '';
                if (roleSelect) roleSelect.value = 'user';
            }
        }

        async function addNewUser() {
            const emailInput = document.getElementById('new-user-email');
            const nameInput = document.getElementById('new-user-name');
            const roleSelect = document.getElementById('new-user-role');

            const email = emailInput ? emailInput.value.trim() : '';
            const displayName = nameInput ? nameInput.value.trim() : '';
            const role = roleSelect ? roleSelect.value : 'user';

            if (!email) {
                showMessage('Please enter an Email', 'error');
                return;
            }
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showMessage('Invalid Email format', 'error');
                return;
            }

            const existingUser = allUsersData.find(u => u.email && u.email.toLowerCase() === email.toLowerCase());
            if (existingUser) {
                showMessage('This user already exists', 'error');
                return;
            }

            const addBtn = document.getElementById('add-user-submit-btn');
            if (addBtn) {
                addBtn.disabled = true;
                addBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Adding...';
            }

            try {
                await db.collection('users').add({
                    email: email.toLowerCase(),
                    displayName: displayName || email.split('@')[0],
                    role: role,
                    status: 'active',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    createdBy: currentUser ? currentUser.email : 'admin'
                });
                showMessage('User added: ' + email, 'success');
                closeAddUserModal();
                loadAllUsers();
            } catch (error) {
                console.error('Error adding user:', error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                if (addBtn) {
                    addBtn.disabled = false;
                    addBtn.innerHTML = '<i class="fas fa-plus mr-2"></i> Add User';
                }
            }
        }

        // Edit User Modal Functions
        function openEditUserModal(userId) {
            const user = allUsersData.find(u => u.id === userId);
            if (!user) {
                showMessage('User not found', 'error');
                return;
            }

            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                document.getElementById('edit-user-id').value = userId;
                document.getElementById('edit-user-email').value = user.email || '';
                document.getElementById('edit-user-name').value = user.displayName || '';
                document.getElementById('edit-user-role').value = user.role || 'user';
                document.getElementById('edit-user-status').value = user.status || 'active';
                modal.style.display = 'flex';
            }
        }

        function closeEditUserModal() {
            const modal = document.getElementById('edit-user-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function saveUserChanges() {
            const userIdInput = document.getElementById('edit-user-id');
            const nameInput = document.getElementById('edit-user-name');
            const roleSelect = document.getElementById('edit-user-role');
            const statusSelect = document.getElementById('edit-user-status');

            const userId = userIdInput ? userIdInput.value : '';
            const displayName = nameInput ? nameInput.value.trim() : '';
            const role = roleSelect ? roleSelect.value : 'user';
            const status = statusSelect ? statusSelect.value : 'active';

            if (!userId) return;

            const saveBtn = document.getElementById('edit-user-submit-btn');
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';
            }

            try {
                await db.collection('users').doc(userId).update({
                    displayName: displayName,
                    role: role,
                    status: status,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser ? currentUser.email : 'admin'
                });
                showMessage('User information updated', 'success');
                closeEditUserModal();
                loadAllUsers();
            } catch (error) {
                console.error('Error updating user:', error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> Save Changes';
                }
            }
        }

        // Toggle User Status
        async function toggleUserStatus(userId, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
            const actionText = newStatus === 'active' ? 'Enable' : 'Disable';

            if (!confirm('Are you sure you want to ' + actionText + ' this user?')) return;

            try {
                await db.collection('users').doc(userId).update({
                    status: newStatus,
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedBy: currentUser ? currentUser.email : 'admin'
                });
                showMessage('User has been ' + actionText + 'd', 'success');
                loadAllUsers();
            } catch (error) {
                console.error('Error toggling user status:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Delete User Functions
        function confirmDeleteUser(userId, email) {
            const modal = document.getElementById('delete-user-modal');
            if (modal) {
                document.getElementById('delete-user-id').value = userId;
                document.getElementById('delete-user-email-display').textContent = email || 'Unknown';
                modal.style.display = 'flex';
            }
        }

        function closeDeleteUserModal() {
            const modal = document.getElementById('delete-user-modal');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        async function deleteUserConfirmed() {
            const userIdInput = document.getElementById('delete-user-id');
            const deleteTypeInput = document.querySelector('input[name="delete-type"]:checked');

            const userId = userIdInput ? userIdInput.value : '';
            const deleteType = deleteTypeInput ? deleteTypeInput.value : 'soft';

            if (!userId) return;

            const deleteBtn = document.getElementById('delete-user-confirm-btn');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Deleting...';
            }

            try {
                if (deleteType === 'hard') {
                    await db.collection('users').doc(userId).delete();
                    showMessage('User permanently deleted', 'success');
                } else {
                    await db.collection('users').doc(userId).update({
                        status: 'deleted',
                        deletedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        deletedBy: currentUser ? currentUser.email : 'admin'
                    });
                    showMessage('User disabled (Soft Delete)', 'success');
                }
                closeDeleteUserModal();
                loadAllUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showMessage('Error: ' + error.message, 'error');
            } finally {
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = '<i class="fas fa-trash mr-2"></i> Delete';
                }
            }
        }

        // Sync users from existing expenses/incomes data
        async function syncUsersFromData() {
            if (!db || !isCurrentUserAdmin()) {
                showMessage('Only admin can sync users', 'error');
                return;
            }

            showMessage('Syncing users...', 'info');

            try {
                // Get all unique users from expenses and incomes
                const uniqueUsers = new Set();
                const userEmails = new Map(); // Map user display name to email if available

                // Get from expenses
                const expensesSnapshot = await db.collection('expenses').get();
                expensesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.user) uniqueUsers.add(data.user);
                    if (data.userId) userEmails.set(data.user, data.userId);
                });

                // Get from incomes
                const incomesSnapshot = await db.collection('incomes').get();
                incomesSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.user) uniqueUsers.add(data.user);
                    if (data.userId) userEmails.set(data.user, data.userId);
                });

                // Get existing users in users collection
                const existingUsersSnapshot = await db.collection('users').get();
                const existingEmails = new Set();
                const existingDisplayNames = new Set();
                existingUsersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.email) existingEmails.add(data.email.toLowerCase());
                    if (data.displayName) existingDisplayNames.add(data.displayName.toLowerCase());
                });

                // Add missing users
                let addedCount = 0;
                for (const userName of uniqueUsers) {
                    // Skip if already exists by display name
                    if (existingDisplayNames.has(userName.toLowerCase())) continue;

                    // Try to find email
                    let email = userEmails.get(userName);
                    if (!email) {
                        // Generate a placeholder email based on name
                        email = userName.toLowerCase().replace(/\s+/g, '') + '@user.local';
                    }

                    // Skip if email already exists
                    if (existingEmails.has(email.toLowerCase())) continue;

                    // Add new user
                    await db.collection('users').add({
                        email: email.toLowerCase(),
                        displayName: userName,
                        role: ADMIN_EMAILS.includes(email.toLowerCase()) ? 'admin' : 'user',
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        syncedFromData: true
                    });
                    addedCount++;
                }

                if (addedCount > 0) {
                    showMessage('Synced ' + addedCount + ' new users!', 'success');
                } else {
                    showMessage('No new users to sync', 'info');
                }

                loadAllUsers();

            } catch (error) {
                console.error('Error syncing users:', error);
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Auto-register user on login
        async function registerUserOnLogin(user) {
            if (!db || !user || !user.email) return;
            try {
                const userQuery = await db.collection('users').where('email', '==', user.email.toLowerCase()).get();
                if (userQuery.empty) {
                    await db.collection('users').add({
                        email: user.email.toLowerCase(),
                        displayName: user.displayName || user.email.split('@')[0],
                        role: ADMIN_EMAILS.includes(user.email.toLowerCase()) ? 'admin' : 'user',
                        status: 'active',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                } else {
                    await db.collection('users').doc(userQuery.docs[0].id).update({
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch (error) {
                console.error('Error registering user:', error);
            }
        }

        // Setup User Management Event Listeners
        function setupUserManagementListeners() {
            const searchInput = document.getElementById('admin-user-search');
            const roleFilter = document.getElementById('admin-role-filter');
            const statusFilter = document.getElementById('admin-status-filter');

            if (searchInput) searchInput.addEventListener('input', filterUsersTable);
            if (roleFilter) roleFilter.addEventListener('change', filterUsersTable);
            if (statusFilter) statusFilter.addEventListener('change', filterUsersTable);
        }

        // FIREBASE CONFIGURATION
        const firebaseConfig = {
            apiKey: "AIzaSyCqgCXAcOaRMPWlgt0PAI4wwp47jeCwWes",
            authDomain: "share-firebase-417ca.firebaseapp.com",
            projectId: "share-firebase-417ca",
            storageBucket: "share-firebase-417ca.firebasestorage.app",
            messagingSenderId: "204581403810",
            appId: "1:204581403810:web:6869c362466d12fc362bfb",
            measurementId: "G-LBZSYW4NSS"
        };

        let auth = null;
        let authMode = 'login'; // 'login' or 'register'
        let currentUser = null;
        let firestoreUnsubscribe = {};
        let db = null;

        // Helper function to get current month in YYYY-MM format
        function getCurrentMonth() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        let expenses = [];
        let currentFilters = {
            category: '',
            user: '',
            startDate: '',
            endDate: '',
            description: '',
            month: '',
            sortBy: 'date-desc'
        };
        let incomes = [];
        let currentIncomeFilters = {
            source: '',
            user: '',
            startDate: '',
            endDate: '',
            description: '',
            month: '',
            sortBy: 'date-desc'
        };
        let currentHistoryFilters = {
            type: '',
            category: '',
            user: '',
            startDate: '',
            endDate: '',
            description: '',
            month: '',
            sortBy: 'date-desc'
        };
        let deleteId = null;
        let deleteIncomeId = null;
        let pieChart, barChart, lineChart;
        let monthPieChart, monthLineChart;

        // ---------------------------
        // Firebase Initialization & Authentication
        // ---------------------------
        function initializeApp() {
            if (typeof firebase === 'undefined') {
                showMessage('Firebase SDK not loaded. Cannot connect to Cloud.', 'error');
                return;
            }
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            auth = firebase.auth();

            // Enable Firestore offline persistence for faster loading
            db.enablePersistence({
                    synchronizeTabs: true
                })
                .catch(err => {
                    if (err.code === 'failed-precondition') {
                        console.warn('Firestore persistence failed: Multiple tabs open');
                    } else if (err.code === 'unimplemented') {
                        console.warn('Firestore persistence not supported in this browser');
                    }
                });

            // Enable persistent login: keeps user logged in even after page refresh or app close
            auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .catch(err => console.warn('Persistence setup warning:', err));

            // Setup real-time authentication listener
            auth.onAuthStateChanged(handleAuthStateChange);

            // Always refresh data listeners on app launch or resume
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    refreshDataListeners();
                }
            });
            window.addEventListener('pageshow', (event) => {
                if (event.persisted || document.visibilityState === 'visible') {
                    refreshDataListeners();
                }
            });
        }

        // Unsubscribe and re-subscribe to Firestore listeners to always get fresh data
        function refreshDataListeners() {
            if (currentUser && typeof startFirestoreListener === 'function') {
                // Unsubscribe previous listeners if any
                if (firestoreUnsubscribe.expenses) firestoreUnsubscribe.expenses();
                if (firestoreUnsubscribe.incomes) firestoreUnsubscribe.incomes();
                firestoreUnsubscribe = {};
                // Start new listeners for the current user (each user has their own data)
                startFirestoreListener(currentUser.uid);
            }
        }

        async function handleAuthStateChange(user) {
            const loadingScreen = document.getElementById('loading-screen');
            const appContent = document.getElementById('app-content');
            const userInfoEl = document.getElementById('user-info');
            const signoutBtn = document.getElementById('signout-btn');

            // 1. Clear previous state
            expenses = [];
            incomes = [];
            if (firestoreUnsubscribe.expenses) firestoreUnsubscribe.expenses();
            if (firestoreUnsubscribe.incomes) firestoreUnsubscribe.incomes();
            firestoreUnsubscribe = {};

            if (user) {
                // User is signed in.
                currentUser = user;
                window.currentUser = user; // <-- Ensure global access for Settings tab
                localStorage.setItem('userLoggedIn', 'true');
                localStorage.setItem('userEmail', user.email || 'Group Member');
                const displayName = user.email || 'Group Member';
                userInfoEl.textContent = `👤 ${displayName}`;
                const mobileUserInfo = document.getElementById('mobile-user-info');
                if (mobileUserInfo) {
                    mobileUserInfo.textContent = displayName.split('@')[0];
                }
                signoutBtn.classList.remove('hidden');
                loadingScreen.classList.remove('hidden');
                startFirestoreListener(user.uid);
                const bottomNav = document.getElementById('bottom-nav');
                if (bottomNav) bottomNav.classList.remove('hidden');
                updateUserSelectorsAfterLogin();

                // Register/Update user in users collection
                registerUserOnLogin(user);
            } else {
                // User is signed out or not logged in - redirect to login page
                currentUser = null;
                window.currentUser = null;
                localStorage.removeItem('userLoggedIn');
                localStorage.removeItem('userEmail');

                // Redirect to login page
                window.location.href = 'login.html';
            }
        }

        function startFirestoreListener(groupId) {
            let syncCompleted = {
                expenses: false,
                incomes: false
            };

            function checkSyncComplete() {
                if (syncCompleted.expenses && syncCompleted.incomes) {
                    // Remove delay - show content immediately when data is ready
                    const loadingScreen = document.getElementById('loading-screen');
                    const appContent = document.getElementById('app-content');
                    loadingScreen.classList.add('hidden');
                    appContent.classList.remove('hidden');

                    // Update dashboard immediately
                    if (typeof updateDashboardOverview === 'function') {
                        updateDashboardOverview();
                    }

                    // Initialize Admin Panel after data sync (show admin selectors if user is admin)
                    if (typeof initializeAdminPanel === 'function') {
                        initializeAdminPanel();
                    }
                }
            }

            // --- Date Range Firestore Query for Expenses ---
            let expenseQuery = db.collection('expenses').where('groupId', '==', groupId);
            // Use currentFilters for date range
            let fromDate = currentFilters.startDate;
            let toDate = currentFilters.endDate;
            if (fromDate) {
                const fromDateObj = new Date(fromDate);
                fromDateObj.setHours(0, 0, 0, 0);
                expenseQuery = expenseQuery.where('date', '>=', fromDateObj.toISOString().split('T')[0]);
            }
            if (toDate) {
                const toDateObj = new Date(toDate);
                toDateObj.setHours(23, 59, 59, 999);
                expenseQuery = expenseQuery.where('date', '<=', toDateObj.toISOString().split('T')[0]);
            }

            // Use includeMetadataChanges to get cache data immediately
            firestoreUnsubscribe.expenses = expenseQuery.onSnapshot({
                includeMetadataChanges: true
            }, snapshot => {
                expenses = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    expenses.push({
                        id: doc.id,
                        amount: parseFloat(data.amount),
                        currency: data.currency,
                        date: data.date,
                        category: data.category,
                        description: data.description,
                        user: data.user,
                        userId: data.userId,
                        groupId: data.groupId
                    });
                });
                syncCompleted.expenses = true;
                updateUI();
                // Only check sync complete when data is from server (not cache)
                if (!snapshot.metadata.fromCache) {
                    checkSyncComplete();
                } else if (expenses.length > 0) {
                    // Show cached data immediately
                    checkSyncComplete();
                }
            }, err => {
                console.error("Firebase expense error:", err);
                showMessage('Expense connection error: ' + err.message, 'error');
                syncCompleted.expenses = true;
                checkSyncComplete();
            });

            // --- Date Range Firestore Query for Incomes (if needed, similar logic) ---
            firestoreUnsubscribe.incomes = db.collection('incomes')
                .where('groupId', '==', groupId)
                .onSnapshot({
                    includeMetadataChanges: true
                }, snapshot => {
                    incomes = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        incomes.push({
                            id: doc.id,
                            amount: parseFloat(data.amount),
                            currency: data.currency,
                            date: data.date,
                            source: data.source,
                            description: data.description,
                            user: data.user,
                            userId: data.userId,
                            groupId: data.groupId,
                            createdAt: data.createdAt ? data.createdAt.toDate() : null
                        });
                    });
                    // Run migration only once
                    if (!window.migrationCompleted) {
                        window.migrationCompleted = true;
                        migrateUserData(true).catch(err => {
                            console.log('Migration check completed (may have found no data to migrate)');
                        });
                    }
                    syncCompleted.incomes = true;
                    updateUI();
                    // Only check sync complete when data is from server (not cache)
                    if (!snapshot.metadata.fromCache) {
                        checkSyncComplete();
                    } else if (incomes.length > 0) {
                        // Show cached data immediately
                        checkSyncComplete();
                    }
                }, err => {
                    console.error("Firebase income error:", err);
                    showMessage('Income connection error: ' + err.message, 'error');
                    syncCompleted.incomes = true;
                    checkSyncComplete();
                });
        }


        // ---------------------------
        // Helper functions
        // ---------------------------
        function convertToUSD(amount, currency) {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount) || numAmount === 0) return 0;
            const rates = getCurrencyRates();
            const rate = rates[currency] || 1;
            return currency === 'USD' ? numAmount : numAmount / rate;
        }

        function formatUSD(amount) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }

        function formatCurrency(amount, currency = 'USD') {
            const numAmount = parseFloat(amount);
            if (isNaN(numAmount)) return currency === 'KHR' ? '0៛' : '$0.00';

            if (currency === 'KHR') {
                return new Intl.NumberFormat('km-KH', {
                    style: 'currency',
                    currency: 'KHR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(numAmount);
            }

            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(numAmount);
        }

        function showMessage(message, type = 'info') {
            const container = document.getElementById('message-container');
            const colors = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-indigo-500 text-white'
            };
            const icons = {
                success: '<i class="fas fa-check-circle"></i>',
                error: '<i class="fas fa-exclamation-circle"></i>',
                info: '<i class="fas fa-info-circle"></i>'
            };
            const alert = document.createElement('div');
            alert.className = `px-4 py-3 ${colors[type] || colors.info} rounded-xl shadow-lg flex items-center gap-3 backdrop-blur-sm animate-fade-in-down cursor-pointer`;
            alert.innerHTML = `
                <span class="text-base">${icons[type] || icons.info}</span>
                <p class="text-sm font-medium flex-1">${message}</p>
                <button class="text-white/80 hover:text-white text-lg">&times;</button>
            `;
            alert.querySelector('button').onclick = (e) => {
                e.stopPropagation();
                alert.remove();
            };
            alert.onclick = () => alert.remove();
            container.appendChild(alert);

            setTimeout(() => {
                if (alert.parentNode) {
                    alert.style.opacity = '0';
                    alert.style.transform = 'translateY(10px)';
                    alert.style.transition = 'all 0.3s ease';
                    setTimeout(() => alert.remove(), 300);
                }
            }, 3000);
        }

        // ---------------------------
        // EXPORT TO CSV (Excel) FUNCTIONS
        // ---------------------------
        function convertToCSV(data) {
            const headers = [
                "Date", "Category", "Description", "User", "Amount", "Currency", "Amount (USD Normalized)", "Expense ID"
            ];
            const rows = data.map(expense => {
                const usdAmount = convertToUSD(expense.amount, expense.currency).toFixed(2);
                return [
                    `"${expense.date}"`,
                    `"${expense.category.replace(/"/g, '""')}"`,
                    `"${expense.description.replace(/"/g, '""')}"`,
                    `"${expense.user || 'Self'}"`,
                    expense.amount,
                    `"${expense.currency}"`,
                    usdAmount,
                    `"${expense.id}"`
                ].join(',');
            });
            return [
                headers.join(','),
                ...rows
            ].join('\n');
        }

        function convertToExcelFile() {
            const filteredData = getFilteredAndSortedExpenses(expenses);
            if (filteredData.length === 0) {
                showMessage("No data to export based on current filters.", 'info');
                return;
            }
            const csvContent = convertToCSV(filteredData);
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `theansou_expenses_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Successfully exported ${filteredData.length} expenses to CSV!`, 'success');
        }

        function convertToIncomeCSV(data) {
            const headers = [
                "Date", "Source", "Description", "User", "Amount", "Currency", "Amount (USD Normalized)", "Income ID"
            ];
            const rows = data.map(income => {
                const usdAmount = convertToUSD(income.amount, income.currency).toFixed(2);
                return [
                    `"${income.date}"`,
                    `"${income.source.replace(/"/g, '""')}"`,
                    `"${income.description.replace(/"/g, '""')}"`,
                    `"${income.user || 'Self'}"`,
                    income.amount,
                    `"${income.currency}"`,
                    usdAmount,
                    `"${income.id}"`
                ].join(',');
            });
            return [
                headers.join(','),
                ...rows
            ].join('\n');
        }

        function convertToIncomeExcelFile() {
            const filteredData = getFilteredAndSortedIncomes(incomes);
            if (filteredData.length === 0) {
                showMessage("No data to export based on current filters.", 'info');
                return;
            }
            const csvContent = convertToIncomeCSV(filteredData);
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `theansou_incomes_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Successfully exported ${filteredData.length} incomes to CSV!`, 'success');
        }

        function convertToHistoryCSV(data) {
            const headers = [
                "Type", "Date", "Category/Source", "Description", "User", "Amount", "Currency", "Amount (USD Normalized)", "ID"
            ];
            const rows = data.map(item => {
                const usdAmount = convertToUSD(item.amount, item.currency).toFixed(2);
                const categoryOrSource = item.type === 'expense' ? item.category : item.source;
                return [
                    `"${item.type}"`,
                    `"${item.date}"`,
                    `"${categoryOrSource.replace(/"/g, '""')}"`,
                    `"${item.description.replace(/"/g, '""')}"`,
                    `"${item.user || 'Self'}"`,
                    item.amount,
                    `"${item.currency}"`,
                    usdAmount,
                    `"${item.id}"`
                ].join(',');
            });
            return [
                headers.join(','),
                ...rows
            ].join('\n');
        }

        function convertToHistoryExcelFile() {
            const combinedData = [
                ...expenses.map(e => ({...e,
                    type: 'expense'
                })),
                ...incomes.map(i => ({...i,
                    type: 'income'
                }))
            ];
            const filteredData = getFilteredAndSortedHistory(combinedData);
            if (filteredData.length === 0) {
                showMessage("No data to export based on current filters.", 'info');
                return;
            }
            const csvContent = convertToHistoryCSV(filteredData);
            const blob = new Blob([csvContent], {
                type: 'text/csv;charset=utf-8;'
            });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `theansou_history_export_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessage(`Successfully exported ${filteredData.length} transactions to CSV!`, 'success');
        }

        let khmerFontLoaded = false;

        async function ensureKhmerFont(doc) {
            if (khmerFontLoaded || !doc || !doc.addFileToVFS) return;
            try {
                // Load Noto Sans Khmer Regular
                const regularResp = await fetch('https://cdn.jsdelivr.net/gh/nickshanks/Nokora@master/Nokora-Regular.ttf');
                if (!regularResp.ok) {
                    console.warn('Failed to load Nokora Regular, trying fallback...');
                    // Fallback to Google Fonts hosted version
                    const fallbackResp = await fetch('https://fonts.gstatic.com/s/notosanskh/v23/CrcHPaBYpuPQT76-BjU-K7L0Xpy.ttf');
                    if (!fallbackResp.ok) throw new Error('All font sources failed');
                    const buffer = await fallbackResp.arrayBuffer();
                    const base64 = arrayBufferToBase64(buffer);
                    doc.addFileToVFS('NotoSansKhmer-Regular.ttf', base64);
                    doc.addFont('NotoSansKhmer-Regular.ttf', 'NotoSansKhmer', 'normal');
                    doc.addFont('NotoSansKhmer-Regular.ttf', 'NotoSansKhmer', 'bold');
                    khmerFontLoaded = true;
                    return;
                }

                const buffer = await regularResp.arrayBuffer();
                const base64 = arrayBufferToBase64(buffer);
                doc.addFileToVFS('Nokora-Regular.ttf', base64);
                doc.addFont('Nokora-Regular.ttf', 'NotoSansKhmer', 'normal');

                // Try to load bold variant
                try {
                    const boldResp = await fetch('https://cdn.jsdelivr.net/gh/nickshanks/Nokora@master/Nokora-Bold.ttf');
                    if (boldResp.ok) {
                        const boldBuffer = await boldResp.arrayBuffer();
                        const boldBase64 = arrayBufferToBase64(boldBuffer);
                        doc.addFileToVFS('Nokora-Bold.ttf', boldBase64);
                        doc.addFont('Nokora-Bold.ttf', 'NotoSansKhmer', 'bold');
                    } else {
                        // Use regular as bold fallback
                        doc.addFont('Nokora-Regular.ttf', 'NotoSansKhmer', 'bold');
                    }
                } catch (e) {
                    doc.addFont('Nokora-Regular.ttf', 'NotoSansKhmer', 'bold');
                }

                khmerFontLoaded = true;
                console.log('Khmer font (Nokora) loaded successfully');
            } catch (err) {
                console.warn('Khmer font load failed (fallback to Helvetica):', err);
            }
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            const chunkSize = 8192;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, Math.min(i + chunkSize, bytes.length));
                binary += String.fromCharCode.apply(null, chunk);
            }
            return btoa(binary);
        }

        function formatUsd(amount) {
            const val = Number(amount) || 0;
            return `$${val.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            })}`;
        }

        function getDateRangeLabel(items) {
            if (!items || !items.length) return 'No date range';
            const dates = items
                .map(item => item.date)
                .filter(Boolean)
                .sort();
            if (!dates.length) return 'No date range';
            return dates[0] === dates[dates.length - 1] ? dates[0] : `${dates[0]} to ${dates[dates.length - 1]}`;
        }

        function computeSummary(items, defaultType = 'expense') {
            let totalIncome = 0;
            let totalExpenses = 0;
            let totalIncomeKHR = 0;
            let totalExpensesKHR = 0;
            const categoryTotals = {};
            const userTotals = {};
            const exchangeRate = parseFloat(localStorage.getItem('exchangeRate')) || 4100;

            items.forEach(item => {
                const type = item.type || defaultType;
                const usd = convertToUSD(item.amount, item.currency);
                const khr = item.currency === 'KHR' ? item.amount : item.amount * exchangeRate;

                if (type === 'income') {
                    totalIncome += usd;
                    totalIncomeKHR += khr;
                } else {
                    totalExpenses += usd;
                    totalExpensesKHR += khr;
                }

                const categoryKey = type === 'income' ? (item.source || 'Unspecified') : (item.category || 'Unspecified');
                categoryTotals[categoryKey] = (categoryTotals[categoryKey] || 0) + usd;

                const userKey = item.user || 'Self';
                if (!userTotals[userKey]) {
                    userTotals[userKey] = {
                        usd: 0,
                        khr: 0
                    };
                }
                userTotals[userKey].usd += usd;
                userTotals[userKey].khr += khr;
            });

            const topCategory = (Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0] || [])[0] || 'N/A';
            const topSpender = (Object.entries(userTotals).sort((a, b) => b[1].usd - a[1].usd)[0] || [])[0] || 'N/A';

            return {
                totalIncome,
                totalExpenses,
                totalIncomeKHR,
                totalExpensesKHR,
                netBalance: totalIncome - totalExpenses,
                netBalanceKHR: totalIncomeKHR - totalExpensesKHR,
                topCategory,
                topSpender,
                userTotals
            };
        }

        async function createStyledPdf(titleText, dateRangeText) {
            if (!window.jspdf || !window.jspdf.jsPDF) {
                showMessage('PDF library failed to load.', 'error');
                return null;
            }
            const {
                jsPDF
            } = window.jspdf;
            const doc = new jsPDF({
                unit: 'pt',
                format: 'a4'
            });
            await ensureKhmerFont(doc);
            const baseFont = khmerFontLoaded ? 'NotoSansKhmer' : 'helvetica';
            const pageWidth = doc.internal.pageSize.getWidth();

            // Top color bar
            doc.setFillColor(99, 102, 241);
            doc.rect(0, 0, pageWidth, 32, 'F');

            // Title
            doc.setFont(baseFont, 'bold');
            doc.setFontSize(16);
            doc.setTextColor(255, 255, 255);
            doc.text('TRANSACTION SUMMARY REPORT', pageWidth / 2, 20, {
                align: 'center'
            });

            // Meta text
            doc.setTextColor(45, 55, 72);
            doc.setFont(baseFont, 'normal');
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 32, 48);
            doc.text(`Date range: ${dateRangeText}`, 32, 62);
            doc.setFont(baseFont, 'bold');
            doc.text(titleText, pageWidth - 32, 48, {
                align: 'right'
            });

            return {
                doc,
                baseFont,
                cursorY: 78,
                pageWidth
            };
        }

        function formatKhr(amount) {
            const val = Number(amount) || 0;
            return `${val.toLocaleString('en-US', { maximumFractionDigits: 0 })} KHR`;
        }

        function drawExecutiveSummary(doc, baseFont, startY, summary) {
            const pageWidth = doc.internal.pageSize.getWidth();
            const boxX = 24;
            const boxW = pageWidth - boxX * 2;
            const userCount = Object.keys(summary.userTotals || {}).length;
            const userRows = Math.ceil(userCount / 2);
            const boxH = 110 + (userCount > 0 ? 16 + userRows * 18 : 0);
            const netColor = summary.netBalance >= 0 ? [22, 163, 74] : [220, 38, 38];

            doc.setFillColor(246, 248, 255);
            doc.roundedRect(boxX, startY, boxW, boxH, 6, 6, 'F');
            doc.setDrawColor(99, 102, 241);
            doc.roundedRect(boxX, startY, boxW, boxH, 6, 6, 'S');

            doc.setFont(baseFont, 'bold');
            doc.setTextColor(45, 55, 72);
            doc.setFontSize(12);
            doc.text('Executive Summary', boxX + 12, startY + 18);

            doc.setFontSize(9);

            // Row 1: Total Income
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(45, 55, 72);
            doc.text('Total Income:', boxX + 12, startY + 36);
            doc.setFont(baseFont, 'bold');
            doc.setTextColor(22, 163, 74);
            doc.text(`${formatUsd(summary.totalIncome)}`, boxX + 75, startY + 36);
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`(${formatKhr(summary.totalIncomeKHR)})`, boxX + 120, startY + 36);

            // Row 1: Total Expenses (right side)
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(45, 55, 72);
            doc.text('Total Expenses:', boxX + boxW / 2 + 10, startY + 36);
            doc.setFont(baseFont, 'bold');
            doc.setTextColor(220, 38, 38);
            doc.text(`${formatUsd(summary.totalExpenses)}`, boxX + boxW / 2 + 80, startY + 36);
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`(${formatKhr(summary.totalExpensesKHR)})`, boxX + boxW / 2 + 125, startY + 36);

            // Row 2: Net Balance
            doc.setFont(baseFont, 'bold');
            doc.setTextColor(...netColor);
            doc.text('Net Balance:', boxX + 12, startY + 52);
            doc.text(`${formatUsd(summary.netBalance)}`, boxX + 75, startY + 52);
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(100, 100, 100);
            doc.text(`(${formatKhr(summary.netBalanceKHR)})`, boxX + 120, startY + 52);

            // Row 2: Top Category (right side)
            doc.setFont(baseFont, 'normal');
            doc.setTextColor(45, 55, 72);
            doc.text('Top Category:', boxX + boxW / 2 + 10, startY + 52);
            doc.setFont(baseFont, 'bold');
            doc.text(`${summary.topCategory}`, boxX + boxW / 2 + 80, startY + 52);

            // Divider line
            doc.setDrawColor(200, 200, 220);
            doc.line(boxX + 12, startY + 66, boxX + boxW - 12, startY + 66);

            // User breakdown section
            doc.setFont(baseFont, 'bold');
            doc.setTextColor(45, 55, 72);
            doc.setFontSize(10);
            doc.text('Spending by User:', boxX + 12, startY + 82);

            doc.setFont(baseFont, 'normal');
            doc.setFontSize(9);
            let userY = startY + 96;
            const users = Object.entries(summary.userTotals || {}).sort((a, b) => b[1].usd - a[1].usd);

            users.forEach(([user, totals], index) => {
                const colX = index % 2 === 0 ? boxX + 16 : boxX + boxW / 2 + 10;
                const rowY = userY + Math.floor(index / 2) * 18;

                doc.setTextColor(60, 60, 60);
                doc.setFont(baseFont, 'normal');
                doc.text(`• ${user}:`, colX, rowY);
                doc.setFont(baseFont, 'bold');
                doc.setTextColor(45, 55, 72);
                doc.text(`${formatUsd(totals.usd)}`, colX + 55, rowY);
                doc.setFont(baseFont, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`(${formatKhr(totals.khr)})`, colX + 100, rowY);
            });

            return startY + boxH + 12;
        }

        function addPageNumbers(doc, baseFont) {
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFont(baseFont, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(100);
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                doc.text(`Page ${i} of ${pageCount}`, pageWidth - 24, pageHeight - 16, {
                    align: 'right'
                });
            }
        }

        function forcePdfDownload(doc, filename) {
            // Force download instead of opening in browser
            try {
                // Method 1: Use jsPDF's save (primary method)
                doc.save(filename);

                // Method 2: Fallback for browsers that need explicit download trigger
                setTimeout(() => {
                    const output = doc.output('arraybuffer');
                    const blob = new Blob([output], {
                        type: 'application/pdf'
                    });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
            } catch (err) {
                console.warn('PDF download error:', err);
                showMessage('Error downloading PDF. Please try again.', 'error');
            }
        }

        async function exportExpensesPDF() {
            const filteredData = getFilteredAndSortedExpenses(expenses);
            if (filteredData.length === 0) {
                showMessage('No data to export based on current filters.', 'info');
                return;
            }

            const dateRangeText = getDateRangeLabel(filteredData);
            const pdfBase = await createStyledPdf('Expenses', dateRangeText);
            if (!pdfBase || !pdfBase.doc || !pdfBase.doc.autoTable) {
                showMessage('PDF table plugin failed to load.', 'error');
                return;
            }
            const {
                doc,
                baseFont
            } = pdfBase;
            let cursorY = pdfBase.cursorY;

            const summary = computeSummary(filteredData, 'expense');
            cursorY = drawExecutiveSummary(doc, baseFont, cursorY, summary);

            const body = filteredData.map((expense, index) => ({
                idx: index + 1,
                date: expense.date,
                category: expense.category,
                description: expense.description || '-',
                user: expense.user || 'Self',
                amountDisplay: `${expense.amount} ${expense.currency}`,
                usd: convertToUSD(expense.amount, expense.currency).toFixed(2),
                amountNumeric: Number(expense.amount) || 0
            }));

            doc.autoTable({
                startY: cursorY,
                columns: [{
                    header: '#',
                    dataKey: 'idx'
                }, {
                    header: 'Date',
                    dataKey: 'date'
                }, {
                    header: 'Category',
                    dataKey: 'category'
                }, {
                    header: 'Description',
                    dataKey: 'description'
                }, {
                    header: 'User',
                    dataKey: 'user'
                }, {
                    header: 'Amount',
                    dataKey: 'amountDisplay'
                }, {
                    header: 'USD',
                    dataKey: 'usd'
                }],
                body,
                styles: {
                    font: baseFont,
                    fontSize: 8,
                    cellPadding: 4,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 252]
                },
                columnStyles: {
                    idx: {
                        cellWidth: 22,
                        halign: 'center'
                    },
                    date: {
                        cellWidth: 65,
                        halign: 'left'
                    },
                    category: {
                        cellWidth: 70
                    },
                    description: {
                        cellWidth: 'auto',
                        minCellWidth: 100
                    },
                    user: {
                        cellWidth: 55
                    },
                    amountDisplay: {
                        cellWidth: 65,
                        halign: 'right'
                    },
                    usd: {
                        cellWidth: 50,
                        halign: 'right'
                    }
                },
                margin: {
                    left: 24,
                    right: 24
                },
                tableWidth: 'auto',
                didParseCell: (data) => {
                    if (data.section === 'body' && data.column.dataKey === 'amountDisplay') {
                        data.cell.styles.textColor = [220, 38, 38];
                    }
                }
            });

            addPageNumbers(doc, baseFont);
            const filename = `theansou_expenses_export_${new Date().toISOString().split('T')[0]}.pdf`;
            forcePdfDownload(doc, filename);
            showMessage(`Successfully exported ${filteredData.length} expenses to PDF!`, 'success');
        }

        async function exportIncomesPDF() {
            const filteredData = getFilteredAndSortedIncomes(incomes);
            if (filteredData.length === 0) {
                showMessage('No data to export based on current filters.', 'info');
                return;
            }

            const dateRangeText = getDateRangeLabel(filteredData);
            const pdfBase = await createStyledPdf('Income', dateRangeText);
            if (!pdfBase || !pdfBase.doc || !pdfBase.doc.autoTable) {
                showMessage('PDF table plugin failed to load.', 'error');
                return;
            }
            const {
                doc,
                baseFont
            } = pdfBase;
            let cursorY = pdfBase.cursorY;

            const summary = computeSummary(filteredData, 'income');
            cursorY = drawExecutiveSummary(doc, baseFont, cursorY, summary);

            const body = filteredData.map((income, index) => ({
                idx: index + 1,
                date: income.date,
                source: income.source,
                description: income.description || '-',
                user: income.user || 'Self',
                amountDisplay: `${income.amount} ${income.currency}`,
                usd: convertToUSD(income.amount, income.currency).toFixed(2),
                amountNumeric: Number(income.amount) || 0
            }));

            doc.autoTable({
                startY: cursorY,
                columns: [{
                    header: '#',
                    dataKey: 'idx'
                }, {
                    header: 'Date',
                    dataKey: 'date'
                }, {
                    header: 'Source',
                    dataKey: 'source'
                }, {
                    header: 'Description',
                    dataKey: 'description'
                }, {
                    header: 'User',
                    dataKey: 'user'
                }, {
                    header: 'Amount',
                    dataKey: 'amountDisplay'
                }, {
                    header: 'USD',
                    dataKey: 'usd'
                }],
                body,
                styles: {
                    font: baseFont,
                    fontSize: 8,
                    cellPadding: 4,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 252]
                },
                columnStyles: {
                    idx: {
                        cellWidth: 22,
                        halign: 'center'
                    },
                    date: {
                        cellWidth: 65,
                        halign: 'left'
                    },
                    source: {
                        cellWidth: 70
                    },
                    description: {
                        cellWidth: 'auto',
                        minCellWidth: 100
                    },
                    user: {
                        cellWidth: 55
                    },
                    amountDisplay: {
                        cellWidth: 65,
                        halign: 'right'
                    },
                    usd: {
                        cellWidth: 50,
                        halign: 'right'
                    }
                },
                margin: {
                    left: 24,
                    right: 24
                },
                tableWidth: 'auto',
                didParseCell: (data) => {
                    if (data.section === 'body' && data.column.dataKey === 'amountDisplay') {
                        data.cell.styles.textColor = [22, 163, 74];
                    }
                }
            });

            addPageNumbers(doc, baseFont);
            const filename = `theansou_incomes_export_${new Date().toISOString().split('T')[0]}.pdf`;
            forcePdfDownload(doc, filename);
            showMessage(`Successfully exported ${filteredData.length} incomes to PDF!`, 'success');
        }

        async function exportHistoryPDF() {
            const combinedData = [
                ...expenses.map(e => ({...e,
                    type: 'expense'
                })),
                ...incomes.map(i => ({...i,
                    type: 'income'
                }))
            ];
            const filteredData = getFilteredAndSortedHistory(combinedData);
            if (filteredData.length === 0) {
                showMessage('No data to export based on current filters.', 'info');
                return;
            }

            const dateRangeText = getDateRangeLabel(filteredData);
            const pdfBase = await createStyledPdf('History', dateRangeText);
            if (!pdfBase || !pdfBase.doc || !pdfBase.doc.autoTable) {
                showMessage('PDF table plugin failed to load.', 'error');
                return;
            }
            const {
                doc,
                baseFont
            } = pdfBase;
            let cursorY = pdfBase.cursorY;

            const summary = computeSummary(filteredData, 'expense');
            cursorY = drawExecutiveSummary(doc, baseFont, cursorY, summary);

            const body = filteredData.map((item, index) => {
                const categoryOrSource = item.type === 'expense' ? item.category : item.source;
                return {
                    idx: index + 1,
                    type: item.type,
                    date: item.date,
                    category: categoryOrSource,
                    description: item.description || '-',
                    user: item.user || 'Self',
                    amountDisplay: `${item.amount} ${item.currency}`,
                    usd: convertToUSD(item.amount, item.currency).toFixed(2)
                };
            });

            doc.autoTable({
                startY: cursorY,
                columns: [{
                    header: '#',
                    dataKey: 'idx'
                }, {
                    header: 'Type',
                    dataKey: 'type'
                }, {
                    header: 'Date',
                    dataKey: 'date'
                }, {
                    header: 'Cat/Src',
                    dataKey: 'category'
                }, {
                    header: 'Description',
                    dataKey: 'description'
                }, {
                    header: 'User',
                    dataKey: 'user'
                }, {
                    header: 'Amount',
                    dataKey: 'amountDisplay'
                }, {
                    header: 'USD',
                    dataKey: 'usd'
                }],
                body,
                styles: {
                    font: baseFont,
                    fontSize: 8,
                    cellPadding: 4,
                    overflow: 'linebreak'
                },
                headStyles: {
                    fillColor: [99, 102, 241],
                    textColor: 255,
                    fontStyle: 'bold',
                    fontSize: 8
                },
                alternateRowStyles: {
                    fillColor: [248, 249, 252]
                },
                columnStyles: {
                    idx: {
                        cellWidth: 18,
                        halign: 'center'
                    },
                    type: {
                        cellWidth: 42
                    },
                    date: {
                        cellWidth: 60,
                        halign: 'left'
                    },
                    category: {
                        cellWidth: 55
                    },
                    description: {
                        cellWidth: 'auto',
                        minCellWidth: 80
                    },
                    user: {
                        cellWidth: 45
                    },
                    amountDisplay: {
                        cellWidth: 58,
                        halign: 'right'
                    },
                    usd: {
                        cellWidth: 42,
                        halign: 'right'
                    }
                },
                margin: {
                    left: 24,
                    right: 24
                },
                tableWidth: 'auto',
                didParseCell: (data) => {
                    if (data.section === 'body' && data.column.dataKey === 'amountDisplay') {
                        const isIncome = data.row.raw.type === 'income';
                        data.cell.styles.textColor = isIncome ? [22, 163, 74] : [220, 38, 38];
                    }
                }
            });

            addPageNumbers(doc, baseFont);
            const filename = `theansou_history_export_${new Date().toISOString().split('T')[0]}.pdf`;
            forcePdfDownload(doc, filename);
            showMessage(`Successfully exported ${filteredData.length} transactions to PDF!`, 'success');
        }

        // ---------------------------
        // CRUD (Firebase Firestore) 
        // ---------------------------

        // Toast notification for save success
        function showSaveToast(message = 'Saved successfully') {
            const container = document.getElementById('toast-container');
            // Remove any existing toasts
            container.innerHTML = '';

            const toast = document.createElement('div');
            toast.className = 'toast toast-success';
            toast.innerHTML = `
                <i class="fas fa-check-circle toast-icon"></i>
                <span class="toast-message">${message}</span>
            `;
            container.appendChild(toast);

            // Auto dismiss after 2.5 seconds
            setTimeout(() => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 250);
            }, 2500);
        }

        // Button success animation
        function animateButtonSuccess(buttonId, originalText) {
            const btn = document.getElementById(buttonId);
            if (!btn) return;

            // Add success animation class
            btn.classList.add('btn-success-animate', 'btn-success-state');
            btn.innerHTML = '<i class="fas fa-check mr-2"></i> Saved!';

            // Reset after animation
            setTimeout(() => {
                btn.classList.remove('btn-success-animate', 'btn-success-state');
                btn.textContent = originalText;
            }, 1500);
        }

        async function saveExpense(expenseData) {
            if (!db) return showMessage('Database not connected.', 'error');
            if (!currentUser) return showMessage('Error: You must be signed in to save an expense.', 'error');

            const isNew = !expenseData.id;
            const submitBtn = document.getElementById('submit-button');
            const originalText = submitBtn.textContent;

            // Show saving state
            submitBtn.classList.add('btn-saving');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            const dataToSave = {
                amount: parseFloat(expenseData.amount),
                currency: expenseData.currency,
                date: expenseData.date,
                category: expenseData.category.trim(),
                description: expenseData.description || '',
                user: expenseData.user || 'Self',
                userId: currentUser.uid,
                userEmail: currentUser.email || '',
                groupId: currentUser.uid
            };

            try {
                if (isNew) {
                    await db.collection('expenses').add(dataToSave);
                } else {
                    await db.collection('expenses').doc(expenseData.id).update(dataToSave);
                }

                // Success feedback
                submitBtn.classList.remove('btn-saving');
                showSaveToast(isNew ? 'Expense saved!' : 'Expense updated!');
                animateButtonSuccess('submit-button', 'Save');
                resetForm();

            } catch (err) {
                console.error("Firestore save error:", err);
                submitBtn.classList.remove('btn-saving');
                submitBtn.textContent = originalText;
                showMessage('Error: ' + err.message, 'error');
            }
        }

        async function deleteExpense(id) {
            if (!db) return showMessage('Database not connected.', 'error');
            if (!currentUser) return showMessage('Error: You must be signed in to delete an expense.', 'error');
            try {
                await db.collection('expenses').doc(id).delete();
                showMessage("Expense deleted successfully!", 'success');
            } catch (err) {
                console.error("Firestore delete error:", err);
                showMessage('Error: ' + err.message, 'error');
            }
        }

        async function saveIncome(incomeData) {
            if (!db) return showMessage('Database not connected.', 'error');
            if (!currentUser) return showMessage('Error: You must be signed in to save an income.', 'error');

            const isNew = !incomeData.id;
            const submitBtn = document.getElementById('income-submit-button');
            const originalText = submitBtn.textContent;

            // Show saving state
            submitBtn.classList.add('btn-saving');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Saving...';

            const dataToSave = {
                amount: parseFloat(incomeData.amount),
                currency: incomeData.currency,
                date: incomeData.date,
                source: incomeData.source,
                description: incomeData.description || '',
                user: incomeData.user || 'Self',
                userId: currentUser.uid,
                userEmail: currentUser.email || '',
                groupId: currentUser.uid
            };

            if (isNew) {
                dataToSave.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            }

            try {
                if (isNew) {
                    await db.collection('incomes').add(dataToSave);
                } else {
                    await db.collection('incomes').doc(incomeData.id).update(dataToSave);
                }

                // Success feedback
                submitBtn.classList.remove('btn-saving');
                showSaveToast(isNew ? 'Income saved!' : 'Income updated!');
                animateButtonSuccess('income-submit-button', 'Save');
                resetIncomeForm();

            } catch (err) {
                console.error("Firestore save income error:", err);
                submitBtn.classList.remove('btn-saving');
                submitBtn.textContent = originalText;
                showMessage('Error: ' + err.message, 'error');
            }
        }

        async function deleteIncome(id) {
            if (!db) return showMessage('Database not connected.', 'error');
            if (!currentUser) return showMessage('Error: You must be signed in to delete an income.', 'error');
            try {
                await db.collection('incomes').doc(id).delete();
                showMessage("Income deleted successfully!", 'success');
            } catch (err) {
                console.error("Firestore delete income error:", err);
                showMessage('Error: ' + err.message, 'error');
            }
        }

        // --------------------------- 
        // Data Migration Functions
        // ---------------------------
        async function migrateUserData(silent = false) {
            if (!db) {
                if (!silent) showMessage('Database not connected.', 'error');
                return;
            }
            if (!currentUser) {
                if (!silent) showMessage('Error: You must be signed in to migrate data.', 'error');
                return;
            }

            try {
                if (!silent) showMessage('Starting data migration...', 'info');
                let updatedCount = 0;

                // Update expenses with user = "theansea" to "Theansea"
                const expensesQuery = await db.collection('expenses').where('user', '==', 'theansea').get();
                const expensePromises = expensesQuery.docs.map(async(doc) => {
                    await doc.ref.update({
                        user: 'Theansea'
                    });
                    updatedCount++;
                });

                // Update incomes with user = "theansea" to "Theansea"  
                const incomesQuery = await db.collection('incomes').where('user', '==', 'theansea').get();
                const incomePromises = incomesQuery.docs.map(async(doc) => {
                    await doc.ref.update({
                        user: 'Theansea'
                    });
                    updatedCount++;
                });

                await Promise.all([...expensePromises, ...incomePromises]);

                if (updatedCount > 0) {
                    if (!silent) {
                        showMessage(`Data migration completed! Updated ${updatedCount} records.`, 'success');
                    } else {
                        console.log(`Data migration completed silently! Updated ${updatedCount} records.`);
                    }
                    // Refresh the data
                    updateUI();
                } else if (!silent) {
                    showMessage('No data needed migration.', 'info');
                }

            } catch (err) {
                console.error("Data migration error:", err);
                if (!silent) showMessage('Migration failed: ' + err.message, 'error');
            }
        }

        // ---------------------------
        // UI Rendering 
        // ---------------------------
        function populateCategories() {
            const categoryDatalist = document.getElementById('category-options');
            const filterCategorySelect = document.getElementById('filter-category');
            const allCategories = new Set(CATEGORIES.concat(expenses.map(e => e.category).filter(Boolean)));
            const sortedCategories = Array.from(allCategories).sort();

            categoryDatalist.innerHTML = '';
            sortedCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                categoryDatalist.appendChild(opt);
            });

            const savedFilter = filterCategorySelect.value;
            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            sortedCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                filterCategorySelect.appendChild(opt);
            });
            filterCategorySelect.value = sortedCategories.includes(savedFilter) ? savedFilter : '';
        }

        function populateUserFilter() {
            const userFilterSelect = document.getElementById('filter-user');
            const uniqueUsers = new Set(expenses.map(e => e.user).filter(Boolean));
            const sortedUsers = Array.from(uniqueUsers).sort();
            const savedValue = userFilterSelect.value;

            userFilterSelect.innerHTML = '<option value="">All Users</option>';
            sortedUsers.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                userFilterSelect.appendChild(opt);
            });
            userFilterSelect.value = sortedUsers.includes(savedValue) ? savedValue : '';
        }

        function populateMonthFilter() {
            const monthFilterSelect = document.getElementById('filter-month');
            const uniqueMonths = getUniqueMonths(expenses);
            const savedValue = monthFilterSelect.value || currentFilters.month;

            monthFilterSelect.innerHTML = '<option value="">All Months</option>';
            uniqueMonths.forEach(monthKey => {
                const opt = document.createElement('option');
                opt.value = monthKey;
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1, 1);
                opt.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long'
                });
                monthFilterSelect.appendChild(opt);
            });
            monthFilterSelect.value = uniqueMonths.includes(savedValue) ? savedValue : (uniqueMonths.includes(currentFilters.month) ? currentFilters.month : '');
        }

        function populateHistoryCategories() {
            const filterCategorySelect = document.getElementById('history-filter-category');
            const allCategories = new Set([
                ...CATEGORIES,
                ...expenses.map(e => e.category).filter(Boolean),
                ...incomes.map(i => i.source).filter(Boolean)
            ]);
            const sortedCategories = Array.from(allCategories).sort();
            const savedValue = filterCategorySelect.value;

            filterCategorySelect.innerHTML = '<option value="">All Categories</option>';
            sortedCategories.forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                filterCategorySelect.appendChild(opt);
            });
            filterCategorySelect.value = sortedCategories.includes(savedValue) ? savedValue : '';
        }

        function populateHistoryUserFilter() {
            const userFilterSelect = document.getElementById('history-filter-user');
            const uniqueUsers = new Set([
                ...expenses.map(e => e.user).filter(Boolean),
                ...incomes.map(i => i.user).filter(Boolean)
            ]);
            const sortedUsers = Array.from(uniqueUsers).sort();
            const savedValue = userFilterSelect.value;

            userFilterSelect.innerHTML = '<option value="">All Users</option>';
            sortedUsers.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                userFilterSelect.appendChild(opt);
            });
            userFilterSelect.value = sortedUsers.includes(savedValue) ? savedValue : '';
        }

        function populateHistoryMonthFilter() {
            const monthFilterSelect = document.getElementById('history-filter-month');
            const allData = [...expenses, ...incomes];
            const uniqueMonths = getUniqueMonths(allData);
            const savedValue = monthFilterSelect.value || currentHistoryFilters.month;

            monthFilterSelect.innerHTML = '<option value="">All Months</option>';
            uniqueMonths.forEach(monthKey => {
                const opt = document.createElement('option');
                opt.value = monthKey;
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1, 1);
                opt.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long'
                });
                monthFilterSelect.appendChild(opt);
            });
            monthFilterSelect.value = uniqueMonths.includes(savedValue) ? savedValue : (uniqueMonths.includes(currentHistoryFilters.month) ? currentHistoryFilters.month : '');
        }

        function populateIncomeSources() {
            const filterSourceSelect = document.getElementById('filter-income-source');
            const sources = ['salary', 'business', 'bonus', 'other'];
            const savedValue = filterSourceSelect.value;

            filterSourceSelect.innerHTML = '<option value="">All Sources</option>';
            sources.forEach(src => {
                const opt = document.createElement('option');
                opt.value = src;
                opt.textContent = src.charAt(0).toUpperCase() + src.slice(1);
                filterSourceSelect.appendChild(opt);
            });
            filterSourceSelect.value = sources.includes(savedValue) ? savedValue : '';
        }

        function populateIncomeUserFilter() {
            const userFilterSelect = document.getElementById('filter-income-user');
            const uniqueUsers = new Set(incomes.map(i => i.user).filter(Boolean));
            const sortedUsers = Array.from(uniqueUsers).sort();
            const savedValue = userFilterSelect.value;

            userFilterSelect.innerHTML = '<option value="">All Users</option>';
            sortedUsers.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u;
                opt.textContent = u;
                userFilterSelect.appendChild(opt);
            });
            userFilterSelect.value = sortedUsers.includes(savedValue) ? savedValue : '';
        }

        function populateIncomeMonthFilter() {
            const monthFilterSelect = document.getElementById('filter-income-month');
            const uniqueMonths = getUniqueMonths(incomes);
            const savedValue = monthFilterSelect.value;

            monthFilterSelect.innerHTML = '<option value="">Select Month</option>';
            uniqueMonths.forEach(monthKey => {
                const opt = document.createElement('option');
                opt.value = monthKey;
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1, 1);
                opt.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long'
                });
                monthFilterSelect.appendChild(opt);
            });
            monthFilterSelect.value = uniqueMonths.includes(savedValue) ? savedValue : '';
        }

        function getFilteredAndSortedExpenses(data) {
            let filtered = data.slice();
            const {
                category,
                user,
                startDate,
                endDate,
                description,
                month,
                sortBy
            } = currentFilters;

            let filterStart = startDate ? new Date(startDate) : null;
            let filterEnd = endDate ? new Date(endDate) : null;
            if (filterStart) filterStart.setHours(0, 0, 0, 0);
            if (filterEnd) filterEnd.setHours(23, 59, 59, 999);

            // Use startDate and endDate as priority
            if ((!startDate && !endDate) && month) {
                const [year, mon] = month.split('-');
                const lastDay = new Date(year, mon, 0).getDate();
                filterStart = new Date(`${month}-01`);
                filterStart.setHours(0, 0, 0, 0);
                filterEnd = new Date(`${month}-${lastDay.toString().padStart(2, '0')}`);
                filterEnd.setHours(23, 59, 59, 999);
            }

            filtered = filtered.filter(e => {
                let dateMatch = true;
                if (filterStart || filterEnd) {
                    const recDate = new Date(e.date);
                    recDate.setHours(12, 0, 0, 0); // avoid timezone issues
                    if (filterStart && recDate < filterStart) dateMatch = false;
                    if (filterEnd && recDate > filterEnd) dateMatch = false;
                }
                const categoryMatch = !category || e.category === category;
                const userMatch = !user || e.user === user;
                const descMatch = !description || e.description.toLowerCase().includes(description.toLowerCase());
                return dateMatch && categoryMatch && userMatch && descMatch;
            });

            const [field, direction] = sortBy.split('-');
            filtered.sort((a, b) => {
                let valA = field === 'amount' ? convertToUSD(a.amount, a.currency) : a[field];
                let valB = field === 'amount' ? convertToUSD(b.amount, b.currency) : b[field];

                if (field === 'amount' || field === 'date') {
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    const comparison = valA.localeCompare(valB);
                    return direction === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            return filtered;
        }

        function getFilteredAndSortedIncomes(data) {
            let filtered = data.slice();
            const {
                source,
                user,
                startDate,
                endDate,
                description,
                month,
                sortBy
            } = currentIncomeFilters;

            // Use startDate and endDate as priority
            if ((!startDate && !endDate) && month) {
                const [year, mon] = month.split('-');
                const lastDay = new Date(year, mon, 0).getDate();
                currentIncomeFilters.startDate = `${month}-01`;
                currentIncomeFilters.endDate = `${month}-${lastDay.toString().padStart(2, '0')}`;
            } else {
                // Clear date range when All Months is selected
                if (!month) {
                    currentIncomeFilters.startDate = '';
                    currentIncomeFilters.endDate = '';
                }
            }

            filtered = filtered.filter(i => {
                const dateMatch = (!currentIncomeFilters.startDate || i.date >= currentIncomeFilters.startDate) && (!currentIncomeFilters.endDate || i.date <= currentIncomeFilters.endDate);
                const sourceMatch = !source || i.source === source;
                const userMatch = !user || i.user === user;
                const descMatch = !description || i.description.toLowerCase().includes(description.toLowerCase());
                return dateMatch && sourceMatch && userMatch && descMatch;
            });

            const [field, direction] = sortBy.split('-');
            filtered.sort((a, b) => {
                let valA = field === 'amount' ? convertToUSD(a.amount, a.currency) : a[field];
                let valB = field === 'amount' ? convertToUSD(b.amount, b.currency) : b[field];

                if (field === 'amount' || field === 'date') {
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    const comparison = valA.localeCompare(valB);
                    return direction === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            return filtered;
        }

        function getFilteredAndSortedHistory(data) {
            let filtered = data.slice();
            const {
                type,
                category,
                user,
                startDate,
                endDate,
                description,
                month,
                sortBy
            } = currentHistoryFilters;

            // ប្រើ startDate និង endDate ជាអាទិភាព
            if ((!startDate && !endDate) && month) {
                const [year, mon] = month.split('-');
                const lastDay = new Date(year, mon, 0).getDate();
                currentHistoryFilters.startDate = `${month}-01`;
                currentHistoryFilters.endDate = `${month}-${lastDay.toString().padStart(2, '0')}`;
            } else {
                // Clear date range when All Months is selected
                if (!month) {
                    currentHistoryFilters.startDate = '';
                    currentHistoryFilters.endDate = '';
                }
            }

            filtered = filtered.filter(item => {
                const dateMatch = (!currentHistoryFilters.startDate || item.date >= currentHistoryFilters.startDate) && (!currentHistoryFilters.endDate || item.date <= currentHistoryFilters.endDate);
                const typeMatch = !type || item.type === type;
                const categoryMatch = !category || (item.category === category || item.source === category);
                const userMatch = !user || item.user === user;
                const descMatch = !description || item.description.toLowerCase().includes(description.toLowerCase());
                return dateMatch && typeMatch && categoryMatch && userMatch && descMatch;
            });

            const [field, direction] = sortBy.split('-');
            filtered.sort((a, b) => {
                let valA = field === 'amount' ? convertToUSD(a.amount, a.currency) : a[field];
                let valB = field === 'amount' ? convertToUSD(b.amount, b.currency) : b[field];

                if (field === 'amount' || field === 'date') {
                    if (valA < valB) return direction === 'asc' ? -1 : 1;
                    if (valA > valB) return direction === 'asc' ? 1 : -1;
                } else if (typeof valA === 'string' && typeof valB === 'string') {
                    const comparison = valA.localeCompare(valB);
                    return direction === 'asc' ? comparison : -comparison;
                }
                return 0;
            });

            return filtered;
        }

        function calculateTotalIncomeUSD(filteredData) {
            return filteredData.reduce((total, i) => total + convertToUSD(i.amount, i.currency), 0);
        }

        function renderExpenseCards(data) {
            const container = document.getElementById('expense-cards-container');
            const emptyState = document.getElementById('empty-state');
            const cardsTotalEl = document.getElementById('cards-total-amount-usd');
            const filteredData = getFilteredAndSortedExpenses(data);

            // Update cards total
            const totalUsd = calculateTotalIncomeUSD(filteredData);
            if (cardsTotalEl) cardsTotalEl.textContent = formatUSD(totalUsd);

            if (filteredData.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                container.querySelectorAll('.expense-card').forEach(card => card.remove());
                return;
            }

            if (emptyState) emptyState.classList.add('hidden');

            container.innerHTML = filteredData.map(expense => `
                <div class="expense-card bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-lg transition-all duration-200">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="text-xl font-bold text-gray-900">${parseFloat(expense.amount).toLocaleString()} ${expense.currency === 'KHR' ? '៛' : '$'}</span>
                                <span class="text-sm text-gray-500">${expense.date}</span>
                                <span class="text-sm font-medium text-indigo-600 bg-indigo-100 px-2.5 py-1 rounded-full">${expense.user || 'Self'}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-sm font-semibold text-gray-700">${expense.category}</span>
                                ${expense.description ? `<span class="text-sm text-gray-500">• ${expense.description}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="editExpense('${expense.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-600 p-2.5 rounded-xl text-sm transition-colors" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteModal('${expense.id}')" class="bg-red-100 hover:bg-red-200 text-red-600 p-2.5 rounded-xl text-sm transition-colors" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderExpenseTable(data) {
            const tbody = document.getElementById('expense-table-body');
            const totalUsdEl = document.getElementById('total-amount-usd');
            const filteredData = getFilteredAndSortedExpenses(data);

            // Render cards for mobile (do this first for faster visual feedback)
            renderExpenseCards(data);

            // Populate filters in background (non-blocking)
            requestAnimationFrame(() => {
                populateCategories();
                populateUserFilter();
                populateMonthFilter();
            });

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 bg-white/10 rounded-lg">No expenses matching filters or no data yet.</td></tr>';
                if (totalUsdEl) totalUsdEl.textContent = formatUSD(0);
                return;
            }

            tbody.innerHTML = filteredData.map(expense => `
                <tr class="hover:bg-white/30 transition duration-150">
                <td class="px-4 py-3 text-sm text-gray-800">${expense.date}</td>
                <td class="px-4 py-3 text-sm font-bold" style="color: #2D3748;">${formatUSD(convertToUSD(expense.amount, expense.currency))} <span class="text-xs text-gray-500 font-normal">(${parseFloat(expense.amount).toFixed(2)} ${expense.currency})</span></td>
                <td class="px-4 py-3 text-sm text-gray-800"><span class="bg-indigo-100/50 text-indigo-800 px-2 py-1 rounded-md text-xs font-semibold border border-indigo-200">${expense.category}</span></td>
                <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate">${expense.description || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-800 font-medium">${expense.user || 'Self'}</td>
                <td class="px-4 py-3 text-right text-sm space-x-2">
                    <button onclick="editExpense('${expense.id}')" class="text-indigo-600 hover:text-indigo-800 font-medium hover:underline">Edit</button>
                    <button onclick="showDeleteModal('${expense.id}')" class="text-red-500 hover:text-red-700 font-medium hover:underline">Delete</button>
                </td>
                </tr>
            `).join('');

            const totalUsd = calculateTotalIncomeUSD(filteredData);
            if (totalUsdEl) totalUsdEl.textContent = formatUSD(totalUsd);
        }

        function renderIncomeCards(data) {
            const container = document.getElementById('income-cards-container');
            const emptyState = document.getElementById('income-empty-state');
            const cardsTotalEl = document.getElementById('cards-total-income-usd');
            const filteredData = getFilteredAndSortedIncomes(data);

            // Update cards total
            const totalUsd = calculateTotalIncomeUSD(filteredData);
            if (cardsTotalEl) cardsTotalEl.textContent = formatUSD(totalUsd);

            if (filteredData.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                container.querySelectorAll('.income-card').forEach(card => card.remove());
                return;
            }

            if (emptyState) emptyState.classList.add('hidden');

            container.innerHTML = filteredData.map(income => `
                <div class="income-card bg-white/90 backdrop-blur-sm rounded-2xl shadow-md hover:shadow-lg transition-all duration-200">
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 flex-wrap">
                                <span class="text-xl font-bold text-green-600">${parseFloat(income.amount).toLocaleString()} ${income.currency === 'KHR' ? '៛' : '$'}</span>
                                <span class="text-sm text-gray-500">${income.date}</span>
                                <span class="text-sm font-medium text-green-600 bg-green-100 px-2.5 py-1 rounded-full">${income.user || 'Self'}</span>
                            </div>
                            <div class="flex items-center gap-2 mt-2">
                                <span class="text-sm font-semibold text-gray-700">${income.source.charAt(0).toUpperCase() + income.source.slice(1)}</span>
                                ${income.description ? `<span class="text-sm text-gray-500">• ${income.description}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 ml-4">
                            <button onclick="editIncome('${income.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-600 p-2.5 rounded-xl text-sm transition-colors" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="showDeleteIncomeModal('${income.id}')" class="bg-red-100 hover:bg-red-200 text-red-600 p-2.5 rounded-xl text-sm transition-colors" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderIncomeTable(data) {
            console.log('Rendering income table with', data.length, 'raw items');
            const tbody = document.getElementById('income-table-body');
            const totalUsdEl = document.getElementById('total-income-usd');
            const filteredData = getFilteredAndSortedIncomes(data);

            populateIncomeSources();
            populateIncomeUserFilter();
            populateIncomeMonthFilter();

            // Render cards for mobile
            renderIncomeCards(data);

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 bg-white/10 rounded-lg">No incomes matching filters or no data yet.</td></tr>';
                totalUsdEl.textContent = formatUSD(0);
                return;
            }

            const isNewEntry = (income) => {
                if (!income.createdAt) return false;
                const now = new Date();
                const diffHours = (now - income.createdAt) / (1000 * 60 * 60);
                return diffHours <= 24; // New if created within last 24 hours
            };

            tbody.innerHTML = filteredData.map(income => `
               <tr class="hover:bg-white/40 transition duration-150 border-b border-gray-100/50 ${isNewEntry(income) ? 'bg-blue-50/50' : ''}">
    <td class="px-4 py-3 text-sm text-gray-900 font-semibold">${income.date}</td>
    
    <td class="px-4 py-3 text-sm font-bold ${isNewEntry(income) ? 'text-blue-800' : 'text-blue-700'}">
        ${formatUSD(convertToUSD(income.amount, income.currency))} 
        <span class="text-xs text-gray-500 font-normal">(${parseFloat(income.amount).toFixed(2)} ${income.currency})</span>
        ${isNewEntry(income) ? '<span class="ml-1 text-xs bg-blue-200 text-blue-900 px-1 py-0.5 rounded font-bold">NEW</span>' : ''}
    </td>
    
    <td class="px-4 py-3 text-sm">
        <span class="bg-green-100 text-green-800 px-2 py-1 rounded-md text-xs font-bold border border-green-200">
            ${income.source.charAt(0).toUpperCase() + income.source.slice(1)}
        </span>
    </td>
    
    <td class="px-4 py-3 text-sm text-gray-800 max-w-xs truncate font-medium">
        ${income.description || '-'}
    </td>
    
    <td class="px-4 py-3 text-sm text-gray-800 font-bold">
        ${income.user || 'Self'}
    </td>
    
    <td class="px-4 py-3 text-right text-sm space-x-2">
        <button onclick="editIncome('${income.id}')" class="text-blue-600 hover:text-blue-800 font-semibold hover:underline">Edit</button>
        <button onclick="showDeleteIncomeModal('${income.id}')" class="text-red-500 hover:text-red-700 font-semibold hover:underline">Delete</button>
    </td>
</tr>
            `).join('');

            const totalUsd = calculateTotalIncomeUSD(filteredData);
            totalUsdEl.textContent = formatUSD(totalUsd);
        }

        function renderHistoryCards(data) {
            const container = document.getElementById('history-cards-container');
            const emptyState = document.getElementById('history-empty-state');
            const filteredData = getFilteredAndSortedHistory(data);

            if (filteredData.length === 0) {
                if (emptyState) emptyState.classList.remove('hidden');
                container.querySelectorAll('.history-card').forEach(card => card.remove());
                return;
            }

            if (emptyState) emptyState.classList.add('hidden');

            // Calculate totals for mobile card view
            const totalExpenseCount = filteredData.filter(item => item.type === 'expense').length;
            const totalIncomeCount = filteredData.filter(item => item.type === 'income').length;
            const totalExpenseAmount = filteredData.filter(item => item.type === 'expense').reduce((sum, item) => sum + convertToUSD(item.amount, item.currency), 0);
            const totalIncomeAmount = filteredData.filter(item => item.type === 'income').reduce((sum, item) => sum + convertToUSD(item.amount, item.currency), 0);
            const netAmount = totalIncomeAmount - totalExpenseAmount;

            const cardsHtml = filteredData.map(item => {
                const isExpense = item.type === 'expense';
                const borderColor = isExpense ? 'border-red-500' : 'border-green-500';
                const bgColor = isExpense ? 'bg-red-50' : 'bg-green-50';
                const textColor = isExpense ? 'text-red-600' : 'text-green-600';
                const typeLabel = isExpense ? 'Expense' : 'Income';
                const typeBadgeColor = isExpense ? 'bg-red-500' : 'bg-green-500';
                return `
                    <div class="history-card bg-white/70 backdrop-blur-sm rounded-xl p-3 border-l-4 ${borderColor} shadow-md hover:shadow-lg transition-all duration-200">
                        <div class="flex justify-between items-start mb-2">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ${typeBadgeColor} text-white">
                                        ${typeLabel}
                                    </span>
                                </div>
                                <div class="text-xl font-bold ${textColor}">
                                    ${parseFloat(item.amount).toLocaleString()} ${item.currency === 'KHR' ? '៛' : '$'}
                                </div>
                                <div class="text-xs text-gray-500 mt-0.5">${item.date}</div>
                            </div>
                            <div class="text-xs font-semibold ${textColor} ${bgColor} px-2 py-1 rounded-full">
                                ${item.user || 'Self'}
                            </div>
                        </div>
                        <div class="text-sm font-semibold text-gray-700">${item.category || item.source}</div>
                        ${item.description ? `<div class="text-xs text-gray-600 mt-0.5">${item.description}</div>` : ''}
                    </div>
                `;
            }).join('');

            // Totals summary for mobile (show at bottom)
            const summaryHtml = `
                <div class="history-mobile-summary rounded-xl p-4 mt-4 text-sm font-semibold shadow border">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 font-bold text-sm">
                            <i class="fas fa-arrow-down mr-1"></i> Expense: ${totalExpenseCount}
                        </span>
                        <span class="ml-auto text-red-400 font-bold">${formatUSD(totalExpenseAmount)}</span>
                    </div>
                    <div class="flex items-center gap-2 mb-2">
                        <span class="px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 font-bold text-sm">
                            <i class="fas fa-arrow-up mr-1"></i> Income: ${totalIncomeCount}
                        </span>
                        <span class="ml-auto text-green-400 font-bold">${formatUSD(totalIncomeAmount)}</span>
                    </div>
                    <div class="flex items-center justify-between pt-2 border-t border-current/20">
                        <span class="font-bold">Net Balance:</span>
                        <span class="px-4 py-2 rounded-xl ${netAmount >= 0 ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} font-bold text-lg">
                            ${formatUSD(netAmount)}
                        </span>
                    </div>
                </div>
            `;
            container.innerHTML = cardsHtml + summaryHtml;
        }

        function renderHistoryTable() {
            const tbody = document.getElementById('history-table-body');
            const combinedData = [
                ...expenses.map(e => ({...e,
                    type: 'expense'
                })),
                ...incomes.map(i => ({...i,
                    type: 'income'
                }))
            ];
            const filteredData = getFilteredAndSortedHistory(combinedData);

            populateHistoryCategories();
            populateHistoryUserFilter();
            populateHistoryMonthFilter();

            // Render cards for mobile
            renderHistoryCards(combinedData);

            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-500 bg-white/10 rounded-lg">No transactions matching filters or no data yet.</td></tr>';
                document.getElementById('history-total-count').textContent = '0 transactions';
                document.getElementById('history-total-amount').textContent = formatUSD(0);
                return;
            }

            tbody.innerHTML = filteredData.map(item => {
                const isExpense = item.type === 'expense';
                const amountColor = isExpense ? 'text-red-600' : 'text-green-600';
                const categoryColor = isExpense ? 'bg-red-100 text-red-800 border-red-200' : 'bg-green-100 text-green-800 border-green-200';
                const typeLabel = isExpense ? 'Expense' : 'Income';
                const typeColor = isExpense ? 'bg-red-500' : 'bg-green-500';

                return `
                    <tr class="hover:bg-white/30 transition duration-150">
                        <td class="px-4 py-3 text-sm">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${typeColor} text-white">
                                ${typeLabel}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-800">${item.date}</td>
                        <td class="px-4 py-3 text-sm font-bold ${amountColor} amount-cell">${formatUSD(convertToUSD(item.amount, item.currency))} <span class="text-xs text-gray-500 font-normal">(${parseFloat(item.amount).toFixed(2)} ${item.currency})</span></td>
                        <td class="px-4 py-3 text-sm text-gray-800 category-cell"><span class="px-2 py-1 rounded-md text-xs font-semibold border ${categoryColor}">${item.category || item.source}</span></td>
                        <td class="px-4 py-3 text-sm text-gray-900 max-w-xs truncate desc-cell">${item.description || '-'}</td>
                        <td class="px-4 py-3 text-sm text-gray-800 font-medium">${item.user || 'Self'}</td>
                    </tr>
                `;
            }).join('');

            // Calculate and display totals (split Expense/Income) - only up to selected end date
            let filterEnd = null;
            if (currentHistoryFilters.endDate) {
                filterEnd = new Date(currentHistoryFilters.endDate);
                filterEnd.setHours(23, 59, 59, 999);
            }
            const totalExpenseCount = filteredData.filter(item => item.type === 'expense').length;
            const totalIncomeCount = filteredData.filter(item => item.type === 'income').length;
            const totalExpenseAmount = filteredData.filter(item => {
                if (item.type !== 'expense') return false;
                if (filterEnd) {
                    const recDate = new Date(item.date);
                    recDate.setHours(12, 0, 0, 0);
                    return recDate <= filterEnd;
                }
                return true;
            }).reduce((sum, item) => sum + convertToUSD(item.amount, item.currency), 0);
            const totalIncomeAmount = filteredData.filter(item => {
                if (item.type !== 'income') return false;
                if (filterEnd) {
                    const recDate = new Date(item.date);
                    recDate.setHours(12, 0, 0, 0);
                    return recDate <= filterEnd;
                }
                return true;
            }).reduce((sum, item) => sum + convertToUSD(item.amount, item.currency), 0);
            const netAmount = totalIncomeAmount - totalExpenseAmount;

            // Update footer cells with improved design
            document.getElementById('history-total-count').innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="px-3 py-1.5 rounded-lg bg-red-500/20 text-red-400 font-bold text-sm">
                        <i class="fas fa-arrow-down mr-1"></i> Expense: ${totalExpenseCount}
                    </span>
                    <span class="px-3 py-1.5 rounded-lg bg-green-500/20 text-green-400 font-bold text-sm">
                        <i class="fas fa-arrow-up mr-1"></i> Income: ${totalIncomeCount}
                    </span>
                </div>
            `;
            document.getElementById('history-total-amount').innerHTML = `
                <div class="flex items-center gap-4">
                    <span class="text-red-400 font-bold">
                        <i class="fas fa-minus-circle mr-1"></i> ${formatUSD(totalExpenseAmount)}
                    </span>
                    <span class="text-green-400 font-bold">
                        <i class="fas fa-plus-circle mr-1"></i> ${formatUSD(totalIncomeAmount)}
                    </span>
                    <span class="px-4 py-2 rounded-xl ${netAmount >= 0 ? 'bg-blue-500/20 text-blue-400' : 'bg-orange-500/20 text-orange-400'} font-bold text-lg">
                        Net: ${formatUSD(netAmount)}
                    </span>
                </div>
            `;
        }

        // ---------------------------
        // Modal & Form 
        // ---------------------------
        function showDeleteModal(id) {
            deleteId = id;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
            }, 10);
        }

        function hideDeleteModal() {
            deleteId = null;
            const modal = document.getElementById('delete-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function showDeleteIncomeModal(id) {
            deleteIncomeId = id;
            const modal = document.getElementById('delete-income-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
            }, 10);
        }

        function hideDeleteIncomeModal() {
            deleteIncomeId = null;
            const modal = document.getElementById('delete-income-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        function resetForm() {
            document.getElementById('expense-form').reset();
            document.getElementById('expense-id').value = '';
            document.getElementById('form-title').innerHTML = '<span class="mr-2 text-3xl">📝</span> Add Expense';
            document.getElementById('submit-button').textContent = 'Save';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('currency').value = 'KHR';
            document.getElementById('category').value = '';
            
            // Reset user selector to compact view with auto-selected user
            const userValue = getAutoSelectedUser();
            if (userValue) {
                document.getElementById('user').value = userValue;
                showUserCompactView('user', userValue);
            } else {
                document.getElementById('user-display-text').textContent = 'Select User...';
            }
        }

        function resetIncomeForm() {
            document.getElementById('income-form').reset();
            document.getElementById('income-id').value = '';
            document.getElementById('income-form-title').innerHTML = '<span class="mr-2 text-3xl">💰</span> Add Income';
            document.getElementById('income-submit-button').textContent = 'Save';
            document.getElementById('income-cancel-edit-button').classList.add('hidden');
            document.getElementById('income-date').value = new Date().toISOString().split('T')[0];
            document.getElementById('income-currency').value = 'KHR';
            document.getElementById('income-source').value = '';
            
            // Reset user selector to compact view with auto-selected user
            const userValue = getAutoSelectedUser();
            if (userValue) {
                document.getElementById('income-user').value = userValue;
                showUserCompactView('income-user', userValue);
            } else {
                document.getElementById('income-user-display-text').textContent = 'Select User...';
            }
        }
        
        // Get the auto-selected user based on usage frequency stored in localStorage
        function getAutoSelectedUser() {
            const lastUser = localStorage.getItem('lastSelectedUser');
            const userUsage = JSON.parse(localStorage.getItem('userUsageCount') || '{}');
            
            // If there's a last selected user and it exists, use it
            if (lastUser) {
                return lastUser;
            }
            
            // Otherwise, find the most frequently used user
            const entries = Object.entries(userUsage);
            if (entries.length > 0) {
                entries.sort((a, b) => b[1] - a[1]); // Sort by usage count descending
                return entries[0][0]; // Return most used user
            }
            
            // If no user history, return null to trigger first-time setup
            return null;
        }
        
        // Track user usage for auto-selection
        function trackUserUsage(userName) {
            if (!userName) return;
            
            // Save as last selected user
            localStorage.setItem('lastSelectedUser', userName);
            
            // Increment usage count
            const userUsage = JSON.parse(localStorage.getItem('userUsageCount') || '{}');
            userUsage[userName] = (userUsage[userName] || 0) + 1;
            localStorage.setItem('userUsageCount', JSON.stringify(userUsage));
        }
        
        // Check if first-time user needs to set up their name
        function isFirstTimeUser() {
            const savedUsers = localStorage.getItem('customUsers');
            const lastUser = localStorage.getItem('lastSelectedUser');
            return !savedUsers && !lastUser;
        }
        
        // Show first-time user modal to prompt for name
        function showFirstTimeUserModal() {
            const addUserModal = document.getElementById('add-user-modal');
            const addUserInput = document.getElementById('add-user-input');
            const addUserError = document.getElementById('add-user-error');
            const modalTitle = addUserModal?.querySelector('h3');
            
            if (addUserModal && addUserInput) {
                // Update modal title for first-time user
                if (modalTitle) {
                    modalTitle.textContent = 'Enter Your Name';
                }
                addUserInput.value = '';
                addUserInput.placeholder = 'Enter name...';
                if (addUserError) addUserError.textContent = '';
                addUserModal.classList.add('active');
                addUserModal.style.display = 'flex';
                setTimeout(() => addUserInput.focus(), 100);
            }
        }
        
        // Show compact user view
        function showUserCompactView(selectId, userValue) {
            const isIncome = selectId.startsWith('income');
            const compactView = document.getElementById(isIncome ? 'income-user-compact-view' : 'user-compact-view');
            const selectEl = document.getElementById(selectId);
            const displayText = document.getElementById(isIncome ? 'income-user-display-text' : 'user-display-text');
            
            if (compactView && selectEl && displayText) {
                compactView.classList.remove('user-selector-hidden');
                selectEl.classList.add('user-selector-hidden');
                displayText.textContent = userValue;
            }
        }
        
        // Show full user selector
        function showUserFullSelector(selectId) {
            const isIncome = selectId.startsWith('income');
            const compactView = document.getElementById(isIncome ? 'income-user-compact-view' : 'user-compact-view');
            const selectEl = document.getElementById(selectId);
            
            if (compactView && selectEl) {
                compactView.classList.add('user-selector-hidden');
                selectEl.classList.remove('user-selector-hidden');
                selectEl.focus();
            }
        }
        
        // ===== USER PERSISTENCE FUNCTIONS =====
        // Save custom users to localStorage
        function saveCustomUsers() {
            const userSelect = document.getElementById('user');
            if (!userSelect) return;
            
            const customUsers = [];
            
            Array.from(userSelect.options).forEach(opt => {
                if (opt.value && opt.value !== '') {
                    customUsers.push(opt.value);
                }
            });
            
            localStorage.setItem('customUsers', JSON.stringify(customUsers));
            console.log('Saved custom users:', customUsers);
        }
        
        // Load custom users from localStorage and add to select dropdowns
        function loadCustomUsers() {
            const savedUsers = localStorage.getItem('customUsers');
            if (!savedUsers) return;
            
            try {
                const customUsers = JSON.parse(savedUsers);
                const userSelect = document.getElementById('user');
                const incomeUserSelect = document.getElementById('income-user');
                
                customUsers.forEach(userName => {
                    // Add to expense user select
                    if (userSelect && !Array.from(userSelect.options).some(opt => opt.value === userName)) {
                        const opt = document.createElement('option');
                        opt.value = userName;
                        opt.textContent = userName;
                        userSelect.appendChild(opt);
                    }
                    
                    // Add to income user select
                    if (incomeUserSelect && !Array.from(incomeUserSelect.options).some(opt => opt.value === userName)) {
                        const opt = document.createElement('option');
                        opt.value = userName;
                        opt.textContent = userName;
                        incomeUserSelect.appendChild(opt);
                    }
                });
                
                console.log('Loaded custom users:', customUsers);
            } catch (e) {
                console.error('Error loading custom users:', e);
            }
        }
        
        // Add user to both selects and save to localStorage
        function addUserToAllSelects(newUser) {
            const userSelect = document.getElementById('user');
            const incomeUserSelect = document.getElementById('income-user');
            
            // Add to expense user select
            if (userSelect && !Array.from(userSelect.options).some(opt => opt.value === newUser)) {
                const opt = document.createElement('option');
                opt.value = newUser;
                opt.textContent = newUser;
                userSelect.appendChild(opt);
            }
            
            // Add to income user select
            if (incomeUserSelect && !Array.from(incomeUserSelect.options).some(opt => opt.value === newUser)) {
                const opt = document.createElement('option');
                opt.value = newUser;
                opt.textContent = newUser;
                incomeUserSelect.appendChild(opt);
            }
            
            // Save to localStorage
            saveCustomUsers();
            
            // Update filters
            if (typeof populateUserFilter === 'function') populateUserFilter();
            if (typeof populateHistoryUserFilter === 'function') populateHistoryUserFilter();
            if (typeof populateIncomeUserFilter === 'function') populateIncomeUserFilter();
        }
        // ===== END USER PERSISTENCE FUNCTIONS =====
        
        // Initialize user selectors with auto-selection and event listeners
        function initializeUserSelectors() {
            // Modal elements for Add User (Expense)
            // Modal elements for Add User (Expense)
            const addUserModal = document.getElementById('add-user-modal');
            const addUserInput = document.getElementById('add-user-input');
            const addUserConfirm = document.getElementById('add-user-confirm');
            const addUserCancel = document.getElementById('add-user-cancel');
            const addUserError = document.getElementById('add-user-error');
            // Modal elements for Add User (Income)
            const addIncomeUserModal = document.getElementById('add-income-user-modal');
            const addIncomeUserInput = document.getElementById('add-income-user-input');
            const addIncomeUserConfirm = document.getElementById('add-income-user-confirm');
            const addIncomeUserCancel = document.getElementById('add-income-user-cancel');
            const addIncomeUserError = document.getElementById('add-income-user-error');
            // Get auto-selected user (will use currentUser when available)
            const autoUser = getAutoSelectedUser();
            // Setup expense form user selector
            const userSelect = document.getElementById('user');
            const changeUserBtn = document.getElementById('change-user-btn');
            const addUserBtn = document.getElementById('add-user-btn');
            // Setup income form user selector (declare before use!)
            const incomeUserSelect = document.getElementById('income-user');
            const incomeChangeUserBtn = document.getElementById('income-change-user-btn');
            const incomeAddUserBtn = document.getElementById('income-add-user-btn');
            
            // Check if first-time user - show modal to add their name
            if (isFirstTimeUser()) {
                setTimeout(() => {
                    showFirstTimeUserModal();
                }, 500);
            }
            
            if (userSelect && changeUserBtn) {
                if (autoUser) {
                    userSelect.value = autoUser;
                    showUserCompactView('user', autoUser);
                } else {
                    // Show placeholder if no user selected yet
                    document.getElementById('user-display-text').textContent = 'Select User...';
                }
                // Change button click handler
                changeUserBtn.addEventListener('click', () => {
                    showUserFullSelector('user');
                });
                // When user changes selection, update compact view and track usage
                userSelect.addEventListener('change', () => {
                    const newValue = userSelect.value;
                    showUserCompactView('user', newValue);
                    trackUserUsage(newValue);
                });
            }
            // Setup income form user selector
            if (incomeUserSelect && incomeChangeUserBtn) {
                if (autoUser) {
                    incomeUserSelect.value = autoUser;
                    showUserCompactView('income-user', autoUser);
                } else {
                    // Show placeholder if no user selected yet
                    document.getElementById('income-user-display-text').textContent = 'Select User...';
                }
                // Change button click handler
                incomeChangeUserBtn.addEventListener('click', () => {
                    showUserFullSelector('income-user');
                });
                // When user changes selection, update compact view and track usage
                incomeUserSelect.addEventListener('change', () => {
                    const newValue = incomeUserSelect.value;
                    showUserCompactView('income-user', newValue);
                    trackUserUsage(newValue);
                });
            }
            // Add user button logic (separate for expense and income)
            if (addUserBtn && userSelect && addUserInput && addUserError && addUserModal) {
                addUserBtn.addEventListener('click', () => {
                    addUserInput.value = '';
                    addUserError.textContent = '';
                    addUserModal.classList.add('active');
                    addUserModal.style.display = 'flex';
                    setTimeout(() => addUserInput.focus(), 100);
                });
            }
            if (incomeAddUserBtn && incomeUserSelect && addIncomeUserInput && addIncomeUserError && addIncomeUserModal) {
                incomeAddUserBtn.addEventListener('click', () => {
                    addIncomeUserInput.value = '';
                    addIncomeUserError.textContent = '';
                    addIncomeUserModal.classList.add('active');
                    addIncomeUserModal.style.display = 'flex';
                    setTimeout(() => addIncomeUserInput.focus(), 100);
                });
            }
            // Confirm add user (expense)
            if (addUserConfirm && addUserInput && addUserError && userSelect && addUserModal) {
                addUserConfirm.onclick = function() {
                    const newUser = addUserInput.value.trim();
                    if (!newUser) {
                        addUserError.textContent = 'Please enter a name';
                        addUserInput.focus();
                        return;
                    }
                    if (Array.from(userSelect.options).some(opt => opt.value && opt.value.toLowerCase() === newUser.toLowerCase())) {
                        addUserError.textContent = 'This name already exists';
                        addUserInput.focus();
                        return;
                    }
                    // Add user to both selects and save to localStorage
                    addUserToAllSelects(newUser);
                    userSelect.value = newUser;
                    showUserCompactView('user', newUser);
                    
                    // Also update income user selector
                    const incomeUserSelect = document.getElementById('income-user');
                    if (incomeUserSelect) {
                        incomeUserSelect.value = newUser;
                        showUserCompactView('income-user', newUser);
                    }
                    
                    // Track this user as the most recently used
                    trackUserUsage(newUser);
                    
                    addUserModal.classList.remove('active');
                    addUserModal.style.display = 'none';
                };
            }
            // Cancel add user (expense)
            if (addUserCancel && addUserModal) {
                addUserCancel.onclick = function() {
                    addUserModal.classList.remove('active');
                    addUserModal.style.display = 'none';
                };
            }
            if (addUserInput && addUserConfirm) {
                addUserInput.onkeydown = function(e) {
                    if (e.key === 'Enter') addUserConfirm.click();
                };
            }
            // Confirm add user (income)
            if (addIncomeUserConfirm && addIncomeUserInput && addIncomeUserError && incomeUserSelect && addIncomeUserModal) {
                addIncomeUserConfirm.onclick = function() {
                    const newUser = addIncomeUserInput.value.trim();
                    if (!newUser) {
                        addIncomeUserError.textContent = 'Please enter a name';
                        addIncomeUserInput.focus();
                        return;
                    }
                    if (Array.from(incomeUserSelect.options).some(opt => opt.value && opt.value.toLowerCase() === newUser.toLowerCase())) {
                        addIncomeUserError.textContent = 'This name already exists';
                        addIncomeUserInput.focus();
                        return;
                    }
                    // Add user to both selects and save to localStorage
                    addUserToAllSelects(newUser);
                    incomeUserSelect.value = newUser;
                    showUserCompactView('income-user', newUser);
                    
                    // Also update expense user selector
                    const userSelect = document.getElementById('user');
                    if (userSelect) {
                        userSelect.value = newUser;
                        showUserCompactView('user', newUser);
                    }
                    
                    // Track this user as the most recently used
                    trackUserUsage(newUser);
                    
                    addIncomeUserModal.classList.remove('active');
                    addIncomeUserModal.style.display = 'none';
                };
            }
            // Cancel add user (income)
            if (addIncomeUserCancel && addIncomeUserModal) {
                addIncomeUserCancel.onclick = function() {
                    addIncomeUserModal.classList.remove('active');
                    addIncomeUserModal.style.display = 'none';
                };
            }
            if (addIncomeUserInput && addIncomeUserConfirm) {
                addIncomeUserInput.onkeydown = function(e) {
                    if (e.key === 'Enter') addIncomeUserConfirm.click();
                };
            }
            // ...existing code for income user selector and add user logic...
        }
        
        // Update user selectors when user logs in (called after auth state change)
        function updateUserSelectorsAfterLogin() {
            const autoUser = getAutoSelectedUser();
            
            // Update expense user
            const userSelect = document.getElementById('user');
            if (userSelect) {
                if (autoUser) {
                    userSelect.value = autoUser;
                    showUserCompactView('user', autoUser);
                } else {
                    document.getElementById('user-display-text').textContent = 'Select User...';
                }
            }
            
            // Update income user
            const incomeUserSelect = document.getElementById('income-user');
            if (incomeUserSelect) {
                if (autoUser) {
                    incomeUserSelect.value = autoUser;
                    showUserCompactView('income-user', autoUser);
                } else {
                    document.getElementById('income-user-display-text').textContent = 'Select User...';
                }
            }
            
            // Check if first-time user
            if (isFirstTimeUser()) {
                setTimeout(() => {
                    showFirstTimeUserModal();
                }, 500);
            }
        }

        window.editExpense = (id) => {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return showMessage("Expense not found in cloud data.", 'error');

            document.getElementById('expense-id').value = expense.id;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('currency').value = expense.currency;
            document.getElementById('date').value = expense.date;
            document.getElementById('category').value = expense.category;
            document.getElementById('description').value = expense.description;
            document.getElementById('user').value = expense.user;
            
            // Show full selector when editing
            showUserFullSelector('user');

            document.getElementById('form-title').innerHTML = '<span class="mr-2 text-3xl">✏️</span> Edit Expense';
            document.getElementById('submit-button').textContent = 'Update';
            document.getElementById('cancel-edit-button').classList.remove('hidden');
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };

        window.editIncome = (id) => {
            const income = incomes.find(i => i.id === id);
            if (!income) return showMessage("Income not found in cloud data.", 'error');

            document.getElementById('income-id').value = income.id;
            document.getElementById('income-amount').value = income.amount;
            document.getElementById('income-currency').value = income.currency;
            document.getElementById('income-date').value = income.date;
            document.getElementById('income-source').value = income.source;
            document.getElementById('income-description').value = income.description;
            document.getElementById('income-user').value = income.user;
            
            // Show full selector when editing
            showUserFullSelector('income-user');

            document.getElementById('income-form-title').innerHTML = '<span class="mr-2 text-3xl">✏️</span> Edit Income';
            document.getElementById('income-submit-button').textContent = 'Update';
            document.getElementById('income-cancel-edit-button').classList.remove('hidden');
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        };

        // ---------------------------
        // Charts & Summary
        // ---------------------------

        function getUniqueMonths(data) {
            const monthKeys = new Set();
            data.forEach(e => {
                monthKeys.add(e.date.substring(0, 7));
            });
            return Array.from(monthKeys).sort().reverse();
        }

        function populateMonthSelect(months) {
            const select = document.getElementById('report-month-select');
            select.innerHTML = '';
            const container = document.getElementById('weekly-breakdown-container');

            if (months.length === 0) {
                select.innerHTML = '<option value="">No Data</option>';
                container.innerHTML = '<p class="text-gray-500">No data available for a monthly breakdown.</p>';
                return;
            }

            months.forEach(monthKey => {
                const opt = document.createElement('option');
                opt.value = monthKey;
                const [year, month] = monthKey.split('-');
                const date = new Date(year, month - 1, 1);
                opt.textContent = date.toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long'
                });
                select.appendChild(opt);
            });

            const latestMonthKey = months[0];
            if (latestMonthKey) {
                select.value = latestMonthKey;
            }

            renderWeeklyBreakdown(select.value);
        }

        function renderWeeklyBreakdown(monthKey) {
            const container = document.getElementById('weekly-breakdown-container');
            if (!monthKey) {
                container.innerHTML = `<p class="text-gray-500">Please select a month to view the weekly breakdown.</p>`;
                if (monthPieChart) monthPieChart.destroy();
                if (monthLineChart) monthLineChart.destroy();
                return;
            }
            const expensesInMonth = expenses.filter(e => e.date.startsWith(monthKey));

            if (expensesInMonth.length === 0) {
                container.innerHTML = `<p class="text-gray-500">No expenses recorded for the selected month.</p>`;
                if (monthPieChart) monthPieChart.destroy();
                if (monthLineChart) monthLineChart.destroy();
                return;
            }

            const weeklyTotals = {};
            const weeklyDetails = {};
            const monthCategoryBreakdown = {};
            const monthDailyTrend = {};
            let totalMonthExpense = 0;

            const incomesInMonth = incomes.filter(i => i.date.startsWith(monthKey));
            const currentMonth = new Date().toISOString().slice(0, 7);
            const currentMonthIncomes = incomes.filter(i => i.date.startsWith(currentMonth));
            let totalMonthIncome = 0;
            currentMonthIncomes.forEach(i => {
                totalMonthIncome += convertToUSD(i.amount, i.currency);
            });

            expensesInMonth.forEach(e => {
                const usd = convertToUSD(e.amount, e.currency);
                totalMonthExpense += usd;

                const dayOfMonth = new Date(e.date).getDate();
                const weekIndex = Math.min(Math.floor((dayOfMonth - 1) / 7) + 1, 5);
                const weekKey = `Week ${weekIndex}`;
                const dateKey = e.date;

                weeklyTotals[weekKey] = (weeklyTotals[weekKey] || 0) + usd;

                if (!weeklyDetails[weekKey]) {
                    weeklyDetails[weekKey] = {};
                }
                weeklyDetails[weekKey][e.category] = (weeklyDetails[weekKey][e.category] || 0) + usd;

                monthCategoryBreakdown[e.category] = (monthCategoryBreakdown[e.category] || 0) + usd;
                monthDailyTrend[dateKey] = (monthDailyTrend[dateKey] || 0) + usd;
            });

            const [year, month] = monthKey.split('-');
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let d = 1; d <= daysInMonth; d++) {
                const dateStr = `${monthKey}-${d.toString().padStart(2, '0')}`;
                if (monthDailyTrend[dateStr] === undefined) {
                    monthDailyTrend[dateStr] = 0;
                }
            }

            let html = `
                <div class="p-4 bg-indigo-50/50 rounded-xl border border-indigo-100 mb-6 monthly-summary-box">
                    <p class="text-lg font-medium text-gray-800">
                        Total Expense for selected month: <span class="text-red-600 font-bold text-2xl ml-2">${formatUSD(totalMonthExpense)}</span>
                    </p>
                    <p class="text-lg font-medium text-gray-800 mt-2">
                        Total Income for selected month: <span class="text-green-600 font-bold text-2xl ml-2">${formatUSD(totalMonthIncome)}</span>
                    </p>
                    <p class="text-lg font-medium text-gray-800 mt-2">
                        Net Balance for selected month: <span class="text-blue-600 font-bold text-2xl ml-2">${formatUSD(totalMonthIncome - totalMonthExpense)}</span>
                    </p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="month-chart-card p-5 rounded-2xl shadow-sm border">
                        <h4 class="text-lg font-semibold mb-3 chart-title">Monthly Categories</h4>
                        <div class="w-full h-72">
                            <canvas id="monthCategoryPieChart"></canvas>
                        </div>
                    </div>
                    <div class="month-chart-card p-5 rounded-2xl shadow-sm border">
                        <h4 class="text-lg font-semibold mb-3 chart-title">Monthly Trend</h4>
                        <canvas id="monthDailyLineChart"></canvas>
                    </div>
                </div>

                <h3 class="text-xl font-bold mb-4 border-t pt-4 weekly-breakdown-title">Weekly Breakdown</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            `;

            const sortedWeeks = Object.keys(weeklyTotals).sort((a, b) => parseInt(a.split(' ')[1]) - parseInt(b.split(' ')[1]));

            sortedWeeks.forEach(weekKey => {
                const total = weeklyTotals[weekKey];
                const details = weeklyDetails[weekKey];
                const categories = Object.entries(details).sort(([, a], [__, b]) => b - a);

                html += `
                    <div class="week-card glass-panel rounded-xl p-4 transition">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="text-md font-bold week-title">${weekKey}</h4>
                            <span class="bg-indigo-600 text-white text-xs font-bold px-2 py-1 rounded-md">${formatUSD(total)}</span>
                        </div>
                        <ul class="space-y-1">
                `;
                categories.forEach(([category, amount]) => {
                    const percentage = (total > 0) ? (amount / total * 100).toFixed(1) : 0;
                    html += `
                        <li class="flex justify-between text-sm category-item border-b pb-1 last:border-0">
                            <span>${category}</span>
                            <span class="category-amount">${formatUSD(amount)} <span class="text-xs percentage">(${percentage}%)</span></span>
                        </li>
                    `;
                });
                html += `
                        </ul>
                    </div>
                `;
            });

            html += `</div>`;
            container.innerHTML = html;

            renderMonthCharts({
                monthCategoryBreakdown,
                monthDailyTrend
            });
        }

        function renderMonthCharts(summary) {
            const catData = Object.entries(summary.monthCategoryBreakdown)
                .filter(([_, v]) => v > 0)
                .sort(([_, a], [__, b]) => b - a);

            const pieCtx = document.getElementById('monthCategoryPieChart').getContext('2d');
            if (monthPieChart) monthPieChart.destroy();
            const monthPieColors = getChartColors();
            monthPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: catData.map(d => d[0]),
                    datasets: [{
                        data: catData.map(d => d[1]),
                        backgroundColor: catData.map((_, i) => `hsl(${i * 360 / Math.max(1, catData.length)}, 70%, 60%)`),
                        hoverOffset: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: monthPieColors.text,
                                font: { weight: '500' }
                            }
                        }
                    }
                }
            });

            const dailyLabels = Object.keys(summary.monthDailyTrend).sort();
            const dailyValues = dailyLabels.map(k => summary.monthDailyTrend[k]);

            const lineCtx = document.getElementById('monthDailyLineChart').getContext('2d');
            if (monthLineChart) monthLineChart.destroy();
            const monthLineColors = getChartColors();
            monthLineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Daily (USD)',
                        data: dailyValues,
                        borderColor: '#f97316',
                        backgroundColor: 'rgba(249, 115, 22, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: monthLineColors.grid
                            },
                            ticks: {
                                color: monthLineColors.textSecondary
                            }
                        },
                        x: {
                            ticks: {
                                color: monthLineColors.textSecondary,
                                maxTicksLimit: 10
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }


        function calculateSummary(expensesData, incomesData) {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const startOfToday = new Date(today);
            startOfToday.setHours(0, 0, 0, 0);

            const startOfWeek = new Date(startOfToday);
            startOfWeek.setDate(startOfToday.getDate() - (startOfToday.getDay() === 0 ? 6 : startOfToday.getDay() - 1));
            const startOfLastWeek = new Date(startOfWeek);
            startOfLastWeek.setDate(startOfLastWeek.getDate() - 7);

            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfLastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const endOfLastMonth = new Date(now.getFullYear(), now.getMonth(), 0);

            const totals = {
                todayExpense: 0,
                weekExpense: 0,
                monthExpense: 0,
                lastWeekExpense: 0,
                lastMonthExpense: 0,
                todayIncome: 0,
                weekIncome: 0,
                monthIncome: 0,
                lastWeekIncome: 0,
                lastMonthIncome: 0,
                categoryBreakdown: {},
                incomeBreakdown: {},
                dailyTrend: {},
                monthlyOverview: {}
            };

            for (let i = 0; i < 30; i++) {
                const d = new Date(startOfToday);
                d.setDate(startOfToday.getDate() - i);
                totals.dailyTrend[d.toISOString().split('T')[0]] = 0;
            }
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                totals.monthlyOverview[d.toISOString().substring(0, 7)] = 0;
            }

            expensesData.forEach(expense => {
                const usd = convertToUSD(expense.amount, expense.currency);
                const expDate = new Date(expense.date);
                const expDateOnly = expense.date;

                if (expDateOnly === today) totals.todayExpense += usd;
                if (expDate >= startOfWeek) totals.weekExpense += usd;
                if (expDate >= startOfMonth) totals.monthExpense += usd;
                if (expDate >= startOfLastWeek && expDate < startOfWeek) totals.lastWeekExpense += usd;
                if (expDate >= startOfLastMonth && expDate <= endOfLastMonth) totals.lastMonthExpense += usd;

                totals.categoryBreakdown[expense.category] = (totals.categoryBreakdown[expense.category] || 0) + usd;

                if (totals.dailyTrend[expDateOnly] !== undefined) totals.dailyTrend[expDateOnly] -= usd;

                const monthKey = expDateOnly.substring(0, 7);
                if (totals.monthlyOverview[monthKey] !== undefined) totals.monthlyOverview[monthKey] += usd;
            });

            incomesData.forEach(income => {
                const usd = convertToUSD(income.amount, income.currency);
                const incDate = new Date(income.date);
                const incDateOnly = income.date;

                if (incDateOnly === today) totals.todayIncome += usd;
                if (incDate >= startOfWeek) totals.weekIncome += usd;
                if (incDate >= startOfMonth) totals.monthIncome += usd;
                if (incDate >= startOfLastWeek && incDate < startOfWeek) totals.lastWeekIncome += usd;
                if (incDate >= startOfLastMonth && incDate <= endOfLastMonth) totals.lastMonthIncome += usd;

                totals.incomeBreakdown[income.source] = (totals.incomeBreakdown[income.source] || 0) + usd;

                if (totals.dailyTrend[incDateOnly] !== undefined) totals.dailyTrend[incDateOnly] += usd;

                const monthKey = incDateOnly.substring(0, 7);
                if (totals.monthlyOverview[monthKey] !== undefined) totals.monthlyOverview[monthKey] += usd;
            });

            const weeklyExpenseChange = totals.lastWeekExpense > 0 ? (totals.weekExpense - totals.lastWeekExpense) / totals.lastWeekExpense : (totals.weekExpense > 0 ? 1 : 0);
            const monthlyExpenseChange = totals.lastMonthExpense > 0 ? (totals.monthExpense - totals.lastMonthExpense) / totals.lastMonthExpense : (totals.monthExpense > 0 ? 1 : 0);
            const weeklyIncomeChange = totals.lastWeekIncome > 0 ? (totals.weekIncome - totals.lastWeekIncome) / totals.lastWeekIncome : (totals.weekIncome > 0 ? 1 : 0);
            const monthlyIncomeChange = totals.lastMonthIncome > 0 ? (totals.monthIncome - totals.lastMonthIncome) / totals.lastMonthIncome : (totals.monthIncome > 0 ? 1 : 0);

            return {...totals,
                weeklyExpenseChange,
                monthlyExpenseChange,
                weeklyIncomeChange,
                monthlyIncomeChange
            };
        }

        function renderSummaryKPIs(summary) {
            document.getElementById('today-total').textContent = formatUSD(summary.todayExpense);
            document.getElementById('week-total').textContent = formatUSD(summary.weekExpense);
            document.getElementById('month-total').textContent = formatUSD(summary.monthExpense);

            const totalIncome = incomes.reduce((sum, i) => sum + convertToUSD(i.amount, i.currency), 0);
            const currentMonth = new Date().toISOString().slice(0, 7);
            const currentMonthIncomes = incomes.filter(i => i.date.startsWith(currentMonth));
            const currentMonthTotalIncome = currentMonthIncomes.reduce((sum, i) => sum + convertToUSD(i.amount, i.currency), 0);
            document.getElementById('total-income').textContent = formatUSD(currentMonthTotalIncome);
            document.getElementById('net-balance').textContent = formatUSD(summary.monthIncome - summary.monthExpense);

            // Update Quick Stats Cards on Entry Tab
            const quickTodayEl = document.getElementById('quick-today-total');
            const quickMonthExpenseEl = document.getElementById('quick-month-expense');
            const quickMonthIncomeEl = document.getElementById('quick-month-income');
            const quickNetBalanceEl = document.getElementById('quick-net-balance');

            if (quickTodayEl) quickTodayEl.textContent = formatUSD(summary.todayExpense);
            if (quickMonthExpenseEl) quickMonthExpenseEl.textContent = formatUSD(summary.monthExpense);
            if (quickMonthIncomeEl) quickMonthIncomeEl.textContent = formatUSD(currentMonthTotalIncome);
            if (quickNetBalanceEl) {
                const netBalance = currentMonthTotalIncome - summary.monthExpense;
                quickNetBalanceEl.textContent = formatUSD(netBalance);
                // Add color based on positive/negative balance
                if (netBalance >= 0) {
                    quickNetBalanceEl.classList.remove('text-red-600');
                    quickNetBalanceEl.classList.add('text-green-600');
                } else {
                    quickNetBalanceEl.classList.remove('text-green-600');
                    quickNetBalanceEl.classList.add('text-red-600');
                }
            }

            const renderComp = (id, change) => {
                const el = document.getElementById(id);
                const pct = Math.abs(change * 100).toFixed(1);
                const color = change > 0 ? 'text-red-600' : change < 0 ? 'text-green-600' : 'text-gray-500';
                const icon = change > 0 ? '▲' : change < 0 ? '▼' : '-';
                el.innerHTML = change === 0 ? `<span class="text-gray-500">No change</span>` : `<span class="font-bold ${color}">${icon} ${pct}%</span>`;
            };
            renderComp('weekly-comp', summary.weeklyExpenseChange);
            renderComp('monthly-comp', summary.monthlyExpenseChange);
        }

        function renderCharts(summary) {
            const catData = Object.entries(summary.categoryBreakdown)
                .filter(([_, v]) => v > 0)
                .sort(([_, a], [__, b]) => b - a);

            const pieCtx = document.getElementById('categoryPieChart').getContext('2d');
            if (pieChart) pieChart.destroy();
            const chartColors = getChartColors();
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: catData.map(d => d[0]),
                    datasets: [{
                        data: catData.map(d => d[1]),
                        backgroundColor: catData.map((_, i) => `hsl(${i * 360 / Math.max(1, catData.length)}, 70%, 60%)`),
                        hoverOffset: 8,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: chartColors.text,
                                font: { weight: '500' }
                            }
                        }
                    }
                }
            });

            // Generate monthly keys from all available transaction data (last 6 months)
            const allMonths = new Set();
            [...expenses, ...incomes].forEach(item => {
                if (item.date) {
                    allMonths.add(item.date.substring(0, 7)); // YYYY-MM format
                }
            });

            // Get current month and previous 5 months
            const currentDate = new Date(); // Use actual current date
            const monthlyKeys = [];
            for (let i = 5; i >= 0; i--) {
                const monthIndex = currentDate.getMonth() - i;
                const d = new Date(currentDate.getFullYear(), monthIndex, 1);
                const monthKey = d.toISOString().substring(0, 7);
                monthlyKeys.push(monthKey);
            }

            const monthlyLabels = monthlyKeys.map(k => {
                const [year, month] = k.split('-');
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            console.log('Monthly Keys:', monthlyKeys);
            console.log('Monthly Labels:', monthlyLabels);
            const monthlyIncomeValues = monthlyKeys.map(k => {
                // Calculate income for the month
                const monthIncomes = incomes.filter(i => i.date.startsWith(k));
                return monthIncomes.reduce((sum, i) => sum + convertToUSD(i.amount, i.currency), 0);
            });
            const monthlyExpenseValues = monthlyKeys.map(k => {
                // Calculate expense for the month
                const monthExpenses = expenses.filter(e => e.date.startsWith(k));
                return monthExpenses.reduce((sum, e) => sum + convertToUSD(e.amount, e.currency), 0);
            });

            const barCtx = document.getElementById('monthlyBarChart').getContext('2d');
            // Clear the canvas completely
            barCtx.clearRect(0, 0, barCtx.canvas.width, barCtx.canvas.height);
            if (barChart) {
                barChart.destroy();
                barChart = null;
            }
            try {
                // Properly destroy existing chart
                if (barChart && typeof barChart.destroy === 'function') {
                    barChart.destroy();
                    barChart = null;
                }

                const barChartColors = getChartColors();
                barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: monthlyLabels,
                        datasets: [{
                            label: 'Expense (USD)',
                            data: monthlyExpenseValues,
                            backgroundColor: 'rgba(239, 68, 68, 0.7)',
                            borderRadius: 8
                        }, {
                            label: 'Income (USD)',
                            data: monthlyIncomeValues,
                            backgroundColor: 'rgba(34, 197, 94, 0.7)',
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: barChartColors.text
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: barChartColors.grid
                                },
                                ticks: {
                                    color: barChartColors.textSecondary
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    color: barChartColors.textSecondary,
                                    maxRotation: 45,
                                    minRotation: 0,
                                    autoSkip: false,
                                    maxTicksLimit: 12
                                }
                            }
                        }
                    }
                });
                console.log('Bar chart created successfully with', monthlyLabels.length, 'labels');

                // Force a redraw
                if (barChart && typeof barChart.update === 'function') {
                    barChart.update();
                }

            } catch (error) {
                console.error('Error creating bar chart:', error);
            }

            const dailyLabels = Object.keys(summary.dailyTrend).sort().reverse();
            const dailyValues = dailyLabels.map(k => summary.dailyTrend[k]);

            const lineCtx = document.getElementById('dailyLineChart').getContext('2d');
            if (lineChart) lineChart.destroy();
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: dailyLabels,
                    datasets: [{
                        label: 'Net Balance (USD)',
                        data: dailyValues,
                        borderColor: '#0ea5e9',
                        backgroundColor: 'rgba(14, 165, 233, 0.2)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: getChartColors().grid
                            },
                            ticks: {
                                color: getChartColors().textSecondary
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: getChartColors().textSecondary,
                                maxTicksLimit: 12
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateUI() {
            // Update dashboard FIRST (fastest, most visible)
            if (typeof updateDashboardOverview === 'function') {
                updateDashboardOverview();
            }
            
            // Always update Entry Tab Quick Stats (visible on default tab)
            if (typeof updateEntryTabStats === 'function') {
                updateEntryTabStats();
            }
            
            // Render expense cards immediately 
            renderExpenseTable(expenses);
            
            // Render other tabs in background (non-blocking)
            requestAnimationFrame(() => {
                if (!document.getElementById('income-tab').classList.contains('hidden')) {
                    renderIncomeTable(incomes);
                }
                if (!document.getElementById('history-tab').classList.contains('hidden')) {
                    renderHistoryTable();
                }
                // Only update report if user is logged in and on the report tab
                if (currentUser && !document.getElementById('report-tab').classList.contains('hidden')) {
                    const summary = calculateSummary(expenses, incomes);
                    renderSummaryKPIs(summary);
                    renderCharts(summary);
                    const months = getUniqueMonths([...expenses, ...incomes]);
                    populateMonthSelect(months);
                }
            });
        }

        // ---------------------------
        // Authentication Methods (UPDATED with Email/Password)
        // ---------------------------

        function signInWithEmailPassword(email, password) {
            if (!auth) {
                showMessage('Authentication service not ready.', 'error');
                return Promise.reject(new Error('Auth not ready'));
            }
            // Optional whitelist pre-check: avoids unnecessary sign-in attempts for disallowed emails.
            if (USE_EMAIL_WHITELIST && ALLOWED_EMAILS.length > 0 && !ALLOWED_EMAILS.includes(email)) {
                showMessage('This email is not authorized to sign in.', 'error');
                return Promise.reject(new Error('Email not allowed'));
            }
            // Sign-in
            return auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    // Signed in 
                    showMessage(`Welcome back, ${userCredential.user.email}!`, 'success');
                    return userCredential;
                })
                .catch((error) => {
                    // Log full error and code for debugging
                    console.error("Email/Password Sign-in Error:", error.code, error);

                    let errorMessage = error.message || 'Sign-in failed. Please try again.';

                    if (error.code === 'auth/user-not-found') {
                        errorMessage = "User not found. Please check email or use Google Sign-in to register.";
                    } else if (error.code === 'auth/wrong-password') {
                        errorMessage = "Invalid password. Please try again or reset your password.";
                    } else if (error.code === 'auth/invalid-email') {
                        errorMessage = "Invalid email format.";
                    } else if (error.code === 'auth/invalid-credential') {
                        // This usually comes from OAuth credential flows; provide helpful guidance
                        errorMessage = "Invalid credential provided. If you registered with Google sign-in, use the 'Sign In with Google' button or try password reset.";
                    } else {
                        // Keep Firebase's message for unfamiliar errors
                        errorMessage = error.message || errorMessage;
                    }

                    showMessage(`Sign-in failed: ${errorMessage}`, 'error');
                    throw error;
                });
        }

        function signInWithGoogle() {
            if (!auth) {
                showMessage('Authentication service not ready.', 'error');
                return;
            }
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .catch(error => {
                    console.error("Google Sign-in Error:", error);
                    showMessage(`Sign-in failed: ${error.message}`, 'error');
                });
        }

        function signOutUser() {
            if (!auth) return;
            auth.signOut()
                .then(() => {
                    localStorage.removeItem('userLoggedIn');
                    localStorage.removeItem('userEmail');
                    showMessage("You have been signed out successfully.", 'info');
                    // Redirect to login page
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 500);
                })
                .catch(error => {
                    showMessage(`Sign-out failed: ${error.message}`, 'error');
                });
        }

        // ---------------------------
        // Auth Helpers: Register, Reset, Error Mapping
        // ---------------------------
        function handleAuthError(code) {
            switch (code) {
                case 'auth/user-not-found':
                    return 'Account not found. Please register.';
                case 'auth/wrong-password':
                    return 'Incorrect password.';
                case 'auth/invalid-credential':
                    return "This account uses Google Sign-In. Reset password or use Google.";
                case 'auth/email-already-in-use':
                    return 'Email already registered. Please sign in.';
                case 'auth/invalid-email':
                    return 'Invalid email format.';
                default:
                    return 'Authentication failed. Please try again.';
            }
        }

        function createUserWithEmailAndPassword(email, password) {
            if (!auth) {
                showMessage('Authentication service not ready.', 'error');
                return Promise.reject(new Error('Auth not ready'));
            }
            return auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    showMessage(`Account created for ${userCredential.user.email}. Welcome!`, 'success');
                    return userCredential;
                })
                .catch(error => {
                    console.error('Registration error', error.code, error);
                    showMessage(handleAuthError(error.code), 'error');
                    throw error;
                });
        }

        function sendPasswordReset(email) {
            if (!auth) {
                showMessage('Authentication service not ready.', 'error');
                return Promise.reject(new Error('Auth not ready'));
            }
            if (!email) {
                showMessage('Please enter the email address to send reset link.', 'error');
                return Promise.reject(new Error('No email'));
            }
            return auth.sendPasswordResetEmail(email)
                .then(() => {
                    showMessage('Password reset email sent. Check your inbox (and spam).', 'success');
                })
                .catch(error => {
                    console.error('Password reset error', error.code, error);
                    showMessage('Password reset failed: ' + handleAuthError(error.code), 'error');
                    throw error;
                });
        }

        function updateAuthModeUI() {
            const loginBtn = document.getElementById('login-btn');
            const heading = document.querySelector('#auth-screen h2');
            const p = document.querySelector('#auth-screen p');
            const forgot = document.getElementById('forgot-password-btn');
            const toggleLink = document.getElementById('auth-toggle-link');

            if (authMode === 'login') {
                loginBtn.textContent = 'Sign In';
                heading.textContent = 'Welcome Back';
                p.textContent = 'Access your shared group expenses securely.';
                if (forgot) forgot.classList.remove('hidden');
                if (toggleLink) toggleLink.textContent = 'Create one';
            } else {
                loginBtn.textContent = 'Register';
                heading.textContent = 'Create Account';
                p.textContent = 'Register an account to join the shared expenses.';
                if (forgot) forgot.classList.add('hidden');
                if (toggleLink) toggleLink.textContent = 'Already have an account? Sign in';
            }
        }

        function toggleAuthMode(e) {
            if (e) e.preventDefault();
            authMode = authMode === 'login' ? 'register' : 'login';
            updateAuthModeUI();
        }

        // ---------------------------
        // Tabs & Setup 
        // ---------------------------
        function switchTab(tab) {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            const navItems = document.querySelectorAll('.nav-item');

            // Reset desktop tab buttons
            tabButtons.forEach(b => {
                b.classList.remove('bg-indigo-600', 'text-white', 'shadow-md', 'active');
                b.classList.add('text-gray-600', 'hover:bg-white/40');
            });

            // Active desktop tab button
            const activeTabButton = document.querySelector(`.tab-button[data-tab="${tab}"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('bg-indigo-600', 'text-white', 'shadow-md', 'active');
                activeTabButton.classList.remove('text-gray-600', 'hover:bg-white/40');
            }

            // Reset mobile nav items
            navItems.forEach(n => n.classList.remove('active'));

            // Active mobile nav item
            const activeNavItem = document.querySelector(`.nav-item[data-tab="${tab}"]`);
            if (activeNavItem) {
                activeNavItem.classList.add('active');
            }

            // Update mobile page title
            const titles = {
                'dashboard': '<i class="fas fa-home mr-2"></i> Overview',
                'entry': '<i class="fas fa-wallet mr-2"></i> New Entry',
                'income': '<i class="fas fa-dollar-sign mr-2"></i> Add Income',
                'history': '<i class="fas fa-history mr-2"></i> History',
                'report': '<i class="fas fa-chart-bar mr-2"></i> Report',
                'settings': '<i class="fas fa-cog mr-2"></i> Settings'
            };
            const mobileTitle = document.getElementById('mobile-page-title');
            if (mobileTitle) {
                mobileTitle.innerHTML = titles[tab] || 'Theansou Expenses';
            }

            // Show/hide tab content
            tabContents.forEach(c => c.classList.toggle('hidden', c.id !== `${tab}-tab`));

            // Specific tab actions
            if (tab === 'dashboard') {
                setTimeout(() => {
                    if (typeof updateDashboardOverview === 'function') {
                        updateDashboardOverview();
                    }
                }, 100);
            } else if (tab === 'report') {
                setTimeout(() => {
                    const canvas = document.getElementById('monthlyBarChart');
                    if (canvas) {
                        updateUI();
                    }
                }, 200);
            } else if (tab === 'income') {
                updateUI();
            } else if (tab === 'history') {
                renderHistoryTable();
            } else if (tab === 'settings') {
                initializeSettingsTab();
            } else if (tab === 'entry') {
                // Update Quick Stats Cards when entering the Entry tab
                updateEntryTabStats();
            }
        }

        // ---------------------------
        // Update Entry Tab Quick Stats
        // ---------------------------
        function updateEntryTabStats() {
            if (typeof calculateSummary === 'function' && typeof expenses !== 'undefined' && typeof incomes !== 'undefined') {
                const summary = calculateSummary(expenses, incomes);
                
                const quickTodayEl = document.getElementById('quick-today-total');
                const quickMonthExpenseEl = document.getElementById('quick-month-expense');
                const quickMonthIncomeEl = document.getElementById('quick-month-income');
                const quickNetBalanceEl = document.getElementById('quick-net-balance');

                if (quickTodayEl) quickTodayEl.textContent = formatUSD(summary.todayExpense);
                if (quickMonthExpenseEl) quickMonthExpenseEl.textContent = formatUSD(summary.monthExpense);
                
                // Calculate current month income
                const currentMonth = new Date().toISOString().slice(0, 7);
                const currentMonthIncomes = incomes.filter(i => i.date && i.date.startsWith(currentMonth));
                const currentMonthTotalIncome = currentMonthIncomes.reduce((sum, i) => sum + convertToUSD(i.amount, i.currency), 0);
                
                if (quickMonthIncomeEl) quickMonthIncomeEl.textContent = formatUSD(currentMonthTotalIncome);
                if (quickNetBalanceEl) {
                    const netBalance = currentMonthTotalIncome - summary.monthExpense;
                    quickNetBalanceEl.textContent = formatUSD(netBalance);
                    // Add color based on positive/negative balance
                    if (netBalance >= 0) {
                        quickNetBalanceEl.classList.remove('text-red-600');
                        quickNetBalanceEl.classList.add('text-green-600');
                    } else {
                        quickNetBalanceEl.classList.remove('text-green-600');
                        quickNetBalanceEl.classList.add('text-red-600');
                    }
                }
            }
        }

        // ---------------------------
        // Settings Tab Functions
        // ---------------------------
        function initializeSettingsTab() {
                        // --- User Profile Info ---
                        if (window.currentUser) {
                            // Show profile photo if available
                            const photoDiv = document.getElementById('user-profile-photo');
                            if (photoDiv) {
                                if (window.currentUser.photoURL) {
                                    photoDiv.innerHTML = `<img src="${window.currentUser.photoURL}" alt="Profile" class="w-14 h-14 rounded-full object-cover">`;
                                } else {
                                    photoDiv.innerHTML = `<i class='fas fa-user text-indigo-400 text-3xl'></i>`;
                                }
                            }
                            // Show display name and email
                            const nameDiv = document.getElementById('user-profile-name');
                            if (nameDiv) nameDiv.textContent = window.currentUser.displayName || window.currentUser.email?.split('@')[0] || 'No Name';
                            const emailDiv = document.getElementById('user-profile-email');
                            if (emailDiv) emailDiv.textContent = window.currentUser.email || '-';
                        }

                        // --- User Statistics (This Month) ---
                        // 1. Collect all users from expenses/incomes (this month only)
                        const now = new Date();
                        const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                        const usersSet = new Set();
                        const userStats = {};
                        // Expenses
                        expenses.filter(e => e.date && e.date.startsWith(monthKey)).forEach(e => {
                            const user = e.user || 'Self';
                            usersSet.add(user);
                            if (!userStats[user]) userStats[user] = {expense: 0, income: 0};
                            userStats[user].expense += convertToUSD(e.amount, e.currency);
                        });
                        // Incomes
                        incomes.filter(i => i.date && i.date.startsWith(monthKey)).forEach(i => {
                            const user = i.user || 'Self';
                            usersSet.add(user);
                            if (!userStats[user]) userStats[user] = {expense: 0, income: 0};
                            userStats[user].income += convertToUSD(i.amount, i.currency);
                        });
                        // 2. Update total users
                        const totalUsers = usersSet.size;
                        const totalUsersSpan = document.getElementById('user-stats-total-users');
                        if (totalUsersSpan) totalUsersSpan.textContent = totalUsers;
                        // 3. Fill table
                        const tableBody = document.getElementById('user-stats-table-body');
                        if (tableBody) {
                            tableBody.innerHTML = '';
                            Array.from(usersSet).sort().forEach(user => {
                                const stat = userStats[user];
                                const net = stat.income - stat.expense;
                                tableBody.innerHTML += `
                                    <tr>
                                        <td class="pr-4 py-1 font-bold text-indigo-900">${user}</td>
                                        <td class="pr-4 py-1 text-red-600">${formatUSD(stat.expense)}</td>
                                        <td class="pr-4 py-1 text-green-600">${formatUSD(stat.income)}</td>
                                        <td class="pr-4 py-1 text-blue-600">${formatUSD(net)}</td>
                                    </tr>
                                `;
                            });
                        }
            const rateInput = document.getElementById('exchange-rate-input');
            const currentDisplay = document.getElementById('current-rate-display');
            if (rateInput) {
                rateInput.value = getExchangeRate();
            }
            if (currentDisplay) {
                currentDisplay.textContent = getExchangeRate().toLocaleString() + '៛';
            }

            // --- Initialize Admin Panel ---
            initializeAdminPanel();
        }

        // ============================================
        // 🔐 ADMIN PANEL FUNCTIONS
        // ============================================
        let adminViewMode = 'my'; // 'my' or 'all'
        let allUsersExpenses = [];
        let allUsersIncomes = [];
        let adminSelectedUserId = ''; // Currently selected user ID for admin view
        let adminUsersList = []; // List of all users for dropdown

        function initializeAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            if (!adminPanel) return;

            // Always hide admin selectors first, then show only if admin
            hideAdminUserSelectors();

            // Check if current user is admin
            if (typeof isCurrentUserAdmin === 'function' && isCurrentUserAdmin()) {
                adminPanel.classList.remove('hidden');
                setupAdminPanelListeners();
                
                // Setup User Management event listeners (search/filter)
                setupUserManagementListeners();
                
                // Show admin user selectors on other tabs
                showAdminUserSelectors();
                
                // Load users list for dropdowns
                loadAdminUsersList();
                
                console.log('✅ Admin Panel initialized successfully');
            } else {
                adminPanel.classList.add('hidden');
                // Already hidden above, but ensure they stay hidden
                hideAdminUserSelectors();
                console.log('👤 Regular user - Admin features hidden');
            }
        }

        // Show admin user selector dropdowns on tabs
        function showAdminUserSelectors() {
            const selectors = [
                'admin-user-selector-expense',
                'admin-user-selector-income', 
                'admin-user-selector-report',
                'admin-user-selector-history'
            ];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('hidden');
            });
        }

        // Hide admin user selector dropdowns
        function hideAdminUserSelectors() {
            const selectors = [
                'admin-user-selector-expense',
                'admin-user-selector-income',
                'admin-user-selector-report',
                'admin-user-selector-history'
            ];
            selectors.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
        }

        // Load list of all users for admin dropdowns
        async function loadAdminUsersList() {
            if (!db || !isCurrentUserAdmin()) return;

            try {
                const expensesSnapshot = await db.collection('expenses').get();
                const incomesSnapshot = await db.collection('incomes').get();
                
                const usersMap = {};
                
                // Get unique users from expenses
                expensesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const groupId = data.groupId;
                    if (groupId && !usersMap[groupId]) {
                        usersMap[groupId] = {
                            id: groupId,
                            name: data.user || 'Unknown',
                            email: data.userEmail || '' // Store email if available
                        };
                    }
                    // Update name if found
                    if (data.user && data.user !== 'Self' && usersMap[groupId]) {
                        usersMap[groupId].name = data.user;
                    }
                    // Store email if available
                    if (data.userEmail && usersMap[groupId]) {
                        usersMap[groupId].email = data.userEmail;
                    }
                });

                // Get unique users from incomes
                incomesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const groupId = data.groupId;
                    if (groupId && !usersMap[groupId]) {
                        usersMap[groupId] = {
                            id: groupId,
                            name: data.user || 'Unknown',
                            email: data.userEmail || ''
                        };
                    }
                    if (data.user && data.user !== 'Self' && usersMap[groupId]) {
                        usersMap[groupId].name = data.user;
                    }
                });

                adminUsersList = Object.values(usersMap);
                
                // Populate all admin dropdowns
                populateAdminDropdowns();
                
            } catch (err) {
                console.error('Error loading admin users list:', err);
            }
        }

        // Populate admin user selector dropdowns
        function populateAdminDropdowns() {
            const dropdownIds = [
                'admin-view-user-expense',
                'admin-view-user-income',
                'admin-view-user-report',
                'admin-view-user-history'
            ];

            dropdownIds.forEach(dropdownId => {
                const dropdown = document.getElementById(dropdownId);
                if (!dropdown) return;

                // Clear and add default option
                dropdown.innerHTML = '<option value="">My Data</option>';
                
                // Add all users
                adminUsersList.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    
                    // Extract username from email (before @) or use name
                    let displayName = user.name;
                    if (user.email && user.email.includes('@')) {
                        displayName = user.email.split('@')[0];
                    } else if (user.id && user.id.includes('@')) {
                        displayName = user.id.split('@')[0];
                    } else if (displayName === 'Unknown' || displayName === 'Self') {
                        // Try to get a friendly name from the ID
                        displayName = user.id.substring(0, 10);
                    }
                    
                    option.textContent = displayName;
                    dropdown.appendChild(option);
                });

                // Add change event listener
                dropdown.addEventListener('change', (e) => {
                    adminSelectedUserId = e.target.value;
                    
                    // Sync all dropdowns
                    dropdownIds.forEach(id => {
                        const otherDropdown = document.getElementById(id);
                        if (otherDropdown && otherDropdown !== dropdown) {
                            otherDropdown.value = adminSelectedUserId;
                        }
                    });

                    // Reload data based on selected user
                    if (adminSelectedUserId) {
                        // View selected user's data
                        switchToUserData(adminSelectedUserId);
                    } else {
                        // View own data
                        switchToMyData();
                    }
                });
            });
        }

        // Switch to viewing a specific user's data
        function switchToUserData(userId) {
            if (!db || !isCurrentUserAdmin()) return;
            
            // Unsubscribe from current listeners
            if (firestoreUnsubscribe.expenses) firestoreUnsubscribe.expenses();
            if (firestoreUnsubscribe.incomes) firestoreUnsubscribe.incomes();
            firestoreUnsubscribe = {};
            
            // Start listening to selected user's data
            startFirestoreListener(userId);
            
            showMessage(`📊 Viewing data for user: ${userId.substring(0, 8)}...`, 'info');
        }

        function setupAdminPanelListeners() {
            const viewMyDataBtn = document.getElementById('view-my-data-btn');
            const viewAllDataBtn = document.getElementById('view-all-data-btn');
            const refreshBtn = document.getElementById('refresh-all-users-btn');
            const allUsersSection = document.getElementById('all-users-data-section');

            if (viewMyDataBtn) {
                viewMyDataBtn.addEventListener('click', () => {
                    adminViewMode = 'my';
                    viewMyDataBtn.classList.add('bg-indigo-600', 'text-white');
                    viewMyDataBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    viewAllDataBtn.classList.remove('bg-purple-600', 'text-white');
                    viewAllDataBtn.classList.add('bg-gray-200', 'text-gray-700');
                    if (allUsersSection) allUsersSection.classList.add('hidden');
                    
                    // Switch back to viewing own data
                    switchToMyData();
                });
            }

            if (viewAllDataBtn) {
                viewAllDataBtn.addEventListener('click', () => {
                    adminViewMode = 'all';
                    viewAllDataBtn.classList.add('bg-purple-600', 'text-white');
                    viewAllDataBtn.classList.remove('bg-gray-200', 'text-gray-700');
                    viewMyDataBtn.classList.remove('bg-indigo-600', 'text-white');
                    viewMyDataBtn.classList.add('bg-gray-200', 'text-gray-700');
                    if (allUsersSection) allUsersSection.classList.remove('hidden');
                    
                    // Load all users data
                    loadAllUsersData();
                });
            }

            if (refreshBtn) {
                refreshBtn.addEventListener('click', loadAllUsersData);
            }
        }

        function switchToMyData() {
            // Re-subscribe to only current user's data
            if (currentUser && db) {
                if (firestoreUnsubscribe.expenses) firestoreUnsubscribe.expenses();
                if (firestoreUnsubscribe.incomes) firestoreUnsubscribe.incomes();
                firestoreUnsubscribe = {};
                startFirestoreListener(currentUser.uid);
            }
        }

        async function loadAllUsersData() {
            if (!db || !isCurrentUserAdmin()) return;

            const tableBody = document.getElementById('admin-data-table-body');
            if (!tableBody) return;

            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</td></tr>';

            try {
                // Load ALL expenses (no filter by groupId)
                const expensesSnapshot = await db.collection('expenses').get();
                const incomesSnapshot = await db.collection('incomes').get();

                // Group data by user email with detailed breakdown
                const userDataMap = {};

                expensesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const groupId = data.groupId || 'unknown';
                    const currency = data.currency || 'USD';
                    const amount = parseFloat(data.amount) || 0;
                    
                    if (!userDataMap[groupId]) {
                        userDataMap[groupId] = { 
                            expenseUSD: 0, 
                            expenseKHR: 0, 
                            incomeUSD: 0, 
                            incomeKHR: 0,
                            transactionCount: 0,
                            email: data.user || 'Unknown',
                            userEmail: data.userEmail || groupId,  // Use stored email
                            groupId: groupId
                        };
                    }
                    
                    // Update email if found in data
                    if (data.userEmail && data.userEmail.includes('@')) {
                        userDataMap[groupId].userEmail = data.userEmail;
                    }
                    
                    // Update user name if found
                    if (data.user && data.user !== 'Self') {
                        userDataMap[groupId].email = data.user;
                    }
                    
                    userDataMap[groupId].transactionCount++;
                    if (currency === 'KHR') {
                        userDataMap[groupId].expenseKHR += amount;
                    } else {
                        userDataMap[groupId].expenseUSD += amount;
                    }
                });

                incomesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const groupId = data.groupId || 'unknown';
                    const currency = data.currency || 'USD';
                    const amount = parseFloat(data.amount) || 0;
                    
                    if (!userDataMap[groupId]) {
                        userDataMap[groupId] = { 
                            expenseUSD: 0, 
                            expenseKHR: 0, 
                            incomeUSD: 0, 
                            incomeKHR: 0,
                            transactionCount: 0,
                            email: data.user || 'Unknown',
                            userEmail: data.userEmail || groupId,
                            groupId: groupId
                        };
                    }
                    
                    // Update email if found
                    if (data.userEmail && data.userEmail.includes('@')) {
                        userDataMap[groupId].userEmail = data.userEmail;
                    }
                    
                    // Update user name if found
                    if (data.user && data.user !== 'Self') {
                        userDataMap[groupId].email = data.user;
                    }
                    
                    userDataMap[groupId].transactionCount++;
                    if (currency === 'KHR') {
                        userDataMap[groupId].incomeKHR += amount;
                    } else {
                        userDataMap[groupId].incomeUSD += amount;
                    }
                });

                // Render table
                tableBody.innerHTML = '';
                const userIds = Object.keys(userDataMap);
                
                if (userIds.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No data found</td></tr>';
                    return;
                }

                // Calculate totals
                let totalExpense = 0, totalIncome = 0, totalTransactions = 0;

                userIds.forEach(userId => {
                    const userData = userDataMap[userId];
                    // Combine USD and KHR (convert KHR to USD)
                    const totalExpenseInUSD = userData.expenseUSD + (userData.expenseKHR / getExchangeRate());
                    const totalIncomeInUSD = userData.incomeUSD + (userData.incomeKHR / getExchangeRate());
                    const net = totalIncomeInUSD - totalExpenseInUSD;
                    
                    totalExpense += totalExpenseInUSD;
                    totalIncome += totalIncomeInUSD;
                    totalTransactions += userData.transactionCount;

                    // Get display name from email (before @)
                    let displayName = userData.email || 'Unknown';
                    const userEmail = userData.userEmail || userId;
                    
                    // Extract username from email if available
                    if (userEmail && userEmail.includes('@')) {
                        displayName = userEmail.split('@')[0];
                    }
                    
                    tableBody.innerHTML += `
                        <tr class="border-b border-gray-100 hover:bg-purple-50">
                            <td class="pr-2 py-2 font-medium text-gray-800 text-xs">
                                <div class="font-bold text-indigo-900">${displayName}</div>
                                <div class="text-[10px] text-gray-500">${userEmail.includes('@') ? userEmail : ''}</div>
                            </td>
                            <td class="pr-2 py-2 text-center font-bold text-purple-600">${userData.transactionCount}</td>
                            <td class="pr-2 py-2 text-red-600 font-semibold">$${totalExpenseInUSD.toFixed(2)}</td>
                            <td class="pr-2 py-2 text-green-600 font-semibold">$${totalIncomeInUSD.toFixed(2)}</td>
                            <td class="pr-2 py-2 font-semibold ${net >= 0 ? 'text-blue-600' : 'text-orange-600'}">$${net.toFixed(2)}</td>
                        </tr>
                    `;
                });

                // Add totals row
                const totalNet = totalIncome - totalExpense;
                tableBody.innerHTML += `
                    <tr class="border-t-2 border-purple-300 bg-purple-50 font-bold">
                        <td class="pr-2 py-2 text-purple-900">📊 TOTAL (${userIds.length} users)</td>
                        <td class="pr-2 py-2 text-center text-purple-600">${totalTransactions}</td>
                        <td class="pr-2 py-2 text-red-600">$${totalExpense.toFixed(2)}</td>
                        <td class="pr-2 py-2 text-green-600">$${totalIncome.toFixed(2)}</td>
                        <td class="pr-2 py-2 ${totalNet >= 0 ? 'text-blue-600' : 'text-orange-600'}">$${totalNet.toFixed(2)}</td>
                    </tr>
                `;

                showMessage(`Loaded ${totalTransactions} transactions from ${userIds.length} user(s)`, 'success');

            } catch (err) {
                console.error('Admin load error:', err);
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-500">Error loading data</td></tr>';
                showMessage('Error loading all users data: ' + err.message, 'error');
            }
        }

        function saveExchangeRateSetting() {
            const rateInput = document.getElementById('exchange-rate-input');
            const rate = parseFloat(rateInput.value);
            
            if (isNaN(rate) || rate <= 0) {
                showMessage('Please enter a valid exchange rate.', 'error');
                return;
            }
            
            setExchangeRate(rate);
            showMessage(`Exchange rate updated to ${rate.toLocaleString()}៛ per USD`, 'success');
            
            // Update display
            const currentDisplay = document.getElementById('current-rate-display');
            if (currentDisplay) {
                currentDisplay.textContent = rate.toLocaleString() + '៛';
            }
            
            // Refresh UI to reflect new rates
            updateUI();
        }

        function resetExchangeRateSetting() {
            setExchangeRate(DEFAULT_KHR_RATE);
            const rateInput = document.getElementById('exchange-rate-input');
            const currentDisplay = document.getElementById('current-rate-display');
            
            if (rateInput) {
                rateInput.value = DEFAULT_KHR_RATE;
            }
            if (currentDisplay) {
                currentDisplay.textContent = DEFAULT_KHR_RATE.toLocaleString() + '៛';
            }
            
            showMessage(`Exchange rate reset to default (${DEFAULT_KHR_RATE.toLocaleString()}៛)`, 'info');
            updateUI();
        }

        function setupUIEvents() {
            const tabButtons = document.querySelectorAll('.tab-button');

            tabButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    switchTab(btn.dataset.tab);
                });
            });

            // The entry tab should be selected by default, but only shown after login
            switchTab('entry');
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            document.getElementById('currency').value = 'KHR';
            
            // Load custom users from localStorage first
            loadCustomUsers();
            
            // Initialize user selectors with auto-selected user
            initializeUserSelectors();
            
            // Setup User Management listeners (Admin)
            setupUserManagementListeners();

            // Form Submit Listener (Expense Form)
            document.getElementById('expense-form').addEventListener('submit', (e) => {
                e.preventDefault();
                // Use getElementById for safer access
                const expenseData = {
                    id: document.getElementById('expense-id').value || null,
                    amount: document.getElementById('amount').value,
                    currency: document.getElementById('currency').value,
                    date: document.getElementById('date').value,
                    category: document.getElementById('category').value.trim(),
                    description: document.getElementById('description').value,
                    user: document.getElementById('user').value || 'Self'
                };

                if (!expenseData.category) {
                    showMessage("Category is required.", 'error');
                    return;
                }
                if (!expenseData.amount || parseFloat(expenseData.amount) <= 0) {
                    showMessage("Amount must be greater than zero.", 'error');
                    return;
                }

                saveExpense(expenseData);
            });

            // Income Form Submit Listener (FIXED)
            document.getElementById('income-form').addEventListener('submit', (e) => {
                e.preventDefault();
                // We use document.getElementById because the input has no 'name' attribute
                const incomeData = {
                    id: document.getElementById('income-id').value || null,
                    amount: document.getElementById('income-amount').value,
                    currency: document.getElementById('income-currency').value,
                    date: document.getElementById('income-date').value,
                    source: document.getElementById('income-source').value,
                    description: document.getElementById('income-description').value,
                    user: document.getElementById('income-user').value || 'Self'
                };

                if (!incomeData.source) {
                    showMessage("Source is required.", 'error');
                    return;
                }
                if (!incomeData.amount || parseFloat(incomeData.amount) <= 0) {
                    showMessage("Amount must be greater than zero.", 'error');
                    return;
                }

                saveIncome(incomeData);
            });

            document.getElementById('income-cancel-edit-button').addEventListener('click', resetIncomeForm);

            document.getElementById('cancel-edit-button').addEventListener('click', resetForm);

            // Filters & Sorting Listeners
            ['filter-category', 'filter-user', 'sort-by', 'filter-start-date', 'filter-end-date', 'filter-description', 'filter-month'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    if (id === 'sort-by') currentFilters.sortBy = e.target.value;
                    else if (id === 'filter-category') currentFilters.category = e.target.value;
                    else if (id === 'filter-user') currentFilters.user = e.target.value;
                    else if (id === 'filter-start-date') currentFilters.startDate = e.target.value;
                    else if (id === 'filter-end-date') currentFilters.endDate = e.target.value;
                    else if (id === 'filter-description') currentFilters.description = e.target.value;
                    else if (id === 'filter-month') currentFilters.month = e.target.value;
                    renderExpenseTable(expenses);
                });
            });

            ['filter-income-source', 'filter-income-user', 'sort-income-by', 'filter-income-start-date', 'filter-income-end-date', 'filter-income-description', 'filter-income-month'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    if (id === 'sort-income-by') currentIncomeFilters.sortBy = e.target.value;
                    else if (id === 'filter-income-source') currentIncomeFilters.source = e.target.value;
                    else if (id === 'filter-income-user') currentIncomeFilters.user = e.target.value;
                    else if (id === 'filter-income-start-date') currentIncomeFilters.startDate = e.target.value;
                    else if (id === 'filter-income-end-date') currentIncomeFilters.endDate = e.target.value;
                    else if (id === 'filter-income-description') currentIncomeFilters.description = e.target.value;
                    else if (id === 'filter-income-month') currentIncomeFilters.month = e.target.value;
                    renderIncomeTable(incomes);
                });
            });

            ['history-filter-type', 'history-filter-category', 'history-filter-user', 'history-sort-by', 'history-filter-start-date', 'history-filter-end-date', 'history-filter-description', 'history-filter-month'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    if (id === 'history-sort-by') currentHistoryFilters.sortBy = e.target.value;
                    else if (id === 'history-filter-type') currentHistoryFilters.type = e.target.value;
                    else if (id === 'history-filter-category') currentHistoryFilters.category = e.target.value;
                    else if (id === 'history-filter-user') currentHistoryFilters.user = e.target.value;
                    else if (id === 'history-filter-start-date') currentHistoryFilters.startDate = e.target.value;
                    else if (id === 'history-filter-end-date') currentHistoryFilters.endDate = e.target.value;
                    else if (id === 'history-filter-description') currentHistoryFilters.description = e.target.value;
                    else if (id === 'history-filter-month') currentHistoryFilters.month = e.target.value;
                    renderHistoryTable();
                });
            });

            document.getElementById('clear-filters-btn').addEventListener('click', () => {
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
                document.getElementById('filter-month').value = '';
                document.getElementById('filter-description').value = '';
                currentFilters.startDate = '';
                currentFilters.endDate = '';
                currentFilters.month = '';
                currentFilters.description = '';
                renderExpenseTable(expenses);
            });

            document.getElementById('clear-income-filters-btn').addEventListener('click', () => {
                document.getElementById('filter-income-start-date').value = '';
                document.getElementById('filter-income-end-date').value = '';
                document.getElementById('filter-income-month').value = '';
                document.getElementById('filter-income-description').value = '';
                currentIncomeFilters.startDate = '';
                currentIncomeFilters.endDate = '';
                currentIncomeFilters.month = '';
                currentIncomeFilters.description = '';
                renderIncomeTable(incomes);
            });

            document.getElementById('history-clear-filters-btn').addEventListener('click', () => {
                document.getElementById('history-filter-start-date').value = '';
                document.getElementById('history-filter-end-date').value = '';
                document.getElementById('history-filter-month').value = '';
                document.getElementById('history-filter-description').value = '';
                currentHistoryFilters.startDate = '';
                currentHistoryFilters.endDate = '';
                currentHistoryFilters.month = '';
                currentHistoryFilters.description = '';
                renderHistoryTable();
            });

            // Delete Modal Listeners
            document.getElementById('cancel-delete-btn').addEventListener('click', hideDeleteModal);
            document.getElementById('confirm-delete-btn').addEventListener('click', () => {
                if (deleteId) deleteExpense(deleteId);
                hideDeleteModal();
            });

            document.getElementById('cancel-delete-income-btn').addEventListener('click', hideDeleteIncomeModal);
            document.getElementById('confirm-delete-income-btn').addEventListener('click', () => {
                if (deleteIncomeId) deleteIncome(deleteIncomeId);
                hideDeleteIncomeModal();
            });

            // Export Button Listener
            document.getElementById('export-csv-btn').addEventListener('click', convertToExcelFile);
            document.getElementById('export-income-csv-btn').addEventListener('click', convertToIncomeExcelFile);
            document.getElementById('export-history-csv-btn').addEventListener('click', convertToHistoryExcelFile);
            document.getElementById('export-pdf-btn').addEventListener('click', exportExpensesPDF);
            document.getElementById('export-income-pdf-btn').addEventListener('click', exportIncomesPDF);
            document.getElementById('export-history-pdf-btn').addEventListener('click', exportHistoryPDF);

            // Monthly Breakdown Select Listener
            document.getElementById('report-month-select').addEventListener('change', (e) => {
                renderWeeklyBreakdown(e.target.value);
            });

            // Sign out Button Listener
            document.getElementById('signout-btn').addEventListener('click', signOutUser);

            // Settings Event Listeners
            const saveRateBtn = document.getElementById('save-exchange-rate-btn');
            if (saveRateBtn) {
                saveRateBtn.addEventListener('click', saveExchangeRateSetting);
            }
            const resetRateBtn = document.getElementById('reset-exchange-rate-btn');
            if (resetRateBtn) {
                resetRateBtn.addEventListener('click', resetExchangeRateSetting);
            }
            const settingsSignoutBtn = document.getElementById('settings-signout-btn');
            if (settingsSignoutBtn) {
                settingsSignoutBtn.addEventListener('click', signOutUser);
            }
        }

        // ---------------------------
        // Start App
        // ---------------------------
        
        // ===== iOS-Style Momentum & Elastic Scrolling =====
        class iOSScrollManager {
            constructor(container) {
                this.container = container;
                this.startY = 0;
                this.currentY = 0;
                this.lastY = 0;
                this.velocity = 0;
                this.isScrolling = false;
                this.isTouching = false;
                this.elasticOffset = 0;
                this.maxElasticOffset = 100;
                this.friction = 0.95;
                this.elasticDamping = 0.6;
                this.lastTime = 0;
                this.rafId = null;
                
                this.init();
            }
            
            init() {
                // Add pull indicator
                this.pullIndicator = document.createElement('div');
                this.pullIndicator.className = 'pull-indicator';
                this.pullIndicator.innerHTML = '<i class="fas fa-arrow-down"></i>';
                this.container.style.position = 'relative';
                this.container.insertBefore(this.pullIndicator, this.container.firstChild);
                
                // Touch events
                this.container.addEventListener('touchstart', this.onTouchStart.bind(this), { passive: true });
                this.container.addEventListener('touchmove', this.onTouchMove.bind(this), { passive: false });
                this.container.addEventListener('touchend', this.onTouchEnd.bind(this), { passive: true });
                
                // Scroll event for sticky headers
                this.container.addEventListener('scroll', this.onScroll.bind(this), { passive: true });
                
                // Initialize sticky header observer
                this.setupStickyHeaderObserver();
            }
            
            onTouchStart(e) {
                this.isTouching = true;
                this.startY = e.touches[0].clientY;
                this.lastY = this.startY;
                this.lastTime = Date.now();
                this.velocity = 0;
                
                // Cancel any ongoing momentum
                if (this.rafId) {
                    cancelAnimationFrame(this.rafId);
                    this.rafId = null;
                }
            }
            
            onTouchMove(e) {
                if (!this.isTouching) return;
                
                this.currentY = e.touches[0].clientY;
                const deltaY = this.currentY - this.lastY;
                const now = Date.now();
                const dt = now - this.lastTime;
                
                // Calculate velocity for momentum
                if (dt > 0) {
                    this.velocity = deltaY / dt * 16; // Normalize to ~60fps
                }
                
                this.lastY = this.currentY;
                this.lastTime = now;
                
                // Check if at bounds for elastic effect
                const atTop = this.container.scrollTop <= 0;
                const atBottom = this.container.scrollTop >= this.container.scrollHeight - this.container.clientHeight;
                
                if (atTop && deltaY > 0) {
                    // Pulling down at top - elastic effect
                    e.preventDefault();
                    this.elasticOffset += deltaY * this.elasticDamping;
                    this.elasticOffset = Math.min(this.elasticOffset, this.maxElasticOffset);
                    this.applyElasticTransform();
                    this.container.classList.add('overscroll-top');
                    
                    // Update pull indicator
                    const progress = this.elasticOffset / this.maxElasticOffset;
                    this.pullIndicator.style.transform = `translateX(-50%) translateY(${this.elasticOffset}px)`;
                    this.pullIndicator.classList.toggle('visible', progress > 0.1);
                    this.pullIndicator.classList.toggle('ready', progress > 0.8);
                } else if (atBottom && deltaY < 0) {
                    // Pulling up at bottom - elastic effect
                    e.preventDefault();
                    this.elasticOffset += deltaY * this.elasticDamping;
                    this.elasticOffset = Math.max(this.elasticOffset, -this.maxElasticOffset);
                    this.applyElasticTransform();
                    this.container.classList.add('overscroll-bottom');
                } else {
                    // Normal scrolling - reset elastic offset
                    if (this.elasticOffset !== 0) {
                        this.elasticOffset = 0;
                        this.applyElasticTransform();
                    }
                    this.container.classList.remove('overscroll-top', 'overscroll-bottom');
                    this.pullIndicator.classList.remove('visible', 'ready');
                }
            }
            
            onTouchEnd(e) {
                this.isTouching = false;
                
                // Bounce back from elastic position
                if (this.elasticOffset !== 0) {
                    this.bounceBack();
                } else if (Math.abs(this.velocity) > 0.5) {
                    // Apply momentum scrolling
                    this.applyMomentum();
                }
                
                // Remove overscroll classes
                this.container.classList.remove('overscroll-top', 'overscroll-bottom');
                this.pullIndicator.classList.remove('visible', 'ready');
            }
            
            applyElasticTransform() {
                const content = this.container.querySelector('.elastic-scroll-inner') || this.container;
                if (content !== this.container) {
                    content.style.transform = `translateY(${this.elasticOffset}px)`;
                } else {
                    // Apply to all direct children if no inner wrapper
                    Array.from(this.container.children).forEach(child => {
                        if (!child.classList.contains('pull-indicator')) {
                            child.style.transform = `translateY(${this.elasticOffset}px)`;
                        }
                    });
                }
            }
            
            bounceBack() {
                const content = this.container.querySelector('.elastic-scroll-inner') || this.container;
                const children = content !== this.container ? [content] : 
                    Array.from(this.container.children).filter(c => !c.classList.contains('pull-indicator'));
                
                children.forEach(child => {
                    child.classList.add('bouncing');
                    child.style.transform = 'translateY(0)';
                });
                
                this.elasticOffset = 0;
                
                setTimeout(() => {
                    children.forEach(child => child.classList.remove('bouncing'));
                }, 500);
            }
            
            applyMomentum() {
                const decelerate = () => {
                    if (Math.abs(this.velocity) < 0.1 || this.isTouching) {
                        this.velocity = 0;
                        return;
                    }
                    
                    this.container.scrollTop -= this.velocity;
                    this.velocity *= this.friction;
                    
                    // Check bounds and apply elastic at edges during momentum
                    const atTop = this.container.scrollTop <= 0;
                    const atBottom = this.container.scrollTop >= this.container.scrollHeight - this.container.clientHeight - 1;
                    
                    if ((atTop && this.velocity > 0) || (atBottom && this.velocity < 0)) {
                        // Reduce velocity faster at edges for natural feel
                        this.velocity *= 0.7;
                    }
                    
                    this.rafId = requestAnimationFrame(decelerate);
                };
                
                this.rafId = requestAnimationFrame(decelerate);
            }
            
            onScroll() {
                // Update sticky headers
                this.updateStickyHeaders();
            }
            
            setupStickyHeaderObserver() {
                // Observe sticky headers to add 'is-stuck' class
                const headers = this.container.querySelectorAll('.date-group-header, .sticky-section-header');
                
                if ('IntersectionObserver' in window && headers.length > 0) {
                    const observer = new IntersectionObserver(
                        (entries) => {
                            entries.forEach(entry => {
                                entry.target.classList.toggle('is-stuck', entry.intersectionRatio < 1);
                            });
                        },
                        {
                            root: this.container,
                            threshold: [1],
                            rootMargin: '-1px 0px 0px 0px'
                        }
                    );
                    
                    headers.forEach(header => observer.observe(header));
                }
            }
            
            updateStickyHeaders() {
                const headers = this.container.querySelectorAll('.date-group-header, .sticky-section-header');
                const containerTop = this.container.getBoundingClientRect().top;
                
                headers.forEach(header => {
                    const headerTop = header.getBoundingClientRect().top;
                    header.classList.toggle('is-stuck', headerTop <= containerTop + 2);
                });
            }
        }
        
        // Initialize iOS scroll on all containers with .ios-scroll class
        function initIOSScroll() {
            const scrollContainers = document.querySelectorAll('.ios-scroll');
            scrollContainers.forEach(container => {
                if (!container._iosScrollManager) {
                    container._iosScrollManager = new iOSScrollManager(container);
                }
            });
        }
        
        // Helper function to group items by date and add sticky headers
        function groupItemsByDate(container, items, type = 'expense') {
            if (!items || items.length === 0) return;
            
            const grouped = {};
            items.forEach(item => {
                const date = item.date || 'Unknown';
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(item);
            });
            
            // Sort dates descending
            const sortedDates = Object.keys(grouped).sort((a, b) => new Date(b) - new Date(a));
            
            // Create HTML with sticky headers
            let html = '';
            sortedDates.forEach(date => {
                const formattedDate = formatDateHeader(date);
                const headerClass = type === 'income' ? 'date-group-header income-header' : 'date-group-header';
                html += `<div class="${headerClass}">${formattedDate}</div>`;
                
                grouped[date].forEach(item => {
                    html += item.html;
                });
            });
            
            return html;
        }
        
        function formatDateHeader(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);
            
            if (date.toDateString() === today.toDateString()) {
                return 'Today';
            } else if (date.toDateString() === yesterday.toDateString()) {
                return 'Yesterday';
            } else {
                return date.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    month: 'short', 
                    day: 'numeric' 
                });
            }
        }
        
        window.onload = () => {
            setupUIEvents();
            initializeApp();
            // Always refresh data listeners on first load
            setTimeout(() => {
                refreshDataListeners && refreshDataListeners();
                initIOSScroll();
            }, 500);
        };

        // Global function assignments
        window.showDeleteModal = showDeleteModal;
        window.editExpense = editExpense;
        window.initIOSScroll = initIOSScroll;
        
        // Admin Panel global functions
        window.switchAdminTab = switchAdminTab;
        window.loadAllUsers = loadAllUsers;
        window.openAddUserModal = openAddUserModal;
        window.closeAddUserModal = closeAddUserModal;
        window.addNewUser = addNewUser;
        window.openEditUserModal = openEditUserModal;
        window.closeEditUserModal = closeEditUserModal;
        window.saveUserChanges = saveUserChanges;
        window.toggleUserStatus = toggleUserStatus;
        window.confirmDeleteUser = confirmDeleteUser;
        window.closeDeleteUserModal = closeDeleteUserModal;
        window.deleteUserConfirmed = deleteUserConfirmed;
        window.syncUsersFromData = syncUsersFromData;
        window.filterUsersTable = filterUsersTable;
        window.loadAllUsersData = loadAllUsersData;

        // ============================================
        // CHART.JS DARK MODE CONFIGURATION
        // ============================================
        
        function getChartColors() {
            const isDark = document.body.classList.contains('dark-mode');
            return {
                text: isDark ? '#f1f5f9' : '#1f2937',
                textSecondary: isDark ? '#94a3b8' : '#6b7280',
                grid: isDark ? 'rgba(148, 163, 184, 0.1)' : 'rgba(0,0,0,0.05)',
                border: isDark ? '#475569' : '#e5e7eb'
            };
        }
        
        function updateChartDefaults() {
            const colors = getChartColors();
            if (typeof Chart !== 'undefined') {
                Chart.defaults.color = colors.text;
                Chart.defaults.borderColor = colors.border;
                Chart.defaults.plugins.legend.labels.color = colors.text;
                Chart.defaults.plugins.title.color = colors.text;
                Chart.defaults.scale.grid.color = colors.grid;
                Chart.defaults.scale.ticks.color = colors.textSecondary;
            }
        }

        // ============================================
        // DARK MODE FUNCTIONALITY
        // ============================================
        
        function initDarkMode() {
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            
            // Apply saved dark mode preference
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                darkModeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            }
            
            // Update chart defaults on init
            updateChartDefaults();
            
            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const isDark = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', isDark);
                darkModeToggle.innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
                
                // Update chart colors when dark mode toggles
                updateChartDefaults();
                
                // Re-render charts if on report tab
                if (document.getElementById('report-tab') && !document.getElementById('report-tab').classList.contains('hidden')) {
                    renderCharts();
                }
                // Re-render monthly breakdown charts
                const monthSelect = document.getElementById('report-month-select');
                if (monthSelect && monthSelect.value) {
                    renderMonthlyBreakdown(monthSelect.value);
                }
            });
        }
        
        // Initialize dark mode on DOM ready
        document.addEventListener('DOMContentLoaded', initDarkMode);
        
        // Hide admin selectors immediately on page load (before auth check)
        document.addEventListener('DOMContentLoaded', function() {
            // Ensure admin selectors are hidden by default
            const adminSelectors = document.querySelectorAll('.admin-view-selector');
            adminSelectors.forEach(el => el.classList.add('hidden'));
        });

        // ============================================
        // FLOATING ACTION BUTTON (FAB) FUNCTIONALITY
        // ============================================
        
        function initFAB() {
            const fabContainer = document.getElementById('fab-container');
            const fabMain = document.getElementById('fab-main');
            const fabExpense = document.getElementById('fab-expense');
            const fabIncome = document.getElementById('fab-income');
            
            if (!fabMain) return;
            
            fabMain.addEventListener('click', () => {
                fabContainer.classList.toggle('open');
                fabMain.classList.toggle('active');
            });
            
            fabExpense.addEventListener('click', () => {
                fabContainer.classList.remove('open');
                fabMain.classList.remove('active');
                switchTab('entry');
                // Focus on amount input
                setTimeout(() => {
                    const amountInput = document.getElementById('amount');
                    if (amountInput) amountInput.focus();
                }, 300);
            });
            
            fabIncome.addEventListener('click', () => {
                fabContainer.classList.remove('open');
                fabMain.classList.remove('active');
                switchTab('income');
                // Focus on income amount input
                setTimeout(() => {
                    const incomeAmountInput = document.getElementById('income-amount');
                    if (incomeAmountInput) incomeAmountInput.focus();
                }, 300);
            });
            
            // Close FAB when clicking outside
            document.addEventListener('click', (e) => {
                if (!fabContainer.contains(e.target)) {
                    fabContainer.classList.remove('open');
                    fabMain.classList.remove('active');
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', initFAB);

        // ============================================
        // GLOBAL SEARCH FUNCTIONALITY
        // ============================================
        
        function initGlobalSearch() {
            const searchInput = document.getElementById('global-search');
            const searchClear = document.getElementById('search-clear');
            const searchResults = document.getElementById('search-results');
            const searchResultsList = document.getElementById('search-results-list');
            
            if (!searchInput) return;
            
            let searchTimeout;
            
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Show/hide clear button
                if (query.length > 0) {
                    searchClear.classList.add('visible');
                } else {
                    searchClear.classList.remove('visible');
                    searchResults.classList.remove('visible');
                    return;
                }
                
                // Debounce search
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    performSearch(query);
                }, 300);
            });
            
            searchInput.addEventListener('focus', () => {
                if (searchInput.value.trim().length > 0) {
                    searchResults.classList.add('visible');
                }
            });
            
            searchClear.addEventListener('click', () => {
                searchInput.value = '';
                searchClear.classList.remove('visible');
                searchResults.classList.remove('visible');
                searchInput.focus();
            });
            
            // Close search results when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
                    searchResults.classList.remove('visible');
                }
            });
        }
        
        function performSearch(query) {
            const searchResults = document.getElementById('search-results');
            const searchResultsList = document.getElementById('search-results-list');
            
            query = query.toLowerCase();
            const results = [];
            
            // Search in expenses
            if (typeof expenses !== 'undefined' && expenses && expenses.length > 0) {
                expenses.forEach(expense => {
                    const matchCategory = expense.category && expense.category.toLowerCase().includes(query);
                    const matchDescription = expense.description && expense.description.toLowerCase().includes(query);
                    const matchAmount = expense.amount && expense.amount.toString().includes(query);
                    
                    if (matchCategory || matchDescription || matchAmount) {
                        results.push({
                            type: 'expense',
                            data: expense,
                            relevance: matchCategory ? 3 : (matchDescription ? 2 : 1)
                        });
                    }
                });
            }
            
            // Search in incomes
            if (typeof incomes !== 'undefined' && incomes && incomes.length > 0) {
                incomes.forEach(income => {
                    const matchSource = income.source && income.source.toLowerCase().includes(query);
                    const matchDescription = income.description && income.description.toLowerCase().includes(query);
                    const matchAmount = income.amount && income.amount.toString().includes(query);
                    
                    if (matchSource || matchDescription || matchAmount) {
                        results.push({
                            type: 'income',
                            data: income,
                            relevance: matchSource ? 3 : (matchDescription ? 2 : 1)
                        });
                    }
                });
            }
            
            // Sort by relevance and limit results
            results.sort((a, b) => b.relevance - a.relevance);
            const limitedResults = results.slice(0, 10);
            
            // Render results
            if (limitedResults.length === 0) {
                searchResultsList.innerHTML = `
                    <div class="search-no-results">
                        <i class="fas fa-search"></i>
                        <p>No results found for "${query}"</p>
                    </div>
                `;
            } else {
                searchResultsList.innerHTML = limitedResults.map(result => {
                    const item = result.data;
                    const isExpense = result.type === 'expense';
                    const title = isExpense ? (item.category || 'No Category') : (item.source || 'No Source');
                    const meta = `${item.date || 'No Date'} • ${item.description || 'No description'}`;
                    const amount = formatCurrency(item.amount || 0, item.currency || 'USD');
                    
                    return `
                        <div class="search-result-item" onclick="goToTransaction('${result.type}', '${item.id}')">
                            <div class="result-icon ${isExpense ? 'expense' : 'income'}">
                                <i class="fas fa-${isExpense ? 'arrow-down' : 'arrow-up'}"></i>
                            </div>
                            <div class="result-info">
                                <div class="result-title">${title}</div>
                                <div class="result-meta">${meta}</div>
                            </div>
                            <div class="result-amount ${isExpense ? 'expense' : 'income'}">
                                ${isExpense ? '-' : '+'}${amount}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            searchResults.classList.add('visible');
        }
        
        function goToTransaction(type, id) {
            const searchInput = document.getElementById('global-search');
            const searchResults = document.getElementById('search-results');
            
            // Clear search
            searchInput.value = '';
            searchResults.classList.remove('visible');
            document.getElementById('search-clear').classList.remove('visible');
            
            // Navigate to history tab
            switchTab('history');
            
            // Highlight the transaction (optional - can be enhanced)
            setTimeout(() => {
                const element = document.querySelector(`[data-id="${id}"]`);
                if (element) {
                    element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    element.style.animation = 'pulse 0.5s ease-in-out 3';
                }
            }, 500);
        }
        
        // Make goToTransaction global
        window.goToTransaction = goToTransaction;
        
        document.addEventListener('DOMContentLoaded', initGlobalSearch);

        // ============================================
        // DASHBOARD OVERVIEW TAB FUNCTIONALITY
        // ============================================
        
        function updateDashboardOverview() {
            // Update greeting based on time
            const hour = new Date().getHours();
            let greeting = 'Good Morning';
            if (hour >= 12 && hour < 17) greeting = 'Good Afternoon';
            else if (hour >= 17) greeting = 'Good Evening';
            
            const greetingEl = document.getElementById('greeting-text');
            if (greetingEl) greetingEl.textContent = greeting;
            
            // Update user name
            const userNameEl = document.getElementById('dashboard-user-name');
            if (userNameEl && typeof currentUser !== 'undefined' && currentUser) {
                userNameEl.textContent = currentUser.email ? currentUser.email.split('@')[0] : 'User';
            }
            
            // Calculate totals
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            let todayExpense = 0;
            let monthExpense = 0;
            let totalExpense = 0;
            let monthIncome = 0;
            let totalIncome = 0;
            
            // Calculate expenses - use local expenses variable (not window.expenses)
            if (typeof expenses !== 'undefined' && expenses && expenses.length > 0) {
                expenses.forEach(exp => {
                    const amount = convertToUSD(exp.amount || 0, exp.currency || 'USD');
                    totalExpense += amount;
                    
                    if (exp.date === today) {
                        todayExpense += amount;
                    }
                    
                    const expDate = new Date(exp.date);
                    if (expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear) {
                        monthExpense += amount;
                    }
                });
            }
            
            // Calculate incomes - use local incomes variable (not window.incomes)
            if (typeof incomes !== 'undefined' && incomes && incomes.length > 0) {
                incomes.forEach(inc => {
                    const amount = convertToUSD(inc.amount || 0, inc.currency || 'USD');
                    totalIncome += amount;
                    
                    const incDate = new Date(inc.date);
                    if (incDate.getMonth() === currentMonth && incDate.getFullYear() === currentYear) {
                        monthIncome += amount;
                    }
                });
            }
            
            const balance = totalIncome - totalExpense;
            const monthNet = monthIncome - monthExpense;
            
            // Update dashboard stats
            updateElementSafe('dashboard-balance', formatCurrency(balance, 'USD'), balance >= 0 ? 'text-green-500' : 'text-red-500');
            updateElementSafe('dashboard-total-income', '+' + formatCurrency(totalIncome, 'USD'));
            updateElementSafe('dashboard-total-expense', '-' + formatCurrency(totalExpense, 'USD'));
            updateElementSafe('dash-today-total', formatCurrency(todayExpense, 'USD'));
            updateElementSafe('dash-month-expense', formatCurrency(monthExpense, 'USD'));
            updateElementSafe('dash-month-income', formatCurrency(monthIncome, 'USD'));
            updateElementSafe('dash-net-balance', formatCurrency(monthNet, 'USD'), monthNet >= 0 ? 'text-green-500' : 'text-red-500');
            
            // Update summary text
            const summaryEl = document.getElementById('dashboard-summary');
            if (summaryEl) {
                if (balance >= 0) {
                    summaryEl.textContent = `Great job! You have a positive balance of ${formatCurrency(balance, 'USD')}. Keep tracking your finances!`;
                } else {
                    summaryEl.textContent = `Heads up! Your expenses exceed income by ${formatCurrency(Math.abs(balance), 'USD')}. Consider reviewing your spending.`;
                }
            }
            
            // Render recent transactions
            renderDashboardRecentExpenses();
            renderDashboardRecentIncomes();
        }
        
        function updateElementSafe(id, value, colorClass) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                if (colorClass) {
                    el.className = el.className.replace(/text-(green|red|gray)-\d+/g, '');
                    el.classList.add(colorClass);
                }
            }
        }
        
        function renderDashboardRecentExpenses() {
            const container = document.getElementById('dashboard-recent-expenses');
            if (!container) return;
            
            if (typeof expenses === 'undefined' || !expenses || expenses.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">No recent expenses</div>';
                return;
            }
            
            const recent = [...expenses].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            container.innerHTML = recent.map(exp => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-red-50 flex items-center justify-center">
                            <i class="fas fa-arrow-down text-red-500"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800 text-sm">${exp.category || 'No Category'}</div>
                            <div class="text-xs text-gray-400">${exp.date || 'No Date'}</div>
                        </div>
                    </div>
                    <div class="font-bold text-red-500">-${formatCurrency(exp.amount, exp.currency)}</div>
                </div>
            `).join('');
        }
        
        function renderDashboardRecentIncomes() {
            const container = document.getElementById('dashboard-recent-incomes');
            if (!container) return;
            
            if (typeof incomes === 'undefined' || !incomes || incomes.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 py-4">No recent income</div>';
                return;
            }
            
            const recent = [...incomes].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            container.innerHTML = recent.map(inc => `
                <div class="flex items-center justify-between p-3 rounded-xl bg-gray-50 hover:bg-gray-100 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-green-50 flex items-center justify-center">
                            <i class="fas fa-arrow-up text-green-500"></i>
                        </div>
                        <div>
                            <div class="font-semibold text-gray-800 text-sm">${inc.source || 'No Source'}</div>
                            <div class="text-xs text-gray-400">${inc.date || 'No Date'}</div>
                        </div>
                    </div>
                    <div class="font-bold text-green-500">+${formatCurrency(inc.amount, inc.currency)}</div>
                </div>
            `).join('');
        }
        
        // Update dashboard when tab is switched to it
        const originalSwitchTab = window.switchTab;
        window.switchTab = function(tab) {
            if (typeof originalSwitchTab === 'function') {
                originalSwitchTab(tab);
            }
            if (tab === 'dashboard') {
                updateDashboardOverview();
            }
        };
        
        // Also update when data changes
        window.updateDashboardOverview = updateDashboardOverview;
    </script>

    <!-- Mobile Bottom Navigation -->
    <nav id="bottom-nav" class="bottom-nav md:hidden hidden">
        <div class="flex justify-around items-center max-w-lg mx-auto px-2">
            <div class="nav-item" data-tab="dashboard" onclick="switchTab('dashboard')">
                <div class="nav-icon"><i class="fas fa-home"></i></div>
                <div class="nav-label">Home</div>
            </div>
            <div class="nav-item active" data-tab="entry" onclick="switchTab('entry')">
                <div class="nav-icon"><i class="fas fa-plus-circle"></i></div>
                <div class="nav-label">Expense</div>
            </div>
            <div class="nav-item" data-tab="income" onclick="switchTab('income')">
                <div class="nav-icon"><i class="fas fa-hand-holding-dollar"></i></div>
                <div class="nav-label">Income</div>
            </div>
            <div class="nav-item" data-tab="history" onclick="switchTab('history')">
                <div class="nav-icon"><i class="fas fa-clock-rotate-left"></i></div>
                <div class="nav-label">History</div>
            </div>
            <div class="nav-item" data-tab="report" onclick="switchTab('report')">
                <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="nav-label">Analytics</div>
            </div>
            <div class="nav-item" data-tab="settings" onclick="switchTab('settings')">
                <div class="nav-icon"><i class="fas fa-gear"></i></div>
                <div class="nav-label">Settings</div>
            </div>
        </div>
    </nav>

    <!-- Professional Footer -->
    <footer class="hidden md:block bg-gray-900 text-white py-6 mt-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center">
                        <i class="fas fa-wallet text-white"></i>
                    </div>
                    <div>
                        <p class="font-bold text-sm">Finance Dashboard</p>
                        <p class="text-xs text-gray-400">Professional Expense Management</p>
                    </div>
                </div>
                <div class="flex items-center gap-6 text-sm">
                    <span class="text-gray-400">© 2026 V2.0</span>
                    <span class="font-semibold">SUOS THEANSOU</span>
                    <a href="tel:+85570605799" class="text-indigo-400 hover:text-indigo-300 transition-colors flex items-center gap-2">
                        <i class="fas fa-phone-alt"></i> +855 70 605 799
                    </a>
                </div>
            </div>
        </div>
    </footer>
</body>

</html>e